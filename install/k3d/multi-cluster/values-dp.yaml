# Helm values for OpenChoreo Data Plane in k3d multi-cluster setup
# This file contains overrides specific to running the data plane in a k3d environment

# Cluster Agent configuration for secure communication with control plane
# IMPORTANT: Before installing, run ./install/extract-agent-cas.sh server-ca
# and paste the server CA certificate below
clusterAgent:
  enabled: true
  serverUrl: "wss://cluster-gateway.openchoreo.localhost:8443/ws"  # Control plane cluster gateway URL
  planeName: "default"
  planeType: "dataplane"

  # DNS rewrite configuration for multi-cluster k3d setup
  # Rewrites *.openchoreo.localhost to host.k3d.internal for cross-cluster communication
  dnsRewrite:
    enabled: true

  # Client certificate auto-generation via cert-manager
  tls:
    enabled: true
    generateCerts: true
    # For multi-cluster, don't set caSecretName - use self-signed certs
    # The cluster gateway will verify the client cert via mTLS
    caSecretName: ""
    caSecretNamespace: ""
    # Server CA certificate for TLS verification
    # Extract from control plane: kubectl --context k3d-openchoreo-cp get secret cluster-gateway-ca -n openchoreo-control-plane -o jsonpath='{.data.ca\.crt}' | base64 -d
    # Or use: ./install/extract-agent-cas.sh server-ca
    serverCAValue: |
      -----BEGIN CERTIFICATE-----
      <PASTE_SERVER_CA_CERTIFICATE_HERE>
      -----END CERTIFICATE-----

  # RBAC for cluster agent
  rbac:
    create: true

fluentBit:
  config:
    # OpenSearch connection for multi-cluster setup
    # Points to OpenSearch in the observability plane via host.k3d.internal
    # Routed though the host machine to reach the Observability Plane
    opensearch:
      host: "host.k3d.internal"
      port: "11082"

gateway:
  # Enable gateway
  enabled: true

  # Use custom ports for k3d multi-cluster setup
  httpPort: 80
  httpsPort: 443

  # Envoy - enabled by default for traffic routing
  envoy:
    enabled: true
    # Mount /tmp as emptyDir volume to fix Envoy temporary file creation issues
    # Enable this if gateway pods crash with "Failed to create temporary file" errors
    # Common on: macOS with Docker Desktop/Colima with Rosetta enabled.
    # Ref: https://github.com/kgateway-dev/kgateway/issues/9800
    mountTmpVolume: true
