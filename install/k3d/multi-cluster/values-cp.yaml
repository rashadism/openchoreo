# Helm values for OpenChoreo Control Plane in k3d multi-cluster setup

openchoreoApi:
  http:
    hostnames:
    - api.openchoreo.localhost
  config:
    server:
      publicUrl: "http://api.openchoreo.localhost:8080"

backstage:
  baseUrl: "http://openchoreo.localhost:8080"
  http:
    hostnames:
    - openchoreo.localhost
  thunder:
    baseUrl: "http://thunder.openchoreo.localhost:8080"

security:
  oidc:
    issuer: "http://thunder.openchoreo.localhost:8080"
    jwksUrl: "http://thunder-service.openchoreo-control-plane.svc.cluster.local:8090/oauth2/jwks"
    authorizationUrl: "http://thunder.openchoreo.localhost:8080/oauth2/authorize"
    tokenUrl: "http://thunder-service.openchoreo-control-plane.svc.cluster.local:8090/oauth2/token"

# Cluster Gateway configuration for agent-based communication
# Exposes the cluster gateway for remote data/build plane agents to connect
# Note: For k3d, we use Kgateway TLSRoute for TLS passthrough on shared port 8443
# Alternative: Add dedicated port mapping in k3d config (requires cluster recreation)
clusterGateway:
  tlsRoute:
    enabled: true
    hosts:
      - host: cluster-gateway.openchoreo.localhost
        paths:
          - path: /
            pathType: Prefix
  tls:
    # mTLS for secure agent communication
    issuerRef:
      name: cluster-gateway-server-issuer  # CA issuer for server certificates
    dnsNames:
      - cluster-gateway.openchoreo-control-plane.svc
      - cluster-gateway.openchoreo-control-plane.svc.cluster.local
      - cluster-gateway.openchoreo.localhost  # External hostname for multi-cluster access

thunder:
  http:
    hostnames:
    - thunder.openchoreo.localhost
  configuration:
    server:
      publicUrl: "http://thunder.openchoreo.localhost:8080"
    gateClient:
      hostname: "thunder.openchoreo.localhost"

gateway:
  tls:
    hostname: "*.openchoreo.localhost"
  # Envoy configuration for traffic routing
  envoy:
    # Mount /tmp as emptyDir volume to fix Envoy temporary file creation issues
    # Enable this if gateway pods crash with "Failed to create temporary file" errors
    # Common on: macOS with Docker Desktop/Colima with Rosetta enabled.
    # Ref: https://github.com/kgateway-dev/kgateway/issues/9800
    mountTmpVolume: true
