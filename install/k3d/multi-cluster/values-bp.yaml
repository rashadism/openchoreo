# Helm values for OpenChoreo Build Plane in k3d multi-cluster setup
# This file contains overrides specific to running the build plane in a k3d environment

# Cluster Agent configuration for secure communication with control plane
# IMPORTANT: Before installing, run ./install/extract-agent-cas.sh server-ca
# and paste the server CA certificate below
clusterAgent:
  enabled: true
  serverUrl: "wss://cluster-gateway.openchoreo.localhost:8443/ws"  # Control plane cluster gateway URL
  planeID: "default-buildplane"
  planeType: "buildplane"

  # DNS rewrite configuration for multi-cluster k3d setup
  # Rewrites *.openchoreo.localhost to host.k3d.internal for cross-cluster communication
  dnsRewrite:
    enabled: true

  tls:
    enabled: true
    generateCerts: true
    # For multi-cluster, don't set caSecretName - use self-signed certs
    # The cluster gateway will verify the client cert via mTLS
    caSecretName: ""
    caSecretNamespace: ""
    # Server CA certificate for TLS verification
    # Extract from control plane: kubectl --context k3d-openchoreo-cp get secret cluster-gateway-ca -n openchoreo-control-plane -o jsonpath='{.data.ca\.crt}' | base64 -d
    # Or use: ./install/extract-agent-cas.sh server-ca
    serverCAValue: |
      -----BEGIN CERTIFICATE-----
      <PASTE_SERVER_CA_CERTIFICATE_HERE>
      -----END CERTIFICATE-----

  # RBAC for cluster agent
  rbac:
    create: true

argo-workflows:
  server:
    # Argo Workflows UI is enabled only for testing/development purposes.
    # Disable this to save resources in development setups.
    enabled: true
    serviceType: LoadBalancer
    servicePort: 2746
    authModes:
      - server

# Container Registry configuration for multi-cluster
# Expose registry as LoadBalancer for cross-cluster access
registry:
  service:
    type: LoadBalancer
    port: 5000

# All planes access via host.k3d.internal:10082
global:
  defaultResources:
    registry:
      # Can be any registry (e.g., docker.io, gcr.io, ghcr.io, quay.io, etc).
      host: "host.k3d.internal:10082"

fluent-bit:
  enabled: true

  config:
    outputs: |
      [OUTPUT]
          Name opensearch
          Host host.k3d.internal
          Generate_ID On
          HTTP_Passwd ThisIsTheOpenSearchPassword1
          HTTP_User admin
          Logstash_Format On
          Logstash_DateFormat %Y-%m-%d
          Logstash_Prefix container-logs
          Match kube.*
          Port 11085
          Suppress_Type_Name On
          tls On
          tls.verify Off
          tls.vhost opensearch.observability.openchoreo.localhost

# External Secrets Operator configuration
external-secrets:
  enabled: true
