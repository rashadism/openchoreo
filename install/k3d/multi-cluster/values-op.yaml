# Helm values for OpenChoreo Observability Plane in k3d multi-cluster setup
# This file contains overrides specific to running the observability plane in a k3d environment


fluent-bit:
  enabled: true

kgateway:
  enabled: true

observer:
  service:
    type: LoadBalancer
  extraEnvs:
  - name: OBSERVER_BASE_URL
    value: "http://localhost:11080"
  - name: AUTH_SERVER_BASE_URL
    value: "http://thunder.openchoreo.localhost:8080"
  - name: OPENSEARCH_ADDRESS
    value: "https://opensearch:9200"
  - name: PROMETHEUS_ADDRESS
    value: "http://openchoreo-observability-prometheus:9091"
  - name: PROMETHEUS_TIMEOUT
    value: "30s"
  - name: AUTHZ_ENABLED
    value: "false"
  - name: AUTHZ_SERVICE_URL
    value: "http://api.openchoreo.localhost:8080"
  - name: AUTHZ_TIMEOUT
    value: "30s"
  ingress:
    hosts:
    - host: host.k3d.internal
    - host: observer.observability.openchoreo.localhost

openSearchDashboards:
  service:
    type: LoadBalancer

openSearch:
  # Expose OpenSearch API via LoadBalancer for Fluent Bit data pushing
  service:
    type: LoadBalancer

opentelemetry-collector:
  service:
    type: LoadBalancer

prometheus:
  prometheus:
    prometheusSpec:
      enableRemoteWriteReceiver: true
    service:
      type: LoadBalancer


## Values for local templates

clusterAgent:
  serverUrl: "wss://cluster-gateway.openchoreo.localhost:8443/ws"  # Control plane cluster gateway URL

  # DNS rewrite configuration for multi-cluster k3d setup
  # Rewrites *.openchoreo.localhost to host.k3d.internal for cross-cluster communication
  dnsRewrite:
    enabled: true

  tls:
    generateCerts: true
    # For multi-cluster, don't set caSecretName - use self-signed certs
    # The cluster gateway will verify the client cert via mTLS
    caSecretName: ""
    caSecretNamespace: ""
    # Server CA certificate for TLS verification
    # Extract from control plane: kubectl --context k3d-openchoreo-cp get secret cluster-gateway-ca -n openchoreo-control-plane -o jsonpath='{.data.ca\.crt}' | base64 -d
    # Or use: ./install/extract-agent-cas.sh server-ca
    serverCAValue: |
      -----BEGIN CERTIFICATE-----
      <PASTE_SERVER_CA_CERTIFICATE_HERE>
      -----END CERTIFICATE-----

gateway:
  enabled: true
  tlsHostname: "opensearch.observability.openchoreo.localhost"

  envoy:
    # Mount /tmp as emptyDir volume to fix Envoy temporary file creation issues
    # Enable this if gateway pods crash with "Failed to create temporary file" errors
    # Common on: macOS with Docker Desktop/Colima with Rosetta enabled.
    # Ref: https://github.com/kgateway-dev/kgateway/issues/9800
    mountTmpVolume: true

security:
  oidc:
    jwksUrl: "https://thunder.openchoreo.localhost:8443/oauth2/jwks"
    tokenUrl: "https://thunder.openchoreo.localhost:8443/oauth2/token"
    jwksUrlTlsInsecureSkipVerify: "true"

tls:
  enabled: true
  dnsNames:
  - "observability.openchoreo.localhost"
  - "*.observability.openchoreo.localhost"

rca:
  controlPlaneUrl: "https://api.openchoreo.localhost:8443"
  ingress:
    hosts:
    - host: host.k3d.internal
    - host: rca-agent.observability.openchoreo.localhost
