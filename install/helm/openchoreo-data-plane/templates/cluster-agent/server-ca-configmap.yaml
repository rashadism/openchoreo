{{- if .Values.clusterAgent.enabled }}
{{- if .Values.clusterAgent.tls.enabled }}
{{- if not .Values.clusterAgent.tls.serverCAValue }}
---
# Job to copy cluster-gateway CA ConfigMap from control plane to data plane
# Only runs in single-cluster setup (when serverCAValue is not provided inline)
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "openchoreo-data-plane.clusterAgent.name" . }}-ca-copier
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-data-plane.labels" . | nindent 4 }}
    app.kubernetes.io/component: cluster-agent
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "5"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/component: cluster-gateway-ca-copier
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ include "openchoreo-data-plane.clusterAgent.serviceAccountName" . }}
      containers:
      - name: ca-copier
        image: bitnamilegacy/kubectl:1.32.4
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "=== Cluster Agent Server CA Copier ==="
          echo "Copying cluster-gateway CA from control plane to data plane..."

          retries=0
          max_retries=120  # 10 minutes

          # Wait for source ConfigMap in control plane
          echo "Waiting for cluster-gateway-ca ConfigMap in control plane..."
          until kubectl get configmap cluster-gateway-ca -n {{ .Values.clusterAgent.serverCANamespace }} &> /dev/null; do
            retries=$((retries+1))
            if [ $retries -gt $max_retries ]; then
              echo "ERROR: Timeout waiting for cluster-gateway-ca in {{ .Values.clusterAgent.serverCANamespace }}"
              kubectl get configmap -n {{ .Values.clusterAgent.serverCANamespace }}
              exit 1
            fi
            echo "ConfigMap not ready yet... (attempt $retries/$max_retries)"
            sleep 5
          done

          echo "✓ Source ConfigMap found in control plane"

          # Wait for valid certificate content
          echo "Waiting for valid CA certificate content..."
          retries=0
          until kubectl get configmap cluster-gateway-ca -n {{ .Values.clusterAgent.serverCANamespace }} -o jsonpath='{.data.ca\.crt}' | grep -q "BEGIN CERTIFICATE"; do
            retries=$((retries+1))
            if [ $retries -gt $max_retries ]; then
              echo "ERROR: Timeout waiting for valid CA certificate content"
              kubectl get configmap cluster-gateway-ca -n {{ .Values.clusterAgent.serverCANamespace }} -o yaml
              exit 1
            fi
            echo "Valid certificate not ready yet... (attempt $retries/$max_retries)"
            sleep 5
          done

          echo "✓ Valid CA certificate found"

          # Copy ConfigMap to data plane namespace
          echo "Copying ConfigMap to data plane namespace..."
          kubectl get configmap cluster-gateway-ca -n {{ .Values.clusterAgent.serverCANamespace }} -o yaml | \
            sed 's/namespace: {{ .Values.clusterAgent.serverCANamespace }}/namespace: {{ .Release.Namespace }}/' | \
            sed '/resourceVersion:/d' | \
            sed '/uid:/d' | \
            sed '/creationTimestamp:/d' | \
            kubectl apply -f -

          echo "✓ ConfigMap copied successfully"

          # Verify
          echo "Verifying ConfigMap in data plane..."
          kubectl get configmap cluster-gateway-ca -n {{ .Release.Namespace }} -o jsonpath='{.data.ca\.crt}' | head -5

          echo ""
          echo "=== CA Copy Completed Successfully ==="
{{- end }}
{{- end }}
{{- end }}
