{{- if and .Values.gateway.enabled .Values.gateway.envoy.mountTmpVolume }}
---
# Job to patch gateway deployment with /tmp volume mount
# This fixes Envoy crash on macOS with Rosetta/Colima. Ref: https://github.com/kgateway-dev/kgateway/issues/9800
apiVersion: batch/v1
kind: Job
metadata:
  name: patch-gateway-deployment
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-data-plane.labels" . | nindent 4 }}
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "10"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/component: gateway-patcher
    spec:
      restartPolicy: OnFailure
      serviceAccountName: gateway-patcher-sa
      containers:
      - name: patch-deployment
        image: {{ .Values.waitJob.image }}
        imagePullPolicy: IfNotPresent
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "=== Patching gateway-default deployment with /tmp volume ==="

          # Wait for deployment to exist
          retries=0
          max_retries=60
          until kubectl get deployment gateway-default -n {{ .Release.Namespace }} &> /dev/null; do
            retries=$((retries+1))
            if [ $retries -gt $max_retries ]; then
              echo "ERROR: Timeout waiting for gateway-default deployment"
              exit 1
            fi
            echo "Waiting for gateway-default deployment... ($retries/$max_retries)"
            sleep 5
          done

          echo "✓ gateway-default deployment found"

          # Check if tmp volume already exists
          if kubectl get deployment gateway-default -n {{ .Release.Namespace }} -o jsonpath='{.spec.template.spec.volumes[?(@.name=="tmp")]}' | grep -q "tmp"; then
            echo "✓ /tmp volume already mounted, skipping patch"
            exit 0
          fi

          echo "Applying patch to add /tmp volume..."

          # Apply the patch
          kubectl patch deployment gateway-default -n {{ .Release.Namespace }} --type='json' -p='[
            {
              "op": "add",
              "path": "/spec/template/spec/volumes/-",
              "value": {"name": "tmp", "emptyDir": {}}
            },
            {
              "op": "add",
              "path": "/spec/template/spec/containers/0/volumeMounts/-",
              "value": {"name": "tmp", "mountPath": "/tmp"}
            }
          ]'

          echo "✓ Patch applied successfully"

          # Wait for new pods to be ready
          echo "Waiting for gateway pod to be ready..."
          kubectl rollout status deployment/gateway-default -n {{ .Release.Namespace }} --timeout=300s

          echo "✓ Gateway deployment is ready"
{{- end }}
