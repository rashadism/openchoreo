{{- if .Values.clusterAgent.dnsRewrite.enabled }}
---
# CoreDNS custom hosts for multi-cluster DNS resolution
# This ConfigMap provides DNS rewrites for both cluster-agent and observer components
# Maps control plane service hostnames to host.k3d.internal for cross-cluster communication
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns-custom
  namespace: kube-system
  labels:
    {{- include "openchoreo-observability-plane.labels" . | nindent 4 }}
    app.kubernetes.io/component: dns-rewrite
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "-10"
data:
{{- if .Values.clusterAgent.enabled }}
  cluster-gateway.override: |
    # Rewrite cluster gateway hostname to use host.k3d.internal
    # This allows cluster agents in multi-cluster k3d setups to reach the control plane
    rewrite stop {
      name exact cluster-gateway.openchoreo.localhost host.k3d.internal
      answer auto
    }
{{- end }}
  control-plane-services.override: |
    # Rewrite control plane service hostnames to use host.k3d.internal
    # This allows observer to reach control plane services (thunder, api, etc.)
    # Matches: thunder.openchoreo.localhost, api.openchoreo.localhost, openchoreo.localhost
    rewrite stop {
      name regex (thunder|api|openchoreo)\.openchoreo\.localhost host.k3d.internal
      answer auto
    }
{{- end }}
