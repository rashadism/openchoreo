{{- if .Values.clusterAgent.enabled }}
{{- if .Values.clusterAgent.dnsRewrite.enabled }}
---
# CoreDNS custom hosts for cluster gateway resolution
# Maps cluster-gateway.openchoreo.localhost to host.k3d.internal for multi-cluster communication
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns-custom
  namespace: kube-system
  labels:
    {{- include "openchoreo-observability-plane.labels" . | nindent 4 }}
    app.kubernetes.io/component: cluster-agent-dns
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "-10"
data:
  cluster-gateway.override: |
    # Rewrite cluster gateway hostname to use host.k3d.internal
    # This allows agents in multi-cluster k3d setups to reach the control plane
    rewrite stop {
      name exact cluster-gateway.openchoreo.localhost host.k3d.internal
      answer auto
    }
{{- end }}
{{- end }}
