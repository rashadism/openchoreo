{{- if .Values.clusterAgent.enabled }}
{{- if .Values.clusterAgent.tls.enabled }}
---
# Job to scale cluster-agent deployment after TLS certificates are ready
# This prevents Helm --wait deadlock where deployment waits for secrets created by post-install hooks
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "openchoreo-observability-plane.clusterAgent.name" . }}-scaler
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-observability-plane.labels" . | nindent 4 }}
    app.kubernetes.io/component: cluster-agent
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "15"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/component: cluster-agent-scaler
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ include "openchoreo-observability-plane.clusterAgent.serviceAccountName" . }}
      containers:
      - name: scaler
        image: bitnamilegacy/kubectl:1.32.4
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "=== Cluster Agent Deployment Scaler ==="
          echo "Waiting for TLS certificates to be ready before scaling deployment..."

          retries=0
          max_retries=120  # 10 minutes

          # Wait for cluster-agent-tls secret
          echo "Waiting for cluster-agent TLS secret..."
          until kubectl get secret {{ .Values.clusterAgent.tls.clientSecretName }} -n {{ .Release.Namespace }} &> /dev/null; do
            retries=$((retries+1))
            if [ $retries -gt $max_retries ]; then
              echo "ERROR: Timeout waiting for secret {{ .Values.clusterAgent.tls.clientSecretName }}"
              kubectl get secrets -n {{ .Release.Namespace }}
              exit 1
            fi
            echo "Secret not ready yet... (attempt $retries/$max_retries)"
            sleep 5
          done

          echo "✓ TLS secret found"

          # Wait for cluster-gateway-ca configmap
          echo "Waiting for cluster-gateway CA configmap..."
          retries=0
          until kubectl get configmap {{ .Values.clusterAgent.tls.serverCAConfigMap }} -n {{ .Release.Namespace }} &> /dev/null; do
            retries=$((retries+1))
            if [ $retries -gt $max_retries ]; then
              echo "ERROR: Timeout waiting for configmap {{ .Values.clusterAgent.tls.serverCAConfigMap }}"
              kubectl get configmaps -n {{ .Release.Namespace }}
              exit 1
            fi
            echo "ConfigMap not ready yet... (attempt $retries/$max_retries)"
            sleep 5
          done

          echo "✓ Server CA configmap found"

          # Verify the secret has valid certificate data
          echo "Verifying TLS secret has valid certificate data..."
          if ! kubectl get secret {{ .Values.clusterAgent.tls.clientSecretName }} \
            -n {{ .Release.Namespace }} \
            -o jsonpath='{.data.tls\.crt}' | base64 -d | grep -q "BEGIN CERTIFICATE"; then
            echo "ERROR: TLS secret exists but does not contain valid certificate"
            kubectl get secret {{ .Values.clusterAgent.tls.clientSecretName }} -n {{ .Release.Namespace }} -o yaml
            exit 1
          fi

          echo "✓ TLS certificate is valid"

          # Scale the deployment to desired replicas
          DESIRED_REPLICAS={{ .Values.clusterAgent.replicas }}
          DEPLOYMENT_NAME={{ include "openchoreo-observability-plane.clusterAgent.name" . }}

          echo "Scaling deployment ${DEPLOYMENT_NAME} to ${DESIRED_REPLICAS} replicas..."

          # Retry scaling in case RBAC permissions aren't immediately available
          retries=0
          max_retries=10
          until kubectl scale deployment ${DEPLOYMENT_NAME} \
            --replicas=${DESIRED_REPLICAS} \
            -n {{ .Release.Namespace }}; do
            retries=$((retries+1))
            if [ $retries -gt $max_retries ]; then
              echo "ERROR: Failed to scale deployment after $max_retries attempts"
              echo "Checking RBAC permissions..."
              kubectl auth can-i patch deployments/scale --as=system:serviceaccount:{{ .Release.Namespace }}:{{ include "openchoreo-observability-plane.clusterAgent.serviceAccountName" . }} -n {{ .Release.Namespace }}
              exit 1
            fi
            echo "Scaling failed, waiting for RBAC to propagate... (attempt $retries/$max_retries)"
            sleep 3
          done

          echo "✓ Deployment scaled successfully"

          # Wait for deployment to be ready
          echo "Waiting for deployment to be ready..."
          kubectl wait deployment ${DEPLOYMENT_NAME} \
            --for=condition=Available \
            --timeout=300s \
            -n {{ .Release.Namespace }} || true

          # Show final status
          echo ""
          echo "=== Cluster Agent Deployment Status ==="
          kubectl get deployment ${DEPLOYMENT_NAME} -n {{ .Release.Namespace }}
          kubectl get pods -n {{ .Release.Namespace }} -l app=cluster-agent

          echo ""
          echo "=== Scaling Complete ==="
{{- end }}
{{- end }}
