{{ if .Values.global.defaultResources.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: docker
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "15"
    "helm.sh/delete-policy": hook-failed
  labels:
    {{- include "openchoreo-build-plane.labels" . | nindent 4 }}
spec:
  entrypoint: build-workflow
  arguments:
    parameters:
      - name: docker-context
      - name: dockerfile-path
  templates:
    - name: build-workflow
      steps:
        - - name: checkout-source
            template: checkout-source
        - - name: build-image
            template: build-image
            arguments:
              parameters:
                - name: git-revision
                  value: '{{ "{{" }}steps.checkout-source.outputs.parameters.git-revision{{ "}}" }}'
        - - name: publish-image
            template: publish-image
            arguments:
              parameters:
                - name: git-revision
                  value: '{{ "{{" }}steps.checkout-source.outputs.parameters.git-revision{{ "}}" }}'
        - - name: generate-workload-cr
            template: generate-workload-cr
            arguments:
              parameters:
                - name: image
                  value: '{{ "{{" }}steps.publish-image.outputs.parameters.image{{ "}}" }}'
    - name: checkout-source
      outputs:
        parameters:
          - name: git-revision
            valueFrom:
              path: /tmp/git-revision.txt
      volumes:
        - name: git-secret
          secret:
            secretName: '{{ "{{" }}workflow.parameters.git-secret{{ "}}" }}'
            optional: true
      container:
        args:
          - |-
            set -e

            #####################################################################
            # 1. Initialize variables
            #####################################################################
            BRANCH={{ "{{" }}workflow.parameters.branch{{ "}}" }}
            REPO_URL={{ "{{" }}workflow.parameters.git-repo{{ "}}" }}
            COMMIT={{ "{{" }}workflow.parameters.commit{{ "}}" }}

            #####################################################################
            # 2. Check for authentication credentials
            #####################################################################
            TOKEN_FILE="/etc/secrets/git-secret/password"
            SSH_KEY_FILE="/etc/secrets/git-secret/ssh-privatekey"
            GIT_TOKEN=""
            SSH_KEY=""

            if [ -f "$TOKEN_FILE" ]; then
              GIT_TOKEN="$(cat "$TOKEN_FILE")"
            fi

            if [ -f "$SSH_KEY_FILE" ]; then
              SSH_KEY="$(cat "$SSH_KEY_FILE")"
            fi

            #####################################################################
            # 3. Configure authentication
            #####################################################################
            CLONE_URL="$REPO_URL"

            # SSH key authentication takes precedence
            if [ -n "$SSH_KEY" ]; then
              echo "Configuring SSH authentication..."

              # Set up SSH directory and key
              mkdir -p ~/.ssh
              chmod 700 ~/.ssh
              echo "$SSH_KEY" > ~/.ssh/id_rsa
              chmod 600 ~/.ssh/id_rsa

              # Add known hosts for common Git providers
              cat > ~/.ssh/known_hosts <<EOF
            github.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCj7ndNxQowgcQnjshcLrqPEiiphnt+VTTvDP6mHBL9j1aNUkY4Ue1gvwnGLVlOhGeYrnZaMgRK6+PKCUXaDbC7qtbW8gIkhL7aGCsOr/C56SJMy/BCZfxd1nWzAOxSDPgVsmerOBYfNqltV9/hWCqBywINIR+5dIg6JTJ72pcEpEjcYgXkE2YEFXV1JHnsKgbLWNlhScqb2UmyRkQyytRLtL+38TGxkxCflmO+5Z8CSSNY7GidjMIZ7Q4zMjA2n1nGrlTDkzwDCsw+wqFPGQA1V2xGt7FQmxQTrNp2+MaRiRO2fPGAU5CWBgAQFAi9XJ8qx9m2UjUyF3KvLmLqjKJbCMx+7hEijOT4D8GGUZ7G3dJe8k3lW1Kp6vN0GXjXqIZEzEkkLLTbP7DzHLTzQlW6Pv5sJDNzNONBqZNbJT2yg1vZ0TJCrAC7+XQfBTQcxJQf3g5lKJXy7UpZqGJ3aWLWq7fNdJ8kQYQXQ4lTQMbKX5BzQH+8C8K8f0UqGxBw6wRkxE=
            github.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEmKSENjQEezOmxkZMy7opKgwFB9nkt5YRrYMjNuG5N87uRgg6CLrbo5wAdT/y6v0mKV0U2w0WZ2YB/++Tpockg=
            github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl
            gitlab.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCsj2bNKTBSpIYDEGk9KxsGh3mySTRgMtXL583qmBpzeQ+jqCMRgBqB98u3z++J1sKlXHWfM9dyhSevkMwSbhoR8XIq/U0tCNyokEi/ueaBMCvbcTHhO7FcwzY92WK4Yt0aGROY5qX2UKSeOvuP4D6TPqKF1onrSzH9bx9XUf2lEdWT/ia1NEKjunUqu1xOB/StKDHMoX4/OKyIzuS0q/T1zOATthvasJFoPrAjkohTyaDUz2LN5JoH839hViyEG82yB+MjcFV5MU3N1l1QL3cVUCh93xSaua1N85qivl+siMkPGbO5xR/En4iEY6K2XPASUEMaieWVNTRCtJ4S8H+9
            gitlab.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFSMqzJeV9rUzU4kWitGjeR4PWSa29SPqJ1fVkhtj3Hw9xjLVXVYrU9QlYWrOLXBpQ6KWjbjTDTdDkoohFzgbEY=
            gitlab.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAfuCHKVTjquxvt6CM6tdG4SLp1Btn/nOeHHE5UOzRdf
            bitbucket.org ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDQeJzhupRu0u0cdegZIa8e86EG2qOCsIsD1Xw0xSeiPDlCr7kq97NLmMbpKTX6Esc30NuoqEEHCuc7yWtwp8dI76EEEB1VqY9QJq6vk+aySyboD5QF61I/1WeTwu+deCbgKMGbUijeXhtfbxSxm6JwGrXqVtt2ErYwXL5Cey7D5NF8qTQCQ6t9xfXjEKPFV5ShyyAA7Cq9rRjAGF+tHCQbkiGTqVHQJYN1eVMfxVfJxnY4qDkJcHSQJZXJrNHZ2F8lY8i5iZzYz6thVH2RYHsF3oZYQG5uh7kPNDhKwq7HxsXLi8rZqCXt7zVqXNa0v+hwTwqj2e4bK5c6gqGQVqQsxXE2kBlvZ7qMpvxjQ8z7lUUuPVqLdI6EwQhyFnq3kF+t7i8WxqHVh2pQpGFVqk5h2FfPp3s2JCxEF6aGmg+2yvQfJQ3CkJa8vR0J7lU5E9OxFh9GmINvYbWE3TGV0SJrBqAj/2aRwDwWCUGJHc9gXzLqfqNYNYMqGMlJUQFJdQ==
            bitbucket.org ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBPIQmuzMBuKdWeF4+a2sjSSpBK0iqitSQ+5BM9KhpexuGt20JpTVM7u5BDZngncgrqDMbWdxMWWOGtZ9UgbqgZE=
            bitbucket.org ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIazEu89wgQZ4bqs3d63QSMzYVa0MuJ2e2gKTKqu+UUO
            EOF
              chmod 600 ~/.ssh/known_hosts

              # Use the SSH URL as-is (it should already be in SSH format)
              CLONE_URL="$REPO_URL"

              echo "SSH authentication configured"

            # Token-based authentication (HTTPS)
            elif [ -n "$GIT_TOKEN" ]; then
              echo "Configuring token-based authentication..."

              case "$REPO_URL" in
                https://*)
                  HOST=$(echo "$REPO_URL" | sed -E 's|https://([^/]+)/.*|\1|')
                  REPO_PATH=$(echo "$REPO_URL" | sed -E 's|https://[^/]+/(.*)|\1|')
                  ;;
                git@*)
                  HOST=$(echo "$REPO_URL" | sed -E 's|git@([^:]+):.*|\1|')
                  REPO_PATH=$(echo "$REPO_URL" | sed -E 's|git@[^:]+:(.*)|\1|')
                  ;;
              esac

              # Map host to authentication prefix
              case "$HOST" in
                github.com)    AUTH_PREFIX="x-access-token" ;;
                gitlab.com)    AUTH_PREFIX="oauth2" ;;
                bitbucket.org) AUTH_PREFIX="x-token-auth" ;;
                *)             AUTH_PREFIX="" ;;
              esac

              if [ -n "$AUTH_PREFIX" ]; then
                CLONE_URL="https://${AUTH_PREFIX}:${GIT_TOKEN}@${HOST}/${REPO_PATH}"
              fi
            fi

            echo "Cloning repository..."

            #####################################################################
            # 4. Clone repository
            #####################################################################
            if [ -n "$COMMIT" ]; then
                echo "Cloning specific commit: $COMMIT"
                git clone --no-checkout --depth 1 "$CLONE_URL" /mnt/vol/source
                cd /mnt/vol/source
                git config --global advice.detachedHead false
                git fetch --depth 1 origin "$COMMIT"
                git checkout "$COMMIT"
                echo -n "$COMMIT" | cut -c1-8 > /tmp/git-revision.txt
            else
                echo "Cloning branch: $BRANCH with latest commit"
                git clone --single-branch --branch $BRANCH --depth 1 "$CLONE_URL" /mnt/vol/source
                cd /mnt/vol/source
                COMMIT_SHA=$(git rev-parse HEAD)
                echo -n "$COMMIT_SHA" | cut -c1-8 > /tmp/git-revision.txt
            fi

            echo "Repository cloned successfully"
        command:
          - sh
          - -c
        image: alpine/git
        name: ""
        volumeMounts:
          - mountPath: /mnt/vol
            name: workspace
          - mountPath: /etc/secrets/git-secret
            name: git-secret
            readOnly: true
    - name: build-image
      inputs:
        parameters:
          - name: git-revision
      container:
        args:
          - |-
            set -e

            WORKDIR=/mnt/vol/source
            IMAGE="{{ "{{" }}workflow.parameters.image-name{{ "}}" }}:{{ "{{" }}workflow.parameters.image-tag{{ "}}" }}-{{ "{{" }}inputs.parameters.git-revision{{ "}}" }}"
            DOCKER_CONTEXT="{{ "{{" }}workflow.parameters.docker-context{{ "}}" }}"
            DOCKERFILE_PATH="{{ "{{" }}workflow.parameters.dockerfile-path{{ "}}" }}"

            #####################################################################
            # 1.  Podman daemon + storage.conf
            #####################################################################
            mkdir -p /etc/containers
            cat > /etc/containers/storage.conf <<EOF
            [storage]
            driver = "overlay"
            runroot = "/run/containers/storage"
            graphroot = "/var/lib/containers/storage"
            [storage.options.overlay]
            mount_program = "/usr/bin/fuse-overlayfs"
            EOF

            #####################################################################
            # 2.  Docker Build
            #####################################################################
            podman build -t $IMAGE -f $WORKDIR/$DOCKERFILE_PATH $WORKDIR/$DOCKER_CONTEXT
            podman save -o /mnt/vol/app-image.tar $IMAGE
        command:
          - sh
          - -c
        image: ghcr.io/openchoreo/podman-runner:v1.0
        securityContext:
          privileged: true
        volumeMounts:
          - mountPath: /mnt/vol
            name: workspace
    - name: publish-image
      inputs:
        parameters:
          - name: git-revision
      outputs:
        parameters:
          - name: image
            valueFrom:
              path: /tmp/image.txt
      volumes:
        - name: registry-push-secret
          secret:
            optional: true
            secretName: '{{ "{{" }}workflow.parameters.registry-push-secret{{ "}}" }}'
      container:
        args:
          - |-
            set -e
            #####################################################################
            # 1. Inputs
            #####################################################################
            GIT_REVISION={{ "{{" }}inputs.parameters.git-revision{{ "}}" }}
            IMAGE_NAME={{ "{{" }}workflow.parameters.image-name{{ "}}" }}
            IMAGE_TAG={{ "{{" }}workflow.parameters.image-tag{{ "}}" }}
            SRC_IMAGE="${IMAGE_NAME}:${IMAGE_TAG}-${GIT_REVISION}"

            #####################################################################
            # 2. Registry
            #####################################################################
            REGISTRY_ENDPOINT="{{ include "openchoreo-build-plane.registryEndpoint" . }}"
            AUTH_FILE="/etc/secrets/registry-push-secret/.dockerconfigjson"

            #####################################################################
            # 3. Podman storage configuration
            #####################################################################
            mkdir -p /etc/containers
            cat <<EOF > /etc/containers/storage.conf
            [storage]
            driver = "overlay"
            runroot = "/run/containers/storage"
            graphroot = "/var/lib/containers/storage"
            [storage.options.overlay]
            mount_program = "/usr/bin/fuse-overlayfs"
            EOF

            #####################################################################
            # 4. Load the tarred image and push to registry
            #####################################################################
            podman load -i /mnt/vol/app-image.tar

            podman tag $SRC_IMAGE $REGISTRY_ENDPOINT/$SRC_IMAGE

            if [ -f "$AUTH_FILE" ]; then
              podman push --tls-verify={{ .Values.global.defaultResources.registry.tlsVerify }} --authfile "$AUTH_FILE" $REGISTRY_ENDPOINT/$SRC_IMAGE
            else
              podman push --tls-verify={{ .Values.global.defaultResources.registry.tlsVerify }} $REGISTRY_ENDPOINT/$SRC_IMAGE
            fi

            #####################################################################
            # 5. Emit image reference (for later steps/kubelet pulls)
            #####################################################################
            echo -n "$REGISTRY_ENDPOINT/$SRC_IMAGE" > /tmp/image.txt
        command:
          - sh
          - -c
        image: ghcr.io/openchoreo/podman-runner:v1.0
        securityContext:
          privileged: true
        volumeMounts:
          - mountPath: /mnt/vol
            name: workspace
          - mountPath: /etc/secrets/registry-push-secret
            name: registry-push-secret
            readOnly: true
    - name: generate-workload-cr
      inputs:
        parameters:
          - name: image
      outputs:
        parameters:
          - name: workload-cr
            valueFrom:
              path: /mnt/vol/workload-cr.yaml
      container:
        image: ghcr.io/openchoreo/podman-runner:v1.0
        command: [ sh, -c ]
        args:
          - |-
            set -e

            #####################################################################
            # 1. Initialize variables
            #####################################################################
            IMAGE={{ "{{" }}inputs.parameters.image{{ "}}" }}
            PROJECT_NAME={{ "{{" }}workflow.parameters.project-name{{ "}}" }}
            COMPONENT_NAME={{ "{{" }}workflow.parameters.component-name{{ "}}" }}
            APP_PATH="{{ "{{" }}workflow.parameters.app-path{{ "}}" }}"

            DESCRIPTOR_PATH="/mnt/vol/source${APP_PATH:+/${APP_PATH#/}}"

            OUTPUT_PATH="/mnt/vol/workload-cr.yaml"

            echo "Creating workload with image: ${IMAGE}"
            echo "Using descriptor in: ${DESCRIPTOR_PATH}"

            #####################################################################
            # 2. Podman storage configuration
            #####################################################################
            mkdir -p /etc/containers
            cat <<EOF > /etc/containers/storage.conf
            [storage]
            driver = "overlay"
            runroot = "/run/containers/storage"
            graphroot = "/var/lib/containers/storage"
            [storage.options.overlay]
            mount_program = "/usr/bin/fuse-overlayfs"
            EOF

            #####################################################################
            # 3. Create workload CR and export to output
            #####################################################################
            # Check if workload.yaml exists and build the command accordingly
            if [ -f "${DESCRIPTOR_PATH}/workload.yaml" ]; then
              echo "Found workload.yaml descriptor, using it for workload creation"
              podman run --rm --network=none \
              -v $DESCRIPTOR_PATH:/app:rw -w /app \
              ghcr.io/openchoreo/openchoreo-cli:{{ .Chart.AppVersion }} \
                workload create \
                --project "${PROJECT_NAME}" \
                --component "${COMPONENT_NAME}" \
                --image "${IMAGE}" \
                --descriptor "workload.yaml" \
                -o "workload-cr.yaml"
            else
              echo "No workload.yaml descriptor found, creating workload without descriptor"
              podman run --rm --network=none \
              -v $DESCRIPTOR_PATH:/app:rw -w /app \
              ghcr.io/openchoreo/openchoreo-cli:{{ .Chart.AppVersion }} \
                workload create \
                --project "${PROJECT_NAME}" \
                --component "${COMPONENT_NAME}" \
                --image "${IMAGE}" \
                -o "workload-cr.yaml"
            fi

            # Copy output CR to the shared volume
            cp -f "${DESCRIPTOR_PATH}/workload-cr.yaml" "${OUTPUT_PATH}"
        volumeMounts:
          - name: workspace
            mountPath: /mnt/vol
        securityContext:
          privileged: true
  ttlStrategy:
    secondsAfterCompletion: 3600
  volumeClaimTemplates:
    - metadata:
        name: workspace
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 2Gi
{{ end }}
