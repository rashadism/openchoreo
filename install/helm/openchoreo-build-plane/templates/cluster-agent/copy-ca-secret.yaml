{{- if .Values.clusterAgent.enabled }}
{{- if .Values.clusterAgent.tls.enabled }}
{{- if not .Values.clusterAgent.tls.serverCAValue }}
---
# Job to sync cluster-gateway CA materials from control plane to build plane namespace
# - Copies CA secret when configured (for signing client certs)
# - Copies CA ConfigMap for server verification when serverCAValue is not provided
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "openchoreo-build-plane.clusterAgent.name" . }}-copy-ca
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-build-plane.labels" . | nindent 4 }}
    app.kubernetes.io/component: cluster-agent
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded,hook-failed
spec:
  {{- if .Values.clusterAgent.copyCAJob.ttlSecondsAfterFinished }}
  ttlSecondsAfterFinished: {{ .Values.clusterAgent.copyCAJob.ttlSecondsAfterFinished }}
  {{- end }}
  template:
    metadata:
      labels:
        app.kubernetes.io/component: cluster-gateway-ca-copier
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ include "openchoreo-build-plane.clusterAgent.serviceAccountName" . }}
      containers:
      - name: ca-copier
        image: bitnamilegacy/kubectl:1.32.4
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "=== Cluster Gateway CA Sync ==="

          {{- if and .Values.clusterAgent.tls.caSecretName (not .Values.clusterAgent.tls.generateCerts) }}
          echo "Copying {{ .Values.clusterAgent.tls.caSecretName }} from {{ .Values.clusterAgent.tls.caSecretNamespace }} to {{ .Release.Namespace }}..."

          retries=0
          max_retries=12  # 1 minute

          # Wait for source secret to exist
          until kubectl get secret {{ .Values.clusterAgent.tls.caSecretName }} \
            -n {{ .Values.clusterAgent.tls.caSecretNamespace }} &> /dev/null; do
            retries=$((retries+1))
            if [ $retries -gt $max_retries ]; then
              echo "ERROR: Timeout waiting for secret {{ .Values.clusterAgent.tls.caSecretName }} in namespace {{ .Values.clusterAgent.tls.caSecretNamespace }}"
              echo "Available secrets in {{ .Values.clusterAgent.tls.caSecretNamespace }}:"
              kubectl get secrets -n {{ .Values.clusterAgent.tls.caSecretNamespace }}
              exit 1
            fi
            echo "Waiting for CA secret... ($retries/$max_retries)"
            sleep 5
          done

          echo "✓ CA secret found in control plane"

          # Wait for CA data to be populated
          retries=0
          until kubectl get secret {{ .Values.clusterAgent.tls.caSecretName }} \
            -n {{ .Values.clusterAgent.tls.caSecretNamespace }} \
            -o jsonpath='{.data.ca\.crt}' | grep -q .; do
            retries=$((retries+1))
            if [ $retries -gt $max_retries ]; then
              echo "ERROR: CA secret exists but ca.crt is empty"
              kubectl get secret {{ .Values.clusterAgent.tls.caSecretName }} \
                -n {{ .Values.clusterAgent.tls.caSecretNamespace }} -o yaml
              exit 1
            fi
            echo "Waiting for CA certificate data... ($retries/$max_retries)"
            sleep 5
          done

          echo "✓ CA certificate data found"

          # Get the secret data and change namespace
          kubectl get secret {{ .Values.clusterAgent.tls.caSecretName }} \
            -n {{ .Values.clusterAgent.tls.caSecretNamespace }} \
            -o yaml | \
            sed '/namespace:/d' | \
            sed '/resourceVersion:/d' | \
            sed '/uid:/d' | \
            sed '/creationTimestamp:/d' | \
            kubectl apply -f - -n {{ .Release.Namespace }}

          # Remove ownership annotations to avoid conflicts
          kubectl annotate secret {{ .Values.clusterAgent.tls.caSecretName }} \
            -n {{ .Release.Namespace }} \
            cert-manager.io/certificate-name- \
            cert-manager.io/issuer-name- \
            cert-manager.io/issuer-kind- \
            --overwrite || true

          # Label the secret
          kubectl label secret {{ .Values.clusterAgent.tls.caSecretName }} \
            -n {{ .Release.Namespace }} \
            app.kubernetes.io/component=cluster-agent \
            app.kubernetes.io/managed-by=Helm \
            openchoreo.dev/copied-from={{ .Values.clusterAgent.tls.caSecretNamespace }} \
            --overwrite

          echo "✓ CA secret copied successfully"
          {{- else }}
          echo "Skipping CA secret copy (generateCerts enabled or caSecretName not set)"
          {{- end }}

          # Copy server CA ConfigMap for gateway verification
          echo "Copying server CA ConfigMap from control plane..."

          retries=0
          max_retries=24  # 2 minutes

          # Wait for source ConfigMap in control plane
          echo "Waiting for cluster-gateway-ca ConfigMap in control plane..."
          until kubectl get configmap cluster-gateway-ca -n {{ .Values.clusterAgent.serverCANamespace }} &> /dev/null; do
            retries=$((retries+1))
            if [ $retries -gt $max_retries ]; then
              echo "ERROR: Timeout waiting for cluster-gateway-ca in {{ .Values.clusterAgent.serverCANamespace }}"
              kubectl get configmap -n {{ .Values.clusterAgent.serverCANamespace }}
              exit 1
            fi
            echo "ConfigMap not ready yet... (attempt $retries/$max_retries)"
            sleep 5
          done

          echo "✓ Source ConfigMap found in control plane"

          # Wait for valid certificate content
          echo "Waiting for valid CA certificate content..."
          retries=0
          until kubectl get configmap cluster-gateway-ca -n {{ .Values.clusterAgent.serverCANamespace }} -o jsonpath='{.data.ca\.crt}' | grep -q "BEGIN CERTIFICATE"; do
            retries=$((retries+1))
            if [ $retries -gt $max_retries ]; then
              echo "ERROR: Timeout waiting for valid CA certificate content"
              kubectl get configmap cluster-gateway-ca -n {{ .Values.clusterAgent.serverCANamespace }} -o yaml
              exit 1
            fi
            echo "Valid certificate not ready yet... (attempt $retries/$max_retries)"
            sleep 5
          done

          echo "✓ Valid CA certificate found"

          # Create/update ConfigMap in build plane namespace
          CA_CERT=$(kubectl get configmap cluster-gateway-ca -n {{ .Values.clusterAgent.serverCANamespace }} -o jsonpath='{.data.ca\.crt}')
          printf '%s' "$CA_CERT" | kubectl create configmap {{ .Values.clusterAgent.tls.serverCAConfigMap }} \
            --from-file=ca.crt=/dev/stdin \
            --namespace {{ .Release.Namespace }} \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "✓ ConfigMap copied successfully"

          echo ""
          echo "=== CA Sync Complete ==="
{{- end }}
{{- end }}
{{- end }}
