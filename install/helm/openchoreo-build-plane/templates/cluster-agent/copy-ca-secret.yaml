{{- if .Values.clusterAgent.enabled }}
{{- if .Values.clusterAgent.tls.enabled }}
{{- if and .Values.clusterAgent.tls.caSecretName (not .Values.clusterAgent.tls.serverCAValue) (not .Values.clusterAgent.tls.generateCerts) }}
---
# Job to copy cluster-gateway-ca secret from control plane to build plane namespace
# Only runs in single-cluster setup (when serverCAValue is not provided and certs are not generated locally)
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "openchoreo-build-plane.clusterAgent.name" . }}-copy-ca
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-build-plane.labels" . | nindent 4 }}
    app.kubernetes.io/component: cluster-agent
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "-5"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/component: cluster-gateway-ca-copier
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ include "openchoreo-build-plane.clusterAgent.serviceAccountName" . }}
      containers:
      - name: ca-copier
        image: bitnamilegacy/kubectl:1.32.4
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "=== Cluster Gateway CA Secret Copier ==="
          echo "Copying {{ .Values.clusterAgent.tls.caSecretName }} from {{ .Values.clusterAgent.tls.caSecretNamespace }} to {{ .Release.Namespace }}..."

          retries=0
          max_retries=12  # 1 minute

          # Wait for source secret to exist
          until kubectl get secret {{ .Values.clusterAgent.tls.caSecretName }} \
            -n {{ .Values.clusterAgent.tls.caSecretNamespace }} &> /dev/null; do
            retries=$((retries+1))
            if [ $retries -gt $max_retries ]; then
              echo "ERROR: Timeout waiting for secret {{ .Values.clusterAgent.tls.caSecretName }} in namespace {{ .Values.clusterAgent.tls.caSecretNamespace }}"
              echo "Available secrets in {{ .Values.clusterAgent.tls.caSecretNamespace }}:"
              kubectl get secrets -n {{ .Values.clusterAgent.tls.caSecretNamespace }}
              exit 1
            fi
            echo "Waiting for CA secret... ($retries/$max_retries)"
            sleep 5
          done

          echo "✓ CA secret found in control plane"

          # Wait for CA data to be populated
          retries=0
          until kubectl get secret {{ .Values.clusterAgent.tls.caSecretName }} \
            -n {{ .Values.clusterAgent.tls.caSecretNamespace }} \
            -o jsonpath='{.data.ca\.crt}' | grep -q .; do
            retries=$((retries+1))
            if [ $retries -gt $max_retries ]; then
              echo "ERROR: CA secret exists but ca.crt is empty"
              kubectl get secret {{ .Values.clusterAgent.tls.caSecretName }} \
                -n {{ .Values.clusterAgent.tls.caSecretNamespace }} -o yaml
              exit 1
            fi
            echo "Waiting for CA certificate data... ($retries/$max_retries)"
            sleep 5
          done

          echo "✓ CA certificate data found"

          # Get the secret data and change namespace
          kubectl get secret {{ .Values.clusterAgent.tls.caSecretName }} \
            -n {{ .Values.clusterAgent.tls.caSecretNamespace }} \
            -o yaml | \
            sed '/namespace:/d' | \
            sed '/resourceVersion:/d' | \
            sed '/uid:/d' | \
            sed '/creationTimestamp:/d' | \
            kubectl apply -f - -n {{ .Release.Namespace }}

          # Remove ownership annotations to avoid conflicts
          kubectl annotate secret {{ .Values.clusterAgent.tls.caSecretName }} \
            -n {{ .Release.Namespace }} \
            cert-manager.io/certificate-name- \
            cert-manager.io/issuer-name- \
            cert-manager.io/issuer-kind- \
            --overwrite || true

          # Label the secret
          kubectl label secret {{ .Values.clusterAgent.tls.caSecretName }} \
            -n {{ .Release.Namespace }} \
            app.kubernetes.io/component=cluster-agent \
            app.kubernetes.io/managed-by=Helm \
            openchoreo.dev/copied-from={{ .Values.clusterAgent.tls.caSecretNamespace }} \
            --overwrite

          echo "✓ CA secret copied successfully"
          echo ""
          echo "=== CA Secret Copy Complete ==="
{{- end }}
{{- end }}
{{- end }}
