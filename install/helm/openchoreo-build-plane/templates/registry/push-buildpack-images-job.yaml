{{- if and .Values.defaultResources.enabled .Values.defaultResources.buildpackCache.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: push-buildpack-cache-images
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "20"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  labels:
    {{- include "openchoreo-build-plane.labels" . | nindent 4 }}
spec:
  backoffLimit: 3
  template:
    metadata:
      name: push-buildpack-cache-images
    spec:
      restartPolicy: OnFailure
      containers:
      - name: push-images
        image: ghcr.io/openchoreo/podman-runner:v1.0
        imagePullPolicy: IfNotPresent
        securityContext:
          privileged: true
        command:
        - /bin/sh
        - -c
        - |
          set -e

          # 1. Registry configuration
          REGISTRY_ENDPOINT="{{ include "openchoreo-build-plane.registryEndpoint" . }}"

          echo "Target registry: ${REGISTRY_ENDPOINT}"
          echo ""

          # 2. Wait for registry to be ready (only for local registries)
          if echo "${REGISTRY_ENDPOINT}" | grep -qE "^(registry\.|localhost|host\.k3d\.internal)"; then
            echo "Waiting for local registry to be ready..."
            MAX_RETRIES=60
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f --silent --show-error --max-time 5 "http://${REGISTRY_ENDPOINT}/v2/_catalog" >/dev/null 2>&1; then
                echo "Registry is ready!"
                break
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "Registry not ready yet (attempt $RETRY_COUNT/$MAX_RETRIES), retrying in 5s..."
              sleep 5
            done

            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "ERROR: Registry did not become ready after $MAX_RETRIES attempts"
              exit 1
            fi
          fi
          echo ""

          # 3. Podman storage configuration
          mkdir -p /etc/containers
          cat <<EOF > /etc/containers/storage.conf
          [storage]
          driver = "overlay"
          runroot = "/run/containers/storage"
          graphroot = "/var/lib/containers/storage"
          [storage.options.overlay]
          mount_program = "/usr/bin/fuse-overlayfs"
          EOF

          # 4. Push buildpack images to registry
          push_image() {
            local source_image="$1"
            local cache_name="$2"
            local cached_image="${REGISTRY_ENDPOINT}/${cache_name}"

            echo "Processing: ${source_image}"
            echo "Cache target: ${cached_image}"
            echo "Registry endpoint: ${REGISTRY_ENDPOINT}"

            # Check if image already exists in registry
            if curl -f --silent --show-error "http://${REGISTRY_ENDPOINT}/v2/${cache_name%:*}/tags/list" 2>/dev/null | grep -q "${cache_name##*:}"; then
              echo "Image already exists in registry: ${cached_image}, skipping"
              echo ""
              return 0
            fi

            echo "Pulling source image: ${source_image}"
            podman pull "${source_image}"
            echo ""

            # Get the image ID - use double curly braces for podman format
            IMAGE_ID=$(podman images "${source_image}" --format "{{ "{{" }}.ID{{ "}}" }}" | head -1)
            echo "Image ID: ${IMAGE_ID}"
            echo ""

            # Tag for cache and push to registry
            echo "Tagging for registry..."
            podman tag "${IMAGE_ID}" "${cached_image}"
            echo ""

            echo "Pushing to registry: ${cached_image}"
            podman push --tls-verify=false "${cached_image}"
            echo ""

            echo "Successfully cached: ${cache_name}"
            echo ""
          }

          {{- range .Values.defaultResources.buildpackCache.images }}
          push_image "{{ .remoteImage }}" "{{ .cachedImage }}"
          {{- end }}

          echo ""
{{- end }}
