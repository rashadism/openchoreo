# Global configuration
global:
  # -- Common labels to add to every resource.
  commonLabels: {}
  # -- Base domain for external access (e.g., "openchoreo.example.com")
  # When set, registry will be accessible at registry.<baseDomain>
  baseDomain: ""
  # -- Ingress class name for registry ingress
  ingressClassName: openchoreo-traefik
  # TLS configuration
  # When enabled, TLS host is auto-derived from baseDomain (registry.<baseDomain>)
  tls:
    enabled: false
    # Secret containing TLS certificate for registry
    secretName: "registry-tls"
  # -- Configuration for the default workflow templates required for building container images.
  defaultResources:
    # -- If true, applies the workflow templates.
    enabled: true
    # -- Container registry configuration
    registry:
      # -- Registry endpoint for pushing and pulling images
      # For local registry: "registry.openchoreo-build-plane.svc.cluster.local:5000"
      # For external registry with baseDomain: automatically uses "registry.<baseDomain>"
      endpoint: "registry.openchoreo-build-plane.svc.cluster.local:5000"

    # -- Podman build cache configuration for workflow templates
    # Shared PersistentVolumeClaim across all workflow executions for faster builds
    podmanCache:
      # -- Size of the persistent volume for podman image layer cache
      size: 10Gi
      # -- Storage class for the cache PVC (optional, uses cluster default if not set)
      storageClass: ""

    # Pre-populates the local registry with buildpack images during install/upgrade to speed up builds
    buildpackCache:
      # -- Enable buildpack image caching hook
      enabled: true
      images:
        # Google Cloud Buildpacks
        - source: "docker.io/buildpacksio/lifecycle:0.20.5"
          cacheName: "buildpacks-cache/lifecycle:0.20.5"
        - source: "gcr.io/buildpacks/builder@sha256:5977b4bd47d3e9ff729eefe9eb99d321d4bba7aa3b14986323133f40b622aef1"
          cacheName: "buildpacks-cache/google-builder:latest"
        - source: "gcr.io/buildpacks/google-22/run:latest"
          cacheName: "buildpacks-cache/google-run:latest"
        # Ballerina Buildpacks
        - source: "ghcr.io/openchoreo/buildpack/ballerina:18"
          cacheName: "buildpacks-cache/ballerina-builder:18"
        - source: "ghcr.io/openchoreo/buildpack/ballerina:18-run"
          cacheName: "buildpacks-cache/ballerina-run:18"

# customizing the argo workflows configurations
argo-workflows:
  fullnameOverride: argo
  controller:
    # -- Resource limits and requests for the argo workflows controller
    resources:
      limits:
        memory: 64Mi
        cpu: 50m
      requests:
        memory: 32Mi
        cpu: 25m
  server:
    enabled: false
  crds:
    keep: false
  workflow:
    serviceAccount:
      create: true
  workflowNamespaces:
    - argo-build

# Wait job configuration for post-install hooks
waitJob:
  image: bitnamilegacy/kubectl:1.32.4

# External Secrets Operator configuration for secret management
# Single cluster: Set to false to use data plane's ESO
# Multi-cluster: Set to true to install dedicated ESO in build plane
external-secrets:
  enabled: false
  fullnameOverride: external-secrets
  nameOverride: external-secrets

# Container Registry configuration using Twuni Docker Registry Helm Chart
# Hosts container images built by Argo Workflows in the Build Plane
registry:
  fullnameOverride: registry
  # Enable persistence
  persistence:
    enabled: true
    size: 10Gi
  # Ingress for external registry access (auto-enabled when global.baseDomain is set)
  ingress:
    enabled: false
    className: ""
    annotations: {}
    tls:
      enabled: false
      secretName: ""

# Fake Secret Store configuration for local development
fakeSecretStore:
  enabled: true
  name: default
  secrets:
    - key: github-pat
      value: "fake-github-token-for-development"
    - key: npm-token
      value: "fake-npm-token-for-development"
    - key: docker-username
      value: "dev-user"
    - key: docker-password
      value: "dev-password"

fluentBit:
  enabled: false

  image:
    repository: fluent/fluent-bit
    tag: "2.1.10"
    pullPolicy: IfNotPresent

  config:
    service:
      flush: 1
      logLevel: info
      daemon: off

    input:
      name: tail
      tag: "kube.*"
      path: "/var/log/containers/*_openchoreo-*_*.log,/var/log/containers/*_openchoreo-ci-*_*.log"
      excludePath: "/var/log/containers/*opensearch*_openchoreo-observability-plane_*.log,/var/log/containers/*fluent-bit*_openchoreo-data-plane_*.log"
      parser: docker
      inotifyWatcher: false
      db: "/var/log/flb_kube.db"
      memBufLimit: "256MB"
      skipLongLines: true
      refreshInterval: 10

    filter:
      name: kubernetes
      match: "kube.*"
      kubeURL: "https://kubernetes.default.svc:443"
      kubeCAFile: "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
      kubeTokenFile: "/var/run/secrets/kubernetes.io/serviceaccount/token"
      kubeTagPrefix: "kube.var.log.containers."
      mergeLog: true
      mergeLogKey: "log_processed"
      k8sLoggingParser: true
      k8sLoggingExclude: false

    output:
      name: opensearch
      match: "kube.*"
      index: kubernetes_cluster
      type: flb_type
      logstashFormat: true
      logstashPrefix: kubernetes
      timeKey: "@timestamp"
      traceError: true
      suppressTypeName: true

    # OpenSearch connection configuration
    opensearch:
      host: "opensearch.openchoreo-observability-plane.svc.cluster.local"
      port: "9200"
      authentication:
        basicauth:
          username: "admin"
          password: "admin"
      tls: false
      tlsVerify: false

    parser:
      name: docker
      format: json
      timeKey: time
      timeFormat: "%Y-%m-%dT%H:%M:%S.%L"
      timeKeep: true

  rbac:
    create: true
    serviceAccountName: fluent-bit

  hostPaths:
    varLog: /var/log
    dockerContainers: /var/lib/docker/containers

# Cluster Agent configuration for agent-based communication with control plane
clusterAgent:
  enabled: true  # Enabled by default for single-cluster setups
  name: cluster-agent-buildplane
  replicas: 1
  image:
    repository: ghcr.io/openchoreo/cluster-agent
    tag: "" # If no value is set, use Chart.AppVersion
    pullPolicy: IfNotPresent
  # Server URL of the cluster gateway in control plane
  serverUrl: wss://cluster-gateway.openchoreo-control-plane.svc.cluster.local:8443/ws

  # Logical plane identifier - shared across multiple CRs connecting to the same physical plane
  # One agent per physical plane handles all CRs with the same planeID (multi-tenancy)
  # If not specified, defaults to Helm release name
  # Example: "shared-builder" - all BuildPlane CRs with planeID="shared-builder" share this agent
  planeID: default-buildplane

  # Type of plane (dataplane, buildplane, or observabilityplane)
  planeType: buildplane
  # DNS rewrite configuration (for multi-cluster k3d setups)
  # When enabled, configures CoreDNS to rewrite *.openchoreo.localhost to host.k3d.internal
  dnsRewrite:
    enabled: false
  heartbeatInterval: 30s
  reconnectDelay: 5s
  logLevel: info
  resources:
    requests:
      cpu: "50m"
      memory: "128Mi"
    limits:
      cpu: "100m"
      memory: "256Mi"
  serviceAccount:
    create: true
    name: cluster-agent-buildplane
    annotations: {}
  rbac:
    create: true
  priorityClass:
    create: false
    name: cluster-agent-buildplane
    value: 900000
  tls:
    enabled: true
    # Generate client certificates locally using cert-manager (multi-cluster setup)
    # Set to true when the build plane is in a different cluster from control plane
    # When true, cert-manager will generate the client certificates instead of copying CA from control plane
    generateCerts: false
    # Secret containing client certificate and key
    secretName: cluster-agent-tls
    clientSecretName: cluster-agent-tls
    # ConfigMap containing server CA certificate for verifying gateway
    serverCAConfigMap: cluster-gateway-ca
    # Optional: Inline server CA certificate value (PEM format)
    # For multi-cluster setup where agent needs to verify gateway server
    # If provided, this value is used instead of copying from control plane
    serverCAValue: ""
    # CA secret for signing agent client certificates
    # Option 1: Reference existing secret (single-cluster setup)
    # This should be the name of the cluster-gateway-ca secret created in control plane
    caSecretName: cluster-gateway-ca
    # Namespace where the CA secret exists (control plane namespace)
    caSecretNamespace: openchoreo-control-plane
    # Option 2: Inline CA certificate value (PEM format, multi-cluster setup)
    # If provided, this takes precedence over caSecretName/caSecretNamespace
    # Use this when build plane is in a different cluster from control plane
    caValue: ""
    # Certificate duration and renewal
    duration: 2160h # 90 days
    renewBefore: 360h # 15 days
  # Namespace where cluster-gateway CA exists (control plane namespace)
  serverCANamespace: openchoreo-control-plane
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true
  podAnnotations: {}
  nodeSelector: {}
  tolerations: []
  affinity: {}
