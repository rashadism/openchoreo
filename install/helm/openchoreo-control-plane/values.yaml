# Global values shared across all components
global:
  # Base domain for all services
  # Console: <baseDomain>, API: api.<baseDomain>
  baseDomain: openchoreo.local

  # Port suffix for URLs (e.g., ":8080" for non-standard ports)
  # Include the colon. Leave empty for standard ports (80/443)
  port: ""

  # TLS - enables HTTPS for all ingresses
  # When enabled, TLS hosts are auto-derived from baseDomain
  tls:
    enabled: false
    # Secret containing TLS certificate (must have all hosts: baseDomain, api.baseDomain, thunder.baseDomain)
    secretName: "control-plane-tls"

  # Ingress class for all services (uses Traefik by default)
  ingressClassName: openchoreo-traefik

  # Other settings
  clusterName: openchoreo
  imagePullSecrets: []
  commonLabels: {}

  # Default OpenChoreo resources created during installation
  defaultResources:
    enabled: true
    organization:
      displayName: Default Organization
      description: Getting started with your first organization
    project:
      displayName: Default Project
      description: Your first project to get started
    environments:
      - name: development
        displayName: Development
        description: Development environment for testing
        dnsPrefix: dev
        isCritical: false
      - name: staging
        displayName: Staging
        description: Staging environment for pre-production testing
        dnsPrefix: staging
        isCritical: false
      - name: production
        displayName: Production
        description: Production environment
        dnsPrefix: prod
        isCritical: true
    deploymentPipeline:
      displayName: Default Pipeline
      description: Standard deployment pipeline with dev, staging, and prod environments
      promotionOrder:
        - sourceEnvironmentRef: development
          targetEnvironmentRefs:
            - name: staging
              requiresApproval: false
        - sourceEnvironmentRef: staging
          targetEnvironmentRefs:
            - name: production
              requiresApproval: false
# Override the full name of the chart release
fullnameOverride: openchoreo
# Common security configuration shared across all components
security:
  # Global security toggle - when disabled, authentication is turned off for all components
  enabled: true
  oidc:
    issuer: ""
    wellKnownEndpoint: ""
    jwksUrl: ""
    authorizationUrl: ""
    tokenUrl: ""
  jwt:
    # Expected audience claim in JWT tokens
    audience: ""
  authz:
    enabled: false
    databasePath: "/var/lib/openchoreo/data/casbin.db"
    # defaultAuthzDataFilePath is optional - if not set, embedded default authz data will be used
    # To use custom authz data (roles and mappings), set this path and mount a ConfigMap with your data
    defaultAuthzDataFilePath: ""
controllerManager:
  name: controller-manager
  replicas: 1
  image:
    repository: ghcr.io/openchoreo/controller
    tag: "" # If no value is set, use Chart.AppVersion
    pullPolicy: Always
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 200m
      memory: 256Mi
  serviceAccount:
    create: true
    annotations: {}
  priorityClass:
    create: false
    name: openchoreo-controller-manager
    value: 1000000
  service:
    type: ClusterIP
    port: 8080
    nodePort: null
  metrics:
    enabled: true
    serviceMonitor:
      enabled: false
      namespace: monitoring
      interval: 30s
      scrapeTimeout: 10s
      labels:
        prometheus: kube-prometheus
      relabelings: []
  podDisruptionBudget:
    enabled: false
    minAvailable: 1
  networkPolicy:
    enabled: false
    ingress: []
    egress: []
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
    behavior:
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
          - type: Percent
            value: 50
            periodSeconds: 60
      scaleUp:
        stabilizationWindowSeconds: 0
        policies:
          - type: Percent
            value: 100
            periodSeconds: 15
          - type: Pods
            value: 4
            periodSeconds: 60
        selectPolicy: Max
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: openchoreo
          app.kubernetes.io/component: controller-manager
    - maxSkew: 1
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: DoNotSchedule
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: openchoreo
          app.kubernetes.io/component: controller-manager
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podSecurityContext:
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
  containerSecurityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false
    seccompProfile:
      type: RuntimeDefault
    appArmorProfile:
      type: Unconfined
  manager:
    args:
      - --metrics-bind-address=:8443
      - --leader-elect
      - --health-probe-bind-address=:8081
    env:
      enableWebhooks: "true"
  # Cluster Gateway configuration for agent-based data plane communication
  clusterGateway:
    enabled: true
    url: https://cluster-gateway.openchoreo-control-plane.svc.cluster.local:8443
    tls:
      caPath: /etc/cluster-gateway/ca.crt
      # CA Secret created by cert-manager (contains ca.crt from cluster-gateway-ca Certificate)
      caSecret: cluster-gateway-ca
kubernetesClusterDomain: cluster.local
metricsService:
  ports:
    - name: https
      port: 8443
      protocol: TCP
      targetPort: 8443
  type: ClusterIP
webhookService:
  ports:
    - port: 443
      protocol: TCP
      targetPort: 9443
  type: ClusterIP
waitJob:
  image: bitnamilegacy/kubectl:1.32.4
metricsServer:
  enabled: false
  kubeletInsecureTlsEnabled: true
openchoreoApi:
  name: openchoreo-api # Static name for all openchoreo-api resources (Service, Deployment, ClusterRole, etc.)
  enabled: true
  replicas: 1
  image:
    repository: ghcr.io/openchoreo/openchoreo-api
    tag: "" # If no value is set, use Chart.AppVersion
    pullPolicy: IfNotPresent
  mcp:
    toolsets: "organization,project,component,build,deployment,infrastructure"
  logLevel: info
  database:
    path: "/var/lib/openchoreo/data/controlplane.db"
    persistence:
      enabled: true
      size: 500Mi
      storageClassName: "" # Use default storage class if not specified
  resources:
    requests:
      cpu: "200m"
      memory: "256Mi"
    limits:
      cpu: "1000m"
      memory: "1Gi"
  serviceAccount:
    name: openchoreo-api # Service account name (always created when openchoreoApi.enabled is true)
    annotations: {}
  priorityClass:
    create: false
    name: openchoreo-api
    value: 900000
  service:
    type: ClusterIP
    port: 8080
    nodePort: null
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
    behavior:
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
          - type: Percent
            value: 50
            periodSeconds: 60
      scaleUp:
        stabilizationWindowSeconds: 0
        policies:
          - type: Percent
            value: 100
            periodSeconds: 15
          - type: Pods
            value: 4
            periodSeconds: 60
        selectPolicy: Max
  podDisruptionBudget:
    enabled: false
    minAvailable: 1
  networkPolicy:
    enabled: false
    ingress: []
    egress: []
  metrics:
    enabled: true
    serviceMonitor:
      enabled: false
      namespace: monitoring
      interval: 30s
      scrapeTimeout: 10s
      labels:
        prometheus: kube-prometheus
      relabelings: []
  ingress:
    enabled: true
    ingressClassName: ""
    annotations: {}
    hosts: []
    tls: []
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: openchoreo
          app.kubernetes.io/component: api-server
    - maxSkew: 1
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: DoNotSchedule
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: openchoreo
          app.kubernetes.io/component: api-server
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podSecurityContext:
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
  containerSecurityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false
    seccompProfile:
      type: RuntimeDefault
    appArmorProfile:
      type: Unconfined
  security:
    userTypes:
      - type: "user"
        display_name: "User"
        priority: 1
        auth_mechanisms:
          - type: "oauth2"
            entitlement:
              claim: "groups"
              display_name: "User Group"
      - type: "service_account"
        display_name: "Service Account"
        priority: 2
        auth_mechanisms:
          - type: "oauth2"
            entitlement:
              claim: "sub"
              display_name: "Client ID"

# Backstage UI configuration
backstage:
  enabled: true
  replicas: 1
  image:
    repository: ghcr.io/openchoreo/openchoreo-ui
    tag: "" # If no value is set, use Chart.AppVersion
    pullPolicy: IfNotPresent
  service:
    type: ClusterIP
    port: 7007
    nodePort: null
  resources:
    limits:
      cpu: 2000m
      memory: 2Gi
    requests:
      cpu: 200m
      memory: 256Mi
  serviceAccount:
    name: openchoreo-backstage # Service account name (always created when backstage.enabled is true)
    annotations: {}
  priorityClass:
    create: false
    name: openchoreo-backstage
    value: 800000
  backendSecret: ""
  openchoreoApi:
    url: ""

  # Feature flags for enabling/disabling OpenChoreo features in Backstage
  # These control which plugins and functionality are available in the UI
  features:
    # Build plane / Workflows functionality
    # When disabled, hides Workflows tab and WorkflowsOverviewCard from entity pages
    workflows:
      enabled: true
    # Observability plane features (Metrics, Traces, Runtime Logs)
    # When disabled, hides Metrics, Traces, Runtime Logs tabs and RuntimeHealthCard from entity pages
    observability:
      enabled: true
  env:
    - name: NODE_ENV
      value: production
    - name: LOG_LEVEL
      value: info
    - name: PORT
      value: "7007"
  baseUrl: ""
  thunder:
    baseUrl: ""
    token: ""
  auth:
    authorizationUrl: ""
    tokenUrl: ""
    clientId: "openchoreo-backstage-client"
    clientSecret: "backstage-portal-secret"
    redirectUrls: []
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
    behavior:
      scaleDown:
        stabilizationWindowSeconds: 300
        policies:
          - type: Percent
            value: 50
            periodSeconds: 60
      scaleUp:
        stabilizationWindowSeconds: 0
        policies:
          - type: Percent
            value: 100
            periodSeconds: 15
          - type: Pods
            value: 4
            periodSeconds: 60
        selectPolicy: Max
  podDisruptionBudget:
    enabled: false
    minAvailable: 1
  networkPolicy:
    enabled: false
    ingress: []
    egress: []
  metrics:
    enabled: true
    serviceMonitor:
      enabled: false
      namespace: monitoring
      interval: 30s
      scrapeTimeout: 10s
      labels:
        prometheus: kube-prometheus
      relabelings: []
  ingress:
    enabled: true
    ingressClassName: ""
    annotations: {}
    hosts: []
    tls: []
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: openchoreo
          app.kubernetes.io/component: backstage
    - maxSkew: 1
      topologyKey: kubernetes.io/hostname
      whenUnsatisfiable: DoNotSchedule
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: openchoreo
          app.kubernetes.io/component: backstage
  nodeSelector: {}
  tolerations: []
  affinity: {}
  podSecurityContext:
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
  containerSecurityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false
    seccompProfile:
      type: RuntimeDefault
    appArmorProfile:
      type: Unconfined
# Asgardeo Thunder (Platform Identity Provider) configuration
thunder:
  enabled: true
  fullnameOverride: thunder
  # Deployment configuration
  deployment:
    replicaCount: 1
    strategy:
      rollingUpdate:
        maxSurge: 1
        maxUnavailable: 0
    securityContext:
      # Must be false for SQLite to work (needs write access to database directory)
      readOnlyRootFilesystem: false
      enableRunAsUser: true
      fsGroup: 802
      runAsUser: 802
      seccompProfile:
        enabled: true
        type: RuntimeDefault
    terminationGracePeriodSeconds: 10
    image:
      registry: ghcr.io/asgardeo
      repository: thunder
      tag: "0.15.0"
      pullPolicy: IfNotPresent
    container:
      port: 8090
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi

  persistence:
    enabled: true
    storageClass: ""
    accessMode: ReadWriteOnce
    size: 1Gi
    annotations: {}

  # Service configuration
  service:
    port: 8090

  # Service Account configuration
  serviceAccount:
    name: thunder-service-account
    create: true

  # HPA configuration (disabled for local dev)
  hpa:
    enabled: false

  # PDB configuration (disabled for local dev)
  pdb:
    minAvailable: "50%"

  # Ingress configuration (disabled - using k3d ingress instead)
  ingress:
    enabled: false
    ingressClassName: ""
    annotations: {}
    hosts: []
    tls: []
  
  ocIngress:
    enabled: true
    ingressClassName: ""
    annotations: {}
    hosts: []
    tls: []

  # Thunder application configuration
  configuration:
    server:
      port: 8090
      httpOnly: true
      publicUrl: ""

    gateClient:
      hostname: ""
      port: 8080
      scheme: "http"
      loginPath: "/gate/signin"
      errorPath: "/gate/error"

    security:
      certFile: "repository/resources/security/server.cert"
      keyFile: "repository/resources/security/server.key"
      cryptoFile: "repository/resources/security/crypto.key"

    # Database configuration - Using SQLite for local k3d development
    database:
      identity:
        type: sqlite
        sqlitePath: "repository/database/thunderdb.db"
        sqliteOptions: "_journal_mode=WAL&_busy_timeout=5000"
      runtime:
        type: sqlite
        sqlitePath: "repository/database/runtimedb.db"
        sqliteOptions: "_journal_mode=WAL&_busy_timeout=5000"
      user:
        type: sqlite
        sqlitePath: "repository/database/userdb.db"
        sqliteOptions: "_journal_mode=WAL&_busy_timeout=5000"

    # Cache configuration
    cache:
      disabled: false
      type: "inmemory"
      size: 1000
      ttl: 3600
      evictionPolicy: "LRU"
      cleanupInterval: 300

    # Token configuration
    jwt:
      issuer: "thunder"
      validityPeriod: 3600
      audience: "application"

    # OAuth configuration
    oauth:
      refreshToken:
        renewOnGrant: false
        validityPeriod: 86400

    # Flow configuration
    flow:
      graphDirectory: "repository/resources/graphs/"
      authn:
        defaultFlow: "auth_flow_config_basic"

    # CORS configuration - Include both ingress hosts
    cors:
      allowedOrigins:
        - "http://openchoreo.localhost:8080"
        - "http://localhost:7007"

  # Setup job configuration
  setup:
    enabled: true
    backoffLimit: 3
    ttlSecondsAfterFinished: 86400  # 24 hours
    preserveJob: true
    debug: false
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 250m
        memory: 128Mi

  # Bootstrap configuration for Backstage OAuth app and default users
  # These scripts run during the setup job to initialize Thunder
  # Scripts are defined in templates/thunder/bootstrap-scripts-configmap.yaml
  bootstrap:
    enabled: true
    configMap:
      # Reference to external ConfigMap containing bootstrap scripts
      # Using Pattern 2: Only override specific files while preserving Thunder's default bootstrap scripts
      name: openchoreo-thunder-bootstrap
      files:
        - 50-backstage-app.sh
        - 51-user-schema-and-users.sh
        - 52-default-apps.sh
    # Default users to create during bootstrap
    defaultUsers:
      - username: "admin@openchoreo.dev"
        password: "Admin@123"
        givenName: "Admin"
        familyName: "User"
        groups: ["platformEngineer"]
    # Default OAuth applications to create during bootstrap
    defaultApps:
      - clientId: "customer-portal-client"
        clientSecret: "supersecret"
        redirectUrls:
          - "http://localhost:3000/auth/callback"
          - "http://localhost:3000/auth/handler"

# Cluster Gateway configuration
# The gateway manages WebSocket connections from cluster agents
clusterGateway:
  enabled: true
  name: cluster-gateway
  replicas: 1
  image:
    repository: ghcr.io/openchoreo/cluster-gateway
    tag: "" # If no value is set, use Chart.AppVersion
    pullPolicy: IfNotPresent
  port: 8443
  heartbeatInterval: 30s
  heartbeatTimeout: 90s
  logLevel: info
  resources:
    requests:
      cpu: "100m"
      memory: "64Mi"
    limits:
      cpu: "500m"
      memory: "256Mi"
  serviceAccount:
    create: true
    name: cluster-gateway
    annotations: {}
  priorityClass:
    create: false
    name: cluster-gateway
    value: 900000
  service:
    type: ClusterIP
    port: 8443
    nodePort: null
    loadBalancerIP: null
    clusterIP: null
  ingress:
    enabled: false
    ingressClassName: ""
    annotations: {}
    hosts: []
  tls:
    enabled: true
    secretName: cluster-gateway-tls
    issuerRef:
      kind: Issuer
      name: cluster-gateway-selfsigned-issuer
    dnsNames:
      - cluster-gateway.openchoreo-control-plane.svc
      - cluster-gateway.openchoreo-control-plane.svc.cluster.local
    duration: 2160h # 90 days
    renewBefore: 360h # 15 days
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: true
  nodeSelector: {}
  tolerations: []
  affinity: {}

traefik:
  enabled: true
  fullnameOverride: openchoreo-traefik
  ingressClass:
    enabled: true
    isDefaultClass: false
    name: openchoreo-traefik
  service:
    type: LoadBalancer
  # Port configuration for Traefik LoadBalancer
  ports:
    web:
      port: 8000           # Container port
      exposedPort: 80      # LoadBalancer port for HTTP
      expose:
        default: true
    websecure:
      port: 8443           # Container port
      exposedPort: 443     # LoadBalancer port for HTTPS
      expose:
        default: true
      tls:
        enabled: true
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  ingressRoute:
    dashboard:
      enabled: false
  providers:
    kubernetesIngress:
      ingressClass: openchoreo-traefik
  logs:
    general:
      level: INFO
    access:
      enabled: false
