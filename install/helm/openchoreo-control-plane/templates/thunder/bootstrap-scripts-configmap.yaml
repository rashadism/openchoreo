{{- if .Values.thunder.enabled }}
{{- if .Values.thunder.bootstrap.enabled }}
{{- $scheme := ternary "http" "https" .Values.thunder.configuration.server.httpOnly }}
{{- $curlInsecure := ternary "" "-k" .Values.thunder.configuration.server.httpOnly }}
{{- $port := .Values.thunder.configuration.server.port }}
{{- $thunderUrl := printf "%s://localhost:%d" $scheme (int $port) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: openchoreo-thunder-bootstrap
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-control-plane.labels" . | nindent 4 }}
    app.kubernetes.io/component: thunder-bootstrap
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-10"
data:
  50-user-schema-and-users.sh: |
    #!/bin/bash
    set -e

    # First, create the default OU if it doesn't exist
    log_info "Checking if default organization unit exists..."
    if ! curl {{ $curlInsecure }} -s --max-time 10 '{{ $thunderUrl }}/organization-units' | grep -q '"handle":"default"'; then
      log_info "Creating default organization unit..."
      curl {{ $curlInsecure }} --location '{{ $thunderUrl }}/organization-units' \
        --header 'Content-Type: application/json' \
        --header 'Accept: application/json' \
        --data '{
          "name": "Default",
          "handle": "default",
          "description": "Default organizational unit"
        }' \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5
      log_info "Default organization unit created successfully"
    else
      log_info "Default organization unit already exists"
    fi

    # Get the organization unit ID
    ORG_UNIT_ID=$(curl {{ $curlInsecure }} -s --max-time 10 '{{ $thunderUrl }}/organization-units' | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
    log_info "Using organization unit ID: $ORG_UNIT_ID"

    log_info "Checking if user schema 'engineer' already exists..."
    existing_schemas=$(curl {{ $curlInsecure }} -s --max-time 10 '{{ $thunderUrl }}/user-schemas')

    if echo "$existing_schemas" | grep -q '"name":"engineer"'; then
      log_info "User schema 'engineer' already exists, skipping creation"
    else
      log_info "User schema does not exist, creating user schema..."
      curl {{ $curlInsecure }} --location '{{ $thunderUrl }}/user-schemas' \
        --header 'accept: application/json' \
        --header 'Content-Type: application/json' \
        --data "{
          \"name\": \"engineer\",
          \"ouId\": \"$ORG_UNIT_ID\",
          \"allowSelfRegistration\": true,
          \"schema\": {
            \"username\": {
              \"type\": \"string\",
              \"required\": true
            },
            \"password\": {
              \"type\": \"string\",
              \"required\": true
            },
            \"given_name\": {
              \"type\": \"string\"
            },
            \"family_name\": {
              \"type\": \"string\"
            }
          }
        }" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "User schema created successfully"
    fi

    # Create default users and store their IDs
    {{- if .Values.thunder.bootstrap.defaultUsers }}
    {{- range $index, $user := .Values.thunder.bootstrap.defaultUsers }}
    log_info "Checking if user '{{ $user.username }}' already exists..."
    existing_users=$(curl {{ $curlInsecure }} -s --max-time 10 '{{ $thunderUrl }}/users')

    if echo "$existing_users" | grep -q '"username":"{{ $user.username }}"'; then
      log_info "User '{{ $user.username }}' already exists, getting ID..."
      USER_ID_{{ $index }}=$(echo "$existing_users" | grep -o '"username":"{{ $user.username }}"[^}]*"id":"[^"]*"\|"id":"[^"]*"[^}]*"username":"{{ $user.username }}"' | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
    else
      log_info "User does not exist, creating user '{{ $user.username }}'..."
      USER_RESPONSE=$(curl {{ $curlInsecure }} --location '{{ $thunderUrl }}/users' \
        --header 'accept: application/json' \
        --header 'Content-Type: application/json' \
        --data "{
          \"type\": \"engineer\",
          \"organizationUnit\": \"$ORG_UNIT_ID\",
          \"attributes\": {
            \"username\": \"{{ $user.username }}\",
            \"password\": \"{{ $user.password }}\",
            \"given_name\": \"{{ $user.givenName }}\",
            \"family_name\": \"{{ $user.familyName }}\"
          }
        }" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5)

      log_info "User '{{ $user.username }}' created successfully"
      USER_ID_{{ $index }}=$(echo "$USER_RESPONSE" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
    fi
    {{- end }}

    # Create groups from values.yaml and assign users to their groups
    {{- $allGroups := list }}
    {{- range .Values.thunder.bootstrap.defaultUsers }}
      {{- range .groups }}
        {{- $allGroups = append $allGroups . }}
      {{- end }}
    {{- end }}
    {{- $uniqueGroups := $allGroups | uniq }}
    {{- range $groupName := $uniqueGroups }}
    log_info "Checking if group '{{ $groupName }}' already exists..."
    existing_groups=$(curl {{ $curlInsecure }} -s --max-time 10 '{{ $thunderUrl }}/groups')

    if echo "$existing_groups" | grep -q '"name":"{{ $groupName }}"'; then
      log_info "Group '{{ $groupName }}' already exists, skipping creation"
    else
      log_info "Group does not exist, creating group '{{ $groupName }}' with members..."
      # Build members list for users belonging to this group
      GROUP_MEMBERS=""
      {{- range $idx, $u := $.Values.thunder.bootstrap.defaultUsers }}
        {{- if has $groupName $u.groups }}
      if [ -n "$USER_ID_{{ $idx }}" ]; then
        if [ -n "$GROUP_MEMBERS" ]; then
          GROUP_MEMBERS="$GROUP_MEMBERS,{\"type\":\"user\",\"id\":\"$USER_ID_{{ $idx }}\"}"
        else
          GROUP_MEMBERS="{\"type\":\"user\",\"id\":\"$USER_ID_{{ $idx }}\"}"
        fi
      fi
        {{- end }}
      {{- end }}
      curl {{ $curlInsecure }} --location '{{ $thunderUrl }}/groups' \
        --header 'accept: application/json' \
        --header 'Content-Type: application/json' \
        --data "{
          \"name\": \"{{ $groupName }}\",
          \"organizationUnitId\": \"$ORG_UNIT_ID\",
          \"description\": \"{{ $groupName }} group\",
          \"members\": [$GROUP_MEMBERS]
        }" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "Group '{{ $groupName }}' created successfully with members"
    fi
    {{- end }}
    {{- end }}

  51-backstage-app.sh: |
    #!/bin/bash
    set -e

    log_info "Checking if application 'Backstage' already exists..."
    existing_apps=$(curl {{ $curlInsecure }} -s --max-time 10 '{{ $thunderUrl }}/applications')

    # Extract application ID if it exists
    app_id=$(echo "$existing_apps" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)

    # Define the application payload
    APP_PAYLOAD='{
      "name": "Backstage",
      "description": "OpenChoreo Backstage Portal",
      "allowed_user_types": ["engineer"],
      "assertion": {
        "validity_period": 3600
      },
      "inbound_auth_config": [
        {
          "type": "oauth2",
          "config": {
            "client_id": "{{ .Values.backstage.auth.clientId }}",
            "client_secret": "{{ .Values.backstage.auth.clientSecret }}",
            "redirect_uris": [
              {{- if .Values.backstage.auth.redirectUrls }}
              {{- range $index, $url := .Values.backstage.auth.redirectUrls }}
              {{- if $index }},{{ end }}
              "{{ $url }}"
              {{- end }}
              {{- else }}
              "{{ include "openchoreo.consoleExternalUrl" . }}/api/auth/openchoreo-auth/handler/frame"
              {{- end }}
            ],
            "grant_types": [
              "authorization_code",
              "client_credentials"
            ],
            "response_types": [
              "code"
            ],
            "token_endpoint_auth_method": "client_secret_post",
            "pkce_required": false,
            "public_client": false,
            "token": {
              "access_token": {
                "validity_period": 86400,
                "user_attributes": [
                  "given_name",
                  "family_name",
                  "username",
                  "groups"
                ]
              },
              "id_token": {
                "validity_period": 86400,
                "user_attributes": [
                  "given_name",
                  "family_name",
                  "username",
                  "groups"
                ],
                "scope_claims": {
                  "groups": [
                    "groups"
                  ],
                  "profile": [
                    "username",
                    "given_name",
                    "family_name",
                    "picture"
                  ]
                }
              }
            }
          }
        }
      ]
    }'

    if echo "$existing_apps" | grep -q '"name":"Backstage"'; then
      log_info "Application 'Backstage' already exists (id: $app_id), updating..."
      curl {{ $curlInsecure }} --location -X PUT "{{ $thunderUrl }}/applications/$app_id" \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "Application updated successfully"
    else
      log_info "Application does not exist, creating default application..."
      curl {{ $curlInsecure }} --location '{{ $thunderUrl }}/applications' \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "Default application created successfully"
    fi

  52-default-apps.sh: |
    #!/bin/bash
    set -e

    # Create default applications
    {{- if .Values.thunder.bootstrap.defaultApps }}
    {{- range .Values.thunder.bootstrap.defaultApps }}
    log_info "Checking if application with client ID '{{ .clientId }}' already exists..."
    existing_apps=$(curl {{ $curlInsecure }} -s --max-time 10 '{{ $thunderUrl }}/applications')

    # Extract application ID if it exists
    app_id=$(echo "$existing_apps" | grep -o '"client_id":"{{ .clientId }}"[^}]*"id":"[^"]*"\|"id":"[^"]*"[^}]*"client_id":"{{ .clientId }}"' | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)

    # Define the application payload
    APP_PAYLOAD='{
      "name": "Default App",
      "description": "Default Application",
      "inbound_auth_config": [
        {
          "type": "oauth2",
          "config": {
            "client_id": "{{ .clientId }}",
            "client_secret": "{{ .clientSecret }}",
            "grant_types": [
              "client_credentials"
            ],
            "token_endpoint_auth_method": "client_secret_post",
            "pkce_required": false,
            "public_client": false,
            "token": {
              "access_token": {
                "validity_period": 3600
              }
            }
          }
        }
      ]
    }'

    if echo "$existing_apps" | grep -q '"client_id":"{{ .clientId }}"'; then
      log_info "Application with client ID '{{ .clientId }}' already exists (id: $app_id), updating..."
      curl {{ $curlInsecure }} --location -X PUT "{{ $thunderUrl }}/applications/$app_id" \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "Application updated successfully"
    else
      log_info "Application does not exist, creating application with client ID '{{ .clientId }}'..."
      curl {{ $curlInsecure }} --location '{{ $thunderUrl }}/applications' \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "Application created successfully"
    fi
    {{- end }}
    {{- end }}

  53-rca-agent-client.sh: |
    #!/bin/bash
    set -e

    log_info "Checking if RCA Agent application already exists..."
    existing_apps=$(curl {{ $curlInsecure }} -s --max-time 10 '{{ $thunderUrl }}/applications')

    # Extract application ID if it exists
    app_id=$(echo "$existing_apps" | grep -o '"client_id":"{{ .Values.thunder.bootstrap.rcaAgentClient.clientId }}"[^}]*"id":"[^"]*"\|"id":"[^"]*"[^}]*"client_id":"{{ .Values.thunder.bootstrap.rcaAgentClient.clientId }}"' | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)

    # Define the application payload
    APP_PAYLOAD='{
      "name": "RCA Agent",
      "description": "OpenChoreo RCA Agent Client",
      "inbound_auth_config": [
        {
          "type": "oauth2",
          "config": {
            "client_id": "{{ .Values.thunder.bootstrap.rcaAgentClient.clientId }}",
            "client_secret": "{{ .Values.thunder.bootstrap.rcaAgentClient.clientSecret }}",
            "grant_types": [
              "client_credentials"
            ],
            "token_endpoint_auth_method": "client_secret_post",
            "pkce_required": false,
            "public_client": false,
            "token": {
              "access_token": {
                "validity_period": 3600
              }
            }
          }
        }
      ]
    }'

    if echo "$existing_apps" | grep -q '"client_id":"{{ .Values.thunder.bootstrap.rcaAgentClient.clientId }}"'; then
      log_info "RCA Agent application already exists (id: $app_id), updating..."
      curl {{ $curlInsecure }} --location -X PUT "{{ $thunderUrl }}/applications/$app_id" \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "RCA Agent application updated successfully"
    else
      log_info "RCA Agent application does not exist, creating..."
      curl {{ $curlInsecure }} --location '{{ $thunderUrl }}/applications' \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "RCA Agent application created successfully"
    fi

  54-cli-app.sh: |
    #!/bin/bash
    set -e

    log_info "Checking if application 'OpenChoreo CLI' already exists..."
    existing_apps=$(curl {{ $curlInsecure }} -s --max-time 10 '{{ $thunderUrl }}/applications')

    # Extract application ID if it exists
    app_id=$(echo "$existing_apps" | grep -o '"name":"OpenChoreo CLI"[^}]*"id":"[^\"]*"\|"id":"[^\"]*"[^}]*"name":"OpenChoreo CLI"' | grep -o '"id":"[^\"]*"' | head -1 | cut -d'"' -f4)

    # Define the application payload
    {{- $cliClient := "" }}
    {{- range .Values.security.oidc.externalClients }}
      {{- if eq .name "cli" }}
        {{- $cliClient = .client_id }}
      {{- end }}
    {{- end }}
    APP_PAYLOAD='{
      "name": "OpenChoreo CLI",
      "description": "OpenChoreo CLI Default Application",
      "allowed_user_types": ["engineer"],
      "assertion": {
        "validity_period": 3600
      },
      "inbound_auth_config": [
        {
          "type": "oauth2",
          "config": {
            "client_id": "{{ $cliClient }}",
            "redirect_uris": [
              "http://127.0.0.1:55152/auth-callback"
            ],
            "grant_types": [
              "authorization_code", "refresh_token"
            ],
            "response_types": [
              "code"
            ],
            "token_endpoint_auth_method": "none",
            "pkce_required": true,
            "public_client": true,
            "token": {
              "access_token": {
                "validity_period": 3600,
                "user_attributes": [
                  "given_name",
                  "family_name",
                  "username",
                  "groups"
                ]
              },
              "id_token": {
                "validity_period": 3600,
                "user_attributes": [
                  "given_name",
                  "family_name",
                  "username",
                  "groups"
                ],
                "scope_claims": {
                  "groups": [
                    "groups"
                  ],
                  "profile": [
                    "username",
                    "given_name",
                    "family_name",
                    "picture"
                  ]
                }
              }
            }
          }
        }
      ]
    }'

    if echo "$existing_apps" | grep -q '"name":"OpenChoreo CLI"'; then
      log_info "Application 'OpenChoreo CLI' already exists (id: $app_id), updating..."
      curl {{ $curlInsecure }} --location -X PUT "{{ $thunderUrl }}/applications/$app_id" \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "Application updated successfully"
    else
      log_info "Application does not exist, creating default CLI application..."
      curl {{ $curlInsecure }} --location '{{ $thunderUrl }}/applications' \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "Default CLI application created successfully"
    fi

  55-system-app.sh: |
    #!/bin/bash
    set -e

    log_info "Checking if system application already exists..."
    existing_apps=$(curl {{ $curlInsecure }} -s --max-time 10 '{{ $thunderUrl }}/applications')

    # Extract application ID if it exists
    app_id=$(echo "$existing_apps" | grep -o '"client_id":"{{ .Values.thunder.bootstrap.systemApp.clientId }}"[^}]*"id":"[^"]*"\|"id":"[^"]*"[^}]*"client_id":"{{ .Values.thunder.bootstrap.systemApp.clientId }}"' | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)

    # Define the application payload
    APP_PAYLOAD='{
      "name": "System Application",
      "description": "Generic system application for automation and integrations",
      "inbound_auth_config": [
        {
          "type": "oauth2",
          "config": {
            "client_id": "{{ .Values.thunder.bootstrap.systemApp.clientId }}",
            "client_secret": "{{ .Values.thunder.bootstrap.systemApp.clientSecret }}",
            "grant_types": [
              "client_credentials"
            ],
            "token_endpoint_auth_method": "client_secret_post",
            "pkce_required": false,
            "public_client": false,
            "token": {
              "access_token": {
                "validity_period": 3600
              }
            }
          }
        }
      ]
    }'

    if echo "$existing_apps" | grep -q '"client_id":"{{ .Values.thunder.bootstrap.systemApp.clientId }}"'; then
      log_info "System application already exists (id: $app_id), updating..."
      curl {{ $curlInsecure }} --location -X PUT "{{ $thunderUrl }}/applications/$app_id" \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "System application updated successfully"
    else
      log_info "System application does not exist, creating..."
      curl {{ $curlInsecure }} --location '{{ $thunderUrl }}/applications' \
        --header 'Content-Type: application/json' \
        --data "$APP_PAYLOAD" \
        --fail-with-body \
        --max-time 30 \
        --retry 3 \
        --retry-delay 5

      log_info "System application created successfully"
    fi
{{- end }}
{{- end }}
