{{- if .Values.clusterGateway.enabled }}
{{- if .Values.clusterGateway.tls.enabled }}
---
# Job to extract CA certificate from cluster-gateway TLS secret and populate ConfigMap
# This is needed for controller manager and cluster agents to verify the gateway server
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "openchoreo-control-plane.clusterGateway.name" . }}-ca-extractor
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-control-plane.labels" . | nindent 4 }}
    app.kubernetes.io/component: cluster-gateway
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "0"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded,hook-failed
spec:
  {{- if .Values.clusterGateway.caExtractorJob.ttlSecondsAfterFinished }}
  ttlSecondsAfterFinished: {{ .Values.clusterGateway.caExtractorJob.ttlSecondsAfterFinished }}
  {{- end }}
  template:
    metadata:
      labels:
        app.kubernetes.io/component: cluster-gateway-ca-extractor
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ include "openchoreo-control-plane.clusterGateway.serviceAccountName" . }}
      containers:
      - name: ca-extractor
        image: {{ .Values.waitJob.image }}
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "=== Cluster Gateway CA Extractor ==="
          echo "Waiting for cluster-gateway TLS secret to be ready..."

          retries=0
          max_retries=24  # 2 minutes (24 * 5s)

          # Wait for secret to exist
          until kubectl get secret {{ .Values.clusterGateway.tls.secretName }} -n {{ .Release.Namespace }} &> /dev/null; do
            retries=$((retries+1))
            if [ $retries -gt $max_retries ]; then
              echo "ERROR: Timeout waiting for secret {{ .Values.clusterGateway.tls.secretName }}"
              echo "Available secrets:"
              kubectl get secrets -n {{ .Release.Namespace }}
              exit 1
            fi
            echo "Secret not ready yet... (attempt $retries/$max_retries)"
            sleep 5
          done

          echo "✓ Secret {{ .Values.clusterGateway.tls.secretName }} found"

          # Wait for certificate to be ready (have ca.crt field)
          echo "Waiting for CA certificate data in secret..."
          retries=0
          until kubectl get secret {{ .Values.clusterGateway.tls.secretName }} -n {{ .Release.Namespace }} -o jsonpath='{.data.ca\.crt}' | grep -q .; do
            retries=$((retries+1))
            if [ $retries -gt $max_retries ]; then
              echo "ERROR: Timeout waiting for ca.crt data in secret"
              echo "Secret content:"
              kubectl get secret {{ .Values.clusterGateway.tls.secretName }} -n {{ .Release.Namespace }} -o yaml
              exit 1
            fi
            echo "CA certificate data not ready yet... (attempt $retries/$max_retries)"
            sleep 5
          done

          echo "✓ CA certificate data found in secret"

          # Extract CA certificate
          CA_CERT=$(kubectl get secret {{ .Values.clusterGateway.tls.secretName }} -n {{ .Release.Namespace }} -o jsonpath='{.data.ca\.crt}')

          if [ -z "$CA_CERT" ]; then
            echo "CA certificate field empty, using tls.crt as CA (self-signed certificate)"
            CA_CERT=$(kubectl get secret {{ .Values.clusterGateway.tls.secretName }} -n {{ .Release.Namespace }} -o jsonpath='{.data.tls\.crt}')
          fi

          if [ -z "$CA_CERT" ]; then
            echo "ERROR: No certificate data found in secret"
            kubectl get secret {{ .Values.clusterGateway.tls.secretName }} -n {{ .Release.Namespace }} -o yaml
            exit 1
          fi

          # Decode and validate certificate
          echo "Validating certificate format..."
          if ! echo "$CA_CERT" | base64 -d | grep -q "BEGIN CERTIFICATE"; then
            echo "ERROR: Invalid certificate format (not a PEM certificate)"
            echo "Decoded content:"
            echo "$CA_CERT" | base64 -d
            exit 1
          fi

          echo "✓ Certificate format valid"

          # Update ConfigMap
          echo "Updating cluster-gateway-ca ConfigMap..."
          echo "$CA_CERT" | base64 -d | kubectl create configmap cluster-gateway-ca \
            --from-file=ca.crt=/dev/stdin \
            --namespace {{ .Release.Namespace }} \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "✓ ConfigMap updated successfully"

          # Verify ConfigMap content
          echo "Verifying ConfigMap content..."
          kubectl get configmap cluster-gateway-ca -n {{ .Release.Namespace }} -o jsonpath='{.data.ca\.crt}' | head -5

          echo ""
          echo "=== CA Extraction Completed Successfully ==="
{{- end }}
{{- end }}
