{{- if .Values.clusterGateway.enabled }}
{{- if .Values.clusterGateway.tls.enabled }}
---
# Job to create cluster-agent-ca secret from cluster-gateway-ca ConfigMap
# The DataPlane CRD expects a secretRef, but we store the CA in a ConfigMap
# This job creates a Secret with the same CA data for compatibility
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "openchoreo-control-plane.clusterGateway.name" . }}-ca-secret-creator
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-control-plane.labels" . | nindent 4 }}
    app.kubernetes.io/component: cluster-gateway
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "10"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        app.kubernetes.io/component: cluster-gateway-ca-secret-creator
    spec:
      restartPolicy: OnFailure
      serviceAccountName: {{ include "openchoreo-control-plane.clusterGateway.serviceAccountName" . }}
      containers:
      - name: ca-secret-creator
        image: bitnamilegacy/kubectl:1.32.4
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "=== Cluster Gateway CA Secret Creator ==="
          echo "Creating cluster-agent-ca secret from cluster-gateway-ca ConfigMap..."

          # Wait for ConfigMap to be ready with valid CA
          retries=0
          max_retries=60  # 5 minutes

          until kubectl get configmap cluster-gateway-ca -n {{ .Release.Namespace }} -o jsonpath='{.data.ca\.crt}' 2>/dev/null | grep -q "BEGIN CERTIFICATE"; do
            retries=$((retries+1))
            if [ $retries -gt $max_retries ]; then
              echo "ERROR: Timeout waiting for cluster-gateway-ca ConfigMap with valid CA certificate"
              exit 1
            fi
            echo "Waiting for cluster-gateway-ca ConfigMap... ($retries/$max_retries)"
            sleep 5
          done

          echo "✓ ConfigMap found with valid CA certificate"

          # Extract CA from ConfigMap
          CA_CERT=$(kubectl get configmap cluster-gateway-ca -n {{ .Release.Namespace }} -o jsonpath='{.data.ca\.crt}')

          # Create or update the Secret
          echo "Creating/updating cluster-agent-ca secret..."

          # Delete existing secret if it exists (for idempotency)
          kubectl delete secret cluster-agent-ca -n {{ .Release.Namespace }} 2>/dev/null || true

          # Create new secret
          kubectl create secret generic cluster-agent-ca \
            -n {{ .Release.Namespace }} \
            --from-literal=ca.crt="$CA_CERT"

          # Label the secret for easy identification
          kubectl label secret cluster-agent-ca \
            -n {{ .Release.Namespace }} \
            app.kubernetes.io/component=cluster-gateway \
            app.kubernetes.io/managed-by=Helm \
            --overwrite

          echo "✓ cluster-agent-ca secret created successfully"
          echo ""
          echo "=== CA Secret Creation Complete ==="
{{- end }}
{{- end }}
