{{- if .Values.openchoreoApi.enabled }}
{{- /* Computed defaults from helpers */ -}}
{{- $publicUrl := include "openchoreo.apiExternalUrl" . }}
{{- $oidcIssuer := .Values.security.oidc.issuer | default (include "openchoreo.thunderExternalUrl" .) }}
{{- $jwksUrl := .Values.security.oidc.jwksUrl | default (printf "%s/oauth2/jwks" (include "openchoreo.thunderInternalUrl" .)) }}
{{- $authzUrl := .Values.security.oidc.authorizationUrl | default (printf "%s/oauth2/authorize" (include "openchoreo.thunderExternalUrl" .)) }}
{{- $tokenUrl := .Values.security.oidc.tokenUrl | default (printf "%s/oauth2/token" (include "openchoreo.thunderExternalUrl" .)) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "openchoreo-control-plane.openchoreoApi.name" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-control-plane.labels" . | nindent 4 }}
    app.kubernetes.io/component: api-server
data:
  config.yaml: |
    server:
      bind_address: {{ .Values.openchoreoApi.config.server.bind_address | quote }}
      port: {{ .Values.openchoreoApi.config.server.port }}
      public_url: {{ $publicUrl | quote }}
      timeouts:
        {{- toYaml .Values.openchoreoApi.config.server.timeouts | nindent 8 }}
      tls:
        {{- toYaml .Values.openchoreoApi.config.server.tls | nindent 8 }}
      middleware: {}

    security:
      authentication:
        jwt:
          enabled: {{ .Values.security.enabled }}
          audiences:
            {{- if .Values.security.jwt.audience }}
            - {{ .Values.security.jwt.audience | quote }}
            {{- else }}
            []
            {{- end }}
          clock_skew: {{ .Values.openchoreoApi.config.security.authentication.jwt.clock_skew | quote }}
          jwks:
            refresh_interval: {{ .Values.openchoreoApi.config.security.authentication.jwt.jwks.refresh_interval | quote }}
            skip_tls_verify: {{ .Values.openchoreoApi.config.security.authentication.jwt.jwks.skip_tls_verify }}
      subjects:
        {{- toYaml .Values.openchoreoApi.config.security.subjects | nindent 8 }}
      authorization:
        enabled: {{ .Values.security.authz.enabled }}
        cache:
          {{- toYaml .Values.openchoreoApi.config.security.authorization.cache | nindent 10 }}
        resync_interval: {{ .Values.openchoreoApi.config.security.authorization.resync_interval | quote }}

    identity:
      oidc:
        issuer: {{ $oidcIssuer | quote }}
        jwks_url: {{ $jwksUrl | quote }}
        authorization_endpoint: {{ $authzUrl | quote }}
        token_endpoint: {{ $tokenUrl | quote }}
      clients:
        {{- range .Values.security.oidc.externalClients }}
        {{ .name }}:
          client_id: {{ .client_id | quote }}
          scopes:
            {{- toYaml .scopes | nindent 12 }}
        {{- end }}

    mcp:
      enabled: {{ .Values.openchoreoApi.config.mcp.enabled }}
      toolsets:
        {{- toYaml .Values.openchoreoApi.config.mcp.toolsets | nindent 8 }}

    logging:
      {{- toYaml .Values.openchoreoApi.config.logging | nindent 6 }}
{{- end }}
