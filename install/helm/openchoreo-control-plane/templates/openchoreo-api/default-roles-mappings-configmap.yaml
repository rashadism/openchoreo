{{- if and .Values.openchoreoApi.enabled .Values.security.authz.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "openchoreo-control-plane.openchoreoApi.name" . }}-default-roles-mappings
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "openchoreo-control-plane.labels" . | nindent 4 }}
    app.kubernetes.io/component: api-server
data:
  default-roles-mappings.yaml: |
    # Default roles and mappings that can be seeded at installation time

    # Default roles
    roles:
      # Super admin role with full permissions to all resources
      - name: super-admin
        actions:
          - "*"

      # Backstage catalog provider role for reading catalog data from the control plane
      - name: backstage-catalog-reader
        actions:
          - "component:view"
          - "componenttype:view"
          - "organization:view"
          - "project:view"
          - "dataplane:view"
          - "environment:view"

      # Root Cause Analysis (RCA) agent role for troubleshooting and debugging
      - name: rca-agent
        actions:
          - "component:view"
          - "project:view"
          - "organization:view"
          - "componentrelease:view"
          - "releasebinding:view"
          - "componentworkflowrun:view"
          - "environment:view"
          - "logs:view"
          - "metrics:view"
          - "alerts:view"
          - "traces:view"

    # Default entitlement-to-role mappings
    mappings:
      - role_name: super-admin
        entitlement:
          claim: groups
          value: platformEngineer
        effect: allow
      - role_name: backstage-catalog-reader
        entitlement:
          claim: sub
          value: openchoreo-backstage-client
        effect: allow
      - role_name: rca-agent
        entitlement:
          claim: sub
          value: openchoreo-rca-agent
        effect: allow
{{- end }}
