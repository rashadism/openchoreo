{{ if .Values.global.defaultResources.enabled }}
apiVersion: openchoreo.dev/v1alpha1
kind: Trait
metadata:
  name: api-configuration
  namespace: default
spec:
  schema:
    parameters:
      # Developer-facing parameters - static across environments
      apiName: "string"
      apiVersion: "string | default=v1.0"
      context: "string" # API context path (e.g., /greeter-api, /checkout-service)
      upstreamPort: "integer | default=80" # Port on the service to route to
      operations:
        'array<map<string>> | default=[{"method": "GET", "path": "/*"}, {"method": "POST", "path": "/*"}, {"method": "PUT", "path": "/*"}, {"method": "DELETE", "path": "/*"}, {"method": "PATCH", "path": "/*"}, {"method": "OPTIONS", "path": "/*"}]'
        # Array of API operations
        # Example:
        # - method: GET
        #   path: /*
        # - method: POST
        #   path: /orders
      policies:
        "array<map<string>> | default=[]"
        # Array of policies to apply
        # Example:
        # - name: JwtAuthentication
        #   version: v0.1.0
        #   params:
        #     issuers:
        #     - ThunderKeyManager

  creates:
    # Create Backend resource that references the API gateway.
    - template:
        apiVersion: gateway.kgateway.dev/v1alpha1
        kind: Backend
        metadata:
          name: ${metadata.componentName}-api-gw-backend
          namespace: ${metadata.namespace}
        spec:
          type: Static
          static:
            hosts:
              - host: api-platform-default-gateway-router.openchoreo-data-plane
                port: 8080

    # Create RestAPI resource
    - template:
        apiVersion: gateway.api-platform.wso2.com/v1alpha1
        kind: RestApi
        metadata:
          name: ${metadata.name}
          namespace: ${metadata.namespace}
        spec:
          displayName: ${parameters.apiName}
          version: ${parameters.apiVersion}
          context: ${parameters.context}
          upstream:
            main:
              url: http://${metadata.componentName}.${metadata.namespace}:${parameters.upstreamPort}
          policies: ${parameters.policies}
          operations: ${parameters.operations}

  patches:
    # Patch HTTPRoute to route through API Gateway instead of directly to service
    - target:
        group: gateway.networking.k8s.io
        version: v1
        kind: HTTPRoute
      operations:
        # Replace the backendRefs to route through API platform gateway router
        - op: replace
          path: /spec/rules/0/backendRefs/[?(@.name=='${metadata.componentName}')]
          value:
            group: gateway.kgateway.dev
            kind: Backend
            name: ${metadata.componentName}-api-gw-backend

        # Update the URLRewrite filter to rewrite to the API context
        - op: replace
          path: /spec/rules/0/filters/0/urlRewrite/path
          value:
            type: ReplacePrefixMatch
            replacePrefixMatch: ${parameters.context}
{{ end }}
