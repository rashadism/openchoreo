---
# Trait for Alert Rules - reusable across any component type
apiVersion: openchoreo.dev/v1alpha1
kind: Trait
metadata:
  name: observability-alert-rule
  namespace: default
spec:
  schema:
    parameters:
      # Developer-facing parameters - static across environments
      description: "string | description=\"A human-readable description of what this alert rule monitors and when it triggers.\""
      severity: "string | enum=info,warning,critical | default=warning | description=\"The severity level of alerts triggered by this rule. Determines alert priority and notification urgency.\""
      source:
        type: "string | enum=log,metric | description=\"The data source type for the alert rule.\""
        query: "string | default=\"\" | description=\"The query expression for log-based alerts. Required when source type is 'log'.\""
        metric: "string | default=\"\" | description=\"The predefined metric to monitor for metric-based alerts. Must be one of: cpu_usage, memory_usage. Required when source type is 'metric'.\""
      condition:
        window: "string | default=5m | description=\"The time window over which data is aggregated before evaluating the alert condition (e.g. 5m, 10m, 30m, 1h).\""
        interval: "string | default=1m | description=\"The frequency at which the alert rule is evaluated (e.g. 1m, 5m, 15m, 30m).\""
        operator: "string | enum=gt,lt,gte,lte,eq | default=gt | description=\"The comparison operator used to evaluate the condition against the threshold (gt: greater than, lt: less than, gte: greater than or equal, lte: less than or equal, eq: equal).\""
        threshold: "integer | default=10 | description=\"The numeric threshold value used with the operator to determine when the alert triggers.\""

    envOverrides:
      # Platform engineers can override per environment
      enabled: "boolean | default=true | description=\"Controls whether this alert rule is active. When disabled, the rule will not trigger alerts.\""
      enableAiRootCauseAnalysis: "boolean | default=false | description=\"Enables AI-powered root cause analysis for alerts triggered by this rule. When enabled, provides automated reports of root causes for alert conditions.\""
      notificationChannel: "string | default=\"\" | description=\"The notification channel identifier where alerts should be delivered. Configured per environment by platform engineers. If not provided, defaults to the environment's default notification channel.\""

  validations:
    - rule: "${(has(envOverrides.notificationChannel) && envOverrides.notificationChannel != '') || (has(environment.defaultNotificationChannel) && environment.defaultNotificationChannel != '')}"
      message: "A notification channel must be provided either in envOverrides or as the environment default."

  creates:
    - targetPlane: observabilityplane
      includeWhen: ${has(dataplane.observabilityPlaneRef)}
      template:
        apiVersion: openchoreo.dev/v1alpha1
        kind: ObservabilityAlertRule
        metadata:
          name: ${metadata.name}-${trait.instanceName}
          namespace: ${metadata.namespace}
          labels:
            # Required for observability backends. Automatically populated by the controller.
            openchoreo.dev/component-uid: ${metadata.componentUID}
            openchoreo.dev/project-uid: ${metadata.projectUID}
            openchoreo.dev/environment-uid: ${metadata.environmentUID}
        spec:
          name: ${trait.instanceName}
          description: ${parameters.description}
          severity: ${parameters.severity}
          enabled: ${envOverrides.enabled}
          enableAiRootCauseAnalysis: ${envOverrides.enableAiRootCauseAnalysis}
          notificationChannel: >-
            ${has(envOverrides.notificationChannel) && envOverrides.notificationChannel != ""
              ? envOverrides.notificationChannel
              : environment.defaultNotificationChannel}
          source:
            type: ${parameters.source.type}
            query: ${parameters.source.query}
            metric: ${parameters.source.metric}
          condition:
            window: ${parameters.condition.window}
            interval: ${parameters.condition.interval}
            operator: ${parameters.condition.operator}
            threshold: ${parameters.condition.threshold}
