apiVersion: openchoreo.dev/v1alpha1
kind: Trait
metadata:
  name: api-configuration
  namespace: default
spec:
  schema:
    parameters:
      apiName: "string"
      apiVersion: "string | default=v1.0"
      context: "string"
      upstreamPort: "integer | default=80"
      operations:
        'array<map<string>> | default=[{"method": "GET", "path": "/*"}, {"method": "POST", "path": "/*"}, {"method": "PUT", "path": "/*"}, {"method": "DELETE", "path": "/*"}, {"method": "PATCH", "path": "/*"}, {"method": "OPTIONS", "path": "/*"}]'
      policies:
        "array<map<string>> | default=[]"

  creates:
    - template:
        apiVersion: gateway.kgateway.dev/v1alpha1
        kind: Backend
        metadata:
          name: ${metadata.componentName}-api-gw-backend
          namespace: ${metadata.namespace}
        spec:
          type: Static
          static:
            hosts:
              - host: api-platform-default-gateway-router.openchoreo-data-plane
                port: 8080

    - template:
        apiVersion: gateway.api-platform.wso2.com/v1alpha1
        kind: RestApi
        metadata:
          name: ${metadata.name}
          namespace: ${metadata.namespace}
        spec:
          displayName: ${parameters.apiName}
          version: ${parameters.apiVersion}
          context: ${parameters.context}
          upstream:
            main:
              url: http://${metadata.componentName}.${metadata.namespace}:${parameters.upstreamPort}
          policies: ${parameters.policies}
          operations: ${parameters.operations}

  patches:
    - target:
        group: gateway.networking.k8s.io
        version: v1
        kind: HTTPRoute
      operations:
        - op: replace
          path: /spec/rules/0/backendRefs/[?(@.name=='${metadata.componentName}')]
          value:
            group: gateway.kgateway.dev
            kind: Backend
            name: ${metadata.componentName}-api-gw-backend

        - op: replace
          path: /spec/rules/0/filters/0/urlRewrite/path
          value:
            type: ReplacePrefixMatch
            replacePrefixMatch: ${parameters.context}
