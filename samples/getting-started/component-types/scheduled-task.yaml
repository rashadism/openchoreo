apiVersion: openchoreo.dev/v1alpha1
kind: ComponentType
metadata:
  name: scheduled-task
  namespace: default
spec:
  workloadType: cronjob

  allowedWorkflows:
    - google-cloud-buildpacks
    - docker

  allowedTraits: []

  schema:
    types:
      ResourceRequirements:
        requests: "ResourceQuantity | default={}"
        limits: "ResourceQuantity | default={}"
      ResourceQuantity:
        cpu: "string | default=100m"
        memory: "string | default=128Mi"

    parameters:
      successfulJobsHistoryLimit: "integer | default=3"
      failedJobsHistoryLimit: "integer | default=1"
      concurrencyPolicy: "string | default=Forbid"
      backoffLimit: "integer | default=3"
      activeDeadlineSeconds: "integer | default=300"
      restartPolicy: "string | default=OnFailure"

    envOverrides:
      schedule: 'string | default="0 0 31 2 *"'
      resources: "ResourceRequirements | default={}"
      imagePullPolicy: "string | default=IfNotPresent"

  resources:
    - id: cronjob
      template:
        apiVersion: batch/v1
        kind: CronJob
        metadata:
          name: ${metadata.name}
          namespace: ${metadata.namespace}
          labels: ${metadata.labels}
        spec:
          schedule: ${envOverrides.schedule}
          successfulJobsHistoryLimit: ${parameters.successfulJobsHistoryLimit}
          failedJobsHistoryLimit: ${parameters.failedJobsHistoryLimit}
          concurrencyPolicy: ${parameters.concurrencyPolicy}
          jobTemplate:
            metadata:
              labels: ${metadata.labels}
            spec:
              backoffLimit: ${parameters.backoffLimit}
              activeDeadlineSeconds: ${parameters.activeDeadlineSeconds}
              template:
                metadata:
                  labels: ${metadata.podSelectors}
                spec:
                  restartPolicy: ${parameters.restartPolicy}
                  containers:
                    - name: main
                      image: ${workload.container.image}
                      imagePullPolicy: ${envOverrides.imagePullPolicy}
                      command: |
                        ${has(workload.container.command) ? workload.container.command : oc_omit()}
                      args: |
                        ${has(workload.container.args) ? workload.container.args : oc_omit()}
                      resources:
                        requests:
                          cpu: ${envOverrides.resources.requests.cpu}
                          memory: ${envOverrides.resources.requests.memory}
                        limits:
                          cpu: ${envOverrides.resources.limits.cpu}
                          memory: ${envOverrides.resources.limits.memory}
                      envFrom: ${configurations.toContainerEnvFrom()}
                      volumeMounts: ${configurations.toContainerVolumeMounts()}
                  volumes: ${configurations.toVolumes()}

    - id: env-config
      forEach: ${configurations.toConfigEnvsByContainer()}
      var: envConfig
      template:
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: ${envConfig.resourceName}
          namespace: ${metadata.namespace}
        data: |
          ${envConfig.envs.transformMapEntry(index, env, {env.name: env.value})}
    - id: file-config
      forEach: ${configurations.toConfigFileList()}
      var: config
      template:
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: ${config.resourceName}
          namespace: ${metadata.namespace}
        data:
          ${config.name}: |
            ${config.value}
    - id: secret-env-external
      forEach: ${configurations.toSecretEnvsByContainer()}
      var: secretEnv
      template:
        apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: ${secretEnv.resourceName}
          namespace: ${metadata.namespace}
        spec:
          refreshInterval: 15s
          secretStoreRef:
            name: ${dataplane.secretStore}
            kind: ClusterSecretStore
          target:
            name: ${secretEnv.resourceName}
            creationPolicy: Owner
          data: |
            ${secretEnv.envs.map(secret, {
              "secretKey": secret.name,
              "remoteRef": {
                "key": secret.remoteRef.key,
                "property": has(secret.remoteRef.property) ? secret.remoteRef.property : oc_omit()
              }
            })}
    - id: secret-file-external
      forEach: ${configurations.toSecretFileList()}
      var: file
      template:
        apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: ${file.resourceName}
          namespace: ${metadata.namespace}
        spec:
          refreshInterval: 15s
          secretStoreRef:
            name: ${dataplane.secretStore}
            kind: ClusterSecretStore
          target:
            name: ${file.resourceName}
            creationPolicy: Owner
          data:
            - secretKey: ${file.name}
              remoteRef:
                key: ${file.remoteRef.key}
                property: |
                  ${has(file.remoteRef.property) ? file.remoteRef.property : oc_omit()}
