# OpenChoreo Build Plane Workflow Templates
#
# This file is auto-generated by "make workflow-templates-gen". DO NOT EDIT.
#
# Contains the coordinator ClusterWorkflowTemplates (docker, react,
# ballerina-buildpack, google-cloud-buildpacks) and the generate-workload
# template. checkout-source and publish-image are applied separately
# so they can be replaced independently.
#
# Usage:
#   kubectl apply -f .../workflow-templates/checkout-source.yaml
#   kubectl apply -f .../workflow-templates.yaml
#   kubectl apply -f .../workflow-templates/publish-image.yaml

---
apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: generate-workload
spec:
  templates:
    - name: generate-workload-cr
      inputs:
        parameters:
          - name: image
      outputs:
        parameters:
          - name: workload-cr
            valueFrom:
              path: /mnt/vol/workload-cr.yaml
      container:
        image: ghcr.io/openchoreo/podman-runner:v1.0
        command:
          - sh
          - -c
        args:
          - |-
            set -e

            IMAGE={{inputs.parameters.image}}
            PROJECT_NAME={{workflow.parameters.project-name}}
            COMPONENT_NAME={{workflow.parameters.component-name}}
            APP_PATH="{{workflow.parameters.app-path}}"

            DESCRIPTOR_PATH="/mnt/vol/source${APP_PATH:+/${APP_PATH#/}}"

            OUTPUT_PATH="/mnt/vol/workload-cr.yaml"

            echo "Creating workload with image: ${IMAGE}"
            echo "Using descriptor in: ${DESCRIPTOR_PATH}"

            mkdir -p /etc/containers
            cat <<EOF > /etc/containers/storage.conf
            [storage]
            driver = "overlay"
            runroot = "/run/containers/storage"
            graphroot = "/var/lib/containers/storage"
            [storage.options.overlay]
            mount_program = "/usr/bin/fuse-overlayfs"
            EOF

            if [ -f "${DESCRIPTOR_PATH}/workload.yaml" ]; then
              echo "Found workload.yaml descriptor, using it for workload creation"
              podman run --rm --network=none \
              -v $DESCRIPTOR_PATH:/app:rw -w /app \
              ghcr.io/openchoreo/openchoreo-cli:latest-dev \
                workload create \
                --project "${PROJECT_NAME}" \
                --component "${COMPONENT_NAME}" \
                --image "${IMAGE}" \
                --descriptor "workload.yaml" \
                -o "workload-cr.yaml"
            else
              echo "No workload.yaml descriptor found, creating workload without descriptor"
              podman run --rm --network=none \
              -v $DESCRIPTOR_PATH:/app:rw -w /app \
              ghcr.io/openchoreo/openchoreo-cli:latest-dev \
                workload create \
                --project "${PROJECT_NAME}" \
                --component "${COMPONENT_NAME}" \
                --image "${IMAGE}" \
                -o "workload-cr.yaml"
            fi

            cp -f "${DESCRIPTOR_PATH}/workload-cr.yaml" "${OUTPUT_PATH}"
        volumeMounts:
          - name: workspace
            mountPath: /mnt/vol
        securityContext:
          privileged: true

---
apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: docker
spec:
  templates:
    - name: build-image
      inputs:
        parameters:
          - name: git-revision
      container:
        image: ghcr.io/openchoreo/podman-runner:v1.0
        command:
          - sh
          - -c
        args:
          - |-
            set -e

            WORKDIR="/mnt/vol/source"
            IMAGE="{{workflow.parameters.image-name}}:{{workflow.parameters.image-tag}}-{{inputs.parameters.git-revision}}"
            DOCKER_CONTEXT="{{workflow.parameters.docker-context}}"
            DOCKERFILE_PATH="{{workflow.parameters.dockerfile-path}}"

            mkdir -p /etc/containers
            cat > /etc/containers/storage.conf <<EOF
            [storage]
            driver = "overlay"
            runroot = "/run/containers/storage"
            graphroot = "/var/lib/containers/storage"
            [storage.options.overlay]
            mount_program = "/usr/bin/fuse-overlayfs"
            EOF

            podman build -t $IMAGE -f $WORKDIR/$DOCKERFILE_PATH $WORKDIR/$DOCKER_CONTEXT
            podman save -o /mnt/vol/app-image.tar $IMAGE
        securityContext:
          privileged: true
        volumeMounts:
          - mountPath: /mnt/vol
            name: workspace

---
apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: react
spec:
  templates:
    - name: build-image
      inputs:
        parameters:
          - name: git-revision
      container:
        image: ghcr.io/openchoreo/podman-runner:v1.0
        command:
          - sh
          - -c
        args:
          - |-
            set -e

            WORKDIR="/mnt/vol/source"

            IMAGE="{{workflow.parameters.image-name}}:{{workflow.parameters.image-tag}}-{{inputs.parameters.git-revision}}"
            APP_PATH="{{workflow.parameters.app-path}}"
            NODE_VERSION="{{workflow.parameters.node-version}}"

            cd "${WORKDIR}"

            APP_PATH_CLEAN=$(echo "$APP_PATH" | sed 's|^/||')

            if [ -n "$APP_PATH_CLEAN" ] && [ -d "$APP_PATH_CLEAN" ]; then
                SOURCE_DIR="$APP_PATH_CLEAN"
            else
                SOURCE_DIR="."
            fi

            echo "Building from source directory: $SOURCE_DIR"

            cat > "${SOURCE_DIR}/Dockerfile" <<EOF
            FROM node:${NODE_VERSION}-alpine AS builder
            RUN npm install -g pnpm
            WORKDIR /app
            COPY . .
            RUN if [ -f "package-lock.json" ]; then npm ci; \\
                elif [ -f "yarn.lock" ]; then yarn install --frozen-lockfile; \\
                elif [ -f "pnpm-lock.yaml" ]; then pnpm install --frozen-lockfile; \\
                else echo "No lock file found" && exit 1; fi
            RUN npm run build || yarn run build || pnpm run build

            FROM nginx:alpine
            COPY --from=builder /app/default.conf /etc/nginx/conf.d/default.conf
            COPY --from=builder /app/build /usr/share/nginx/html/
            EOF

            cat > "${SOURCE_DIR}/default.conf" <<'EOF'
            server {
              listen 80;
              location / {
                root   /usr/share/nginx/html;
                index  index.html;
                try_files $uri /index.html;
              }
            }
            EOF

            podman build -t "$IMAGE" -f "${SOURCE_DIR}/Dockerfile" "$SOURCE_DIR"
            podman save -o /mnt/vol/app-image.tar "$IMAGE"
        securityContext:
          privileged: true
        volumeMounts:
          - mountPath: /mnt/vol
            name: workspace

---
apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: ballerina-buildpack
spec:
  templates:
    - name: build-image
      inputs:
        parameters:
          - name: git-revision
      container:
        image: ghcr.io/openchoreo/podman-runner:v1.0
        command:
          - sh
          - -c
        args:
          - |-
            set -e

            WORKDIR=/mnt/vol/source

            IMAGE="{{workflow.parameters.image-name}}:{{workflow.parameters.image-tag}}-{{inputs.parameters.git-revision}}"
            APP_PATH="{{workflow.parameters.app-path}}"

            mkdir -p /etc/containers
            cat > /etc/containers/storage.conf <<EOF
            [storage]
            driver = "overlay"
            runroot = "/run/containers/storage"
            graphroot = "/var/lib/containers/storage"
            [storage.options.overlay]
            mount_program = "/usr/bin/fuse-overlayfs"
            EOF

            podman system service --time=0 &
            until podman info --format '{{.Host.RemoteSocket.Exists}}' 2>/dev/null | grep -q true; do sleep 1; done

            BUILDER="ghcr.io/openchoreo/buildpack/ballerina:18"
            RUN_IMAGE="ghcr.io/openchoreo/buildpack/ballerina:18-run"

            /usr/local/bin/pack build "$IMAGE" \
              --builder "$BUILDER" \
              --run-image "$RUN_IMAGE" \
              --docker-host inherit \
              --path "$WORKDIR/$APP_PATH" \
              --volume "/mnt/vol:/app/generated-artifacts:rw" \
              --pull-policy if-not-present

            podman save -o /mnt/vol/app-image.tar "$IMAGE"
        securityContext:
          privileged: true
        volumeMounts:
          - mountPath: /mnt/vol
            name: workspace

---
apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: google-cloud-buildpacks
spec:
  templates:
    - name: build-image
      inputs:
        parameters:
          - name: git-revision
      container:
        image: ghcr.io/openchoreo/podman-runner:v1.0
        command:
          - sh
          - -c
        args:
          - |-
            set -e

            WORKDIR=/mnt/vol/source

            IMAGE="{{workflow.parameters.image-name}}:{{workflow.parameters.image-tag}}-{{inputs.parameters.git-revision}}"
            APP_PATH="{{workflow.parameters.app-path}}"

            mkdir -p /etc/containers
            cat > /etc/containers/storage.conf <<EOF
            [storage]
            driver = "overlay"
            runroot = "/run/containers/storage"
            graphroot = "/var/lib/containers/storage"
            [storage.options.overlay]
            mount_program = "/usr/bin/fuse-overlayfs"
            EOF

            podman system service --time=0 &
            until podman info --format '{{.Host.RemoteSocket.Exists}}' 2>/dev/null | grep -q true; do sleep 1; done

            BUILDER="gcr.io/buildpacks/builder@sha256:5977b4bd47d3e9ff729eefe9eb99d321d4bba7aa3b14986323133f40b622aef1"
            RUN_IMG="gcr.io/buildpacks/google-22/run:latest"

            /usr/local/bin/pack build "$IMAGE" \
              --builder "$BUILDER" \
              --run-image "$RUN_IMG" \
              --docker-host inherit \
              --path "$WORKDIR/$APP_PATH" \
              --pull-policy if-not-present

            podman save -o /mnt/vol/app-image.tar "$IMAGE"
        securityContext:
          privileged: true
        volumeMounts:
          - mountPath: /mnt/vol
            name: workspace
