apiVersion: openchoreo.dev/v1alpha1
kind: ComponentType
metadata:
  name: web-service
  namespace: default
spec:
  workloadType: deployment

  schema:
    parameters:
      replicas: "integer | default=1"
      imagePullPolicy: "string | default=IfNotPresent"

    envOverrides:
      resources:
        $default: {}
        requests:
          $default: {}
          cpu: "string | default=100m"
          memory: "string | default=256Mi"
        limits:
          $default: {}
          cpu: "string | default=1000m"
          memory: "string | default=1Gi"

  resources:
    - id: deployment
      template:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: ${metadata.name}
          namespace: ${metadata.namespace}
          labels: ${metadata.labels}
        spec:
          replicas: ${parameters.replicas}
          selector:
            matchLabels: ${metadata.podSelectors}
          template:
            metadata:
              labels: ${metadata.podSelectors}
            spec:
              containers:
                - name: app
                  image: ${workload.containers["app"].image}
                  imagePullPolicy: ${parameters.imagePullPolicy}
                  ports:
                    - name: http
                      containerPort: ${parameters.port}
                      protocol: TCP
                  resources:
                    requests:
                      cpu: ${envOverrides.resources.requests.cpu}
                      memory: ${envOverrides.resources.requests.memory}
                    limits:
                      cpu: ${envOverrides.resources.limits.cpu}
                      memory: ${envOverrides.resources.limits.memory}

    - id: service
      includeWhen: ${size(workload.endpoints) > 0}
      template:
        apiVersion: v1
        kind: Service
        metadata:
          name: ${metadata.name}
          namespace: ${metadata.namespace}
          labels: ${metadata.labels}
        spec:
          type: ClusterIP
          selector: ${metadata.podSelectors}
          ports: ${workload.endpoints.toServicePorts()}

    - id: httproute
      template:
        apiVersion: gateway.networking.k8s.io/v1
        kind: HTTPRoute
        metadata:
          name: ${metadata.name}
          namespace: ${metadata.namespace}
          labels: ${metadata.labels}
        spec:
          parentRefs:
            - name: gateway-default
              namespace: openchoreo-data-plane
          hostnames:
            - ${metadata.componentNamespace}.${metadata.name}.${dataplane.publicVirtualHost}
          rules:
          - backendRefs:
            - name: ${metadata.name}
              port: 8080
---
apiVersion: openchoreo.dev/v1alpha1
kind: Component
metadata:
  name: demo-app-web-service
  namespace: default
spec:
  owner:
    projectName: default

  autoDeploy: true
  componentType: deployment/web-service

  parameters:
    replicas: 2
---
apiVersion: openchoreo.dev/v1alpha1
kind: Workload
metadata:
  name: demo-app-web-service-workload
  namespace: default
spec:
  owner:
    projectName: default
    componentName: demo-app-web-service

  endpoints:
    http:
      type: HTTP
      port: 8080

  containers:
    app:
      image: "choreoanonymouspullable.azurecr.io/react-spa:v0.9"
      env:
        - key: NODE_ENV
          value: production
        - key: PORT
          value: "8080"

---
apiVersion: openchoreo.dev/v1alpha1
kind: ReleaseBinding
metadata:
  name: demo-app-web-service-development
  namespace: default
spec:
  owner:
    projectName: default
    componentName: demo-app-web-service

  environment: development

  componentTypeEnvOverrides:
    resources:
      requests:
        cpu: "50m"
        memory: "128Mi"
      limits:
        cpu: "200m"
        memory: "256Mi"
