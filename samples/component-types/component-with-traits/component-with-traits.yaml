# Sample: Service Component with Developer-Attached Traits
#
# This sample demonstrates:
# - Using the default deployment/service ComponentType with custom traits
# - persistent-volume trait: Creates PVCs and mounts them to containers
# - emptydir-volume trait: Creates emptyDir volumes with multi-container mount support
# - Environment-specific trait overrides via ReleaseBinding

---
# Persistent Volume Trait - creates PVC and mounts to specified container
apiVersion: openchoreo.dev/v1alpha1
kind: Trait
metadata:
  name: persistent-volume
  namespace: default
spec:
  schema:
    parameters:
      volumeName: "string"
      mountPath: "string"
      containerName: "string | default=main"

    envOverrides:
      size: "string | default=10Gi"
      storageClass: "string | default=local-path"

  creates:
    - template:
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: ${metadata.name}-${trait.instanceName}
          namespace: ${metadata.namespace}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: ${envOverrides.size}
          storageClassName: ${envOverrides.storageClass}

  patches:
    - target:
        group: apps
        version: v1
        kind: Deployment
      operations:
        - op: add
          path: /spec/template/spec/volumes/-
          value:
            name: ${parameters.volumeName}
            persistentVolumeClaim:
              claimName: ${metadata.name}-${trait.instanceName}

    - target:
        group: apps
        version: v1
        kind: Deployment
      operations:
        - op: add
          path: /spec/template/spec/containers/[?(@.name=='${parameters.containerName}')]/volumeMounts/-
          value:
            name: ${parameters.volumeName}
            mountPath: ${parameters.mountPath}

---
# EmptyDir Volume Trait - creates emptyDir volumes with support for multiple container mounts
apiVersion: openchoreo.dev/v1alpha1
kind: Trait
metadata:
  name: emptydir-volume
spec:
  schema:
    # Define custom type for mount configuration
    types:
      MountConfig:
        containerName: "string"
        mountPath: "string"
        readOnly: "boolean | default=false"
        subPath: 'string | default=""'

    parameters:
      volumeName: "string"
      mounts: "[]MountConfig | minItems=1"

    envOverrides:
      sizeLimit: 'string | default=""'
      medium: 'string | default=""' # "" for disk, "Memory" for tmpfs

  # Patch the Deployment to add emptyDir volume
  patches:
    # Add emptyDir volume to pod spec
    - target:
        group: apps
        version: v1
        kind: Deployment
      operations:
        - op: add
          path: /spec/template/spec/volumes/-
          value:
            name: ${parameters.volumeName}
            emptyDir: |
              ${envOverrides.sizeLimit != "" || envOverrides.medium != "" ? {
                "sizeLimit": envOverrides.sizeLimit != "" ? envOverrides.sizeLimit : oc_omit(),
                "medium": envOverrides.medium != "" ? envOverrides.medium : oc_omit()
              } : {}}

    # Add volumeMounts to each specified container
    # This will be applied per mount in the mounts array
    - forEach: ${parameters.mounts}
      var: mount
      target:
        group: apps
        version: v1
        kind: Deployment
      operations:
        - op: add
          path: /spec/template/spec/containers/[?(@.name=='${mount.containerName}')]/volumeMounts/-
          value:
            name: ${parameters.volumeName}
            mountPath: ${mount.mountPath}
            readOnly: |
              ${has(mount.readOnly) ? mount.readOnly : false}
            subPath: |
              ${has(mount.subPath) ? mount.subPath : ""}

---
# Component using the default deployment/service ComponentType with developer-attached traits
apiVersion: openchoreo.dev/v1alpha1
kind: Component
metadata:
  name: demo-app-with-traits
  namespace: default
spec:
  owner:
    projectName: default

  componentType: deployment/service
  autoDeploy: true

  traits:
    - name: persistent-volume
      instanceName: data-storage
      parameters:
        volumeName: app-data
        mountPath: /var/data
        containerName: main
    - name: emptydir-volume
      instanceName: cache
      parameters:
        volumeName: cache-vol
        mounts:
          - containerName: main
            mountPath: /tmp/cache
            readOnly: false
    - name: emptydir-volume
      instanceName: workspace
      parameters:
        volumeName: workspace-vol
        mounts:
          - containerName: main
            mountPath: /tmp/work
            readOnly: false

---
apiVersion: openchoreo.dev/v1alpha1
kind: Workload
metadata:
  name: demo-app-with-traits-workload
  namespace: default
spec:
  owner:
    projectName: default
    componentName: demo-app-with-traits

  endpoints:
    http:
      type: HTTP
      port: 8080

  containers:
    main:
      image: "nginx:1.25-alpine"

---
apiVersion: openchoreo.dev/v1alpha1
kind: ReleaseBinding
metadata:
  name: demo-app-with-traits-development
  namespace: default
spec:
  owner:
    projectName: default
    componentName: demo-app-with-traits

  environment: development

  componentTypeEnvOverrides:
    replicas: 1
    resources:
      requests:
        cpu: "50m"
        memory: "128Mi"
      limits:
        cpu: "200m"
        memory: "256Mi"

  traitOverrides:
    data-storage:
      size: "5Gi"
      storageClass: "local-path"
    workspace:
      sizeLimit: "1Gi"
