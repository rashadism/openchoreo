# Copyright 2025 The OpenChoreo Authors
# SPDX-License-Identifier: Apache-2.0
#
# This sample demonstrates how to use the api-configuration trait with the default service component type
# to add API management capabilities to HTTP services.
#
# Key concepts:
# 1. Uses the default deployment/service ComponentType
# 2. Adds API management via the api-configuration trait
# 3. Trait patches the HTTPRoute to route through API Platform Gateway
# 4. Supports JWT authentication and other API policies

---
# API Configuration Trait - adds API management capabilities to services
apiVersion: openchoreo.dev/v1alpha1
kind: Trait
metadata:
  name: api-configuration
  namespace: default
spec:
  schema:
    parameters:
      apiName: "string"
      apiVersion: "string | default=v1.0"
      context: "string"
      upstreamPort: "integer | default=80"
      operations:
        'array<map<string>> | default=[{"method": "GET", "path": "/*"}, {"method": "POST", "path": "/*"}, {"method": "PUT", "path": "/*"}, {"method": "DELETE", "path": "/*"}, {"method": "PATCH", "path": "/*"}, {"method": "OPTIONS", "path": "/*"}]'
      policies:
        "array<map<string>> | default=[]"

  creates:
    # Backend resource to route through API Platform Gateway
    - template:
        apiVersion: gateway.kgateway.dev/v1alpha1
        kind: Backend
        metadata:
          name: ${metadata.componentName}-api-gw-backend
          namespace: ${metadata.namespace}
        spec:
          type: Static
          static:
            hosts:
              - host: api-platform-default-gateway-router.openchoreo-data-plane
                port: 8080

    # RestApi resource that configures the API in API Platform
    - template:
        apiVersion: gateway.api-platform.wso2.com/v1alpha1
        kind: RestApi
        metadata:
          name: ${metadata.name}
          namespace: ${metadata.namespace}
        spec:
          displayName: ${parameters.apiName}
          version: ${parameters.apiVersion}
          context: ${parameters.context}
          upstream:
            main:
              url: http://${metadata.componentName}.${metadata.namespace}:${parameters.upstreamPort}
          policies: ${parameters.policies}
          operations: ${parameters.operations}

  patches:
    # Patch the HTTPRoute to route through API Platform Gateway instead of directly to service
    - target:
        group: gateway.networking.k8s.io
        version: v1
        kind: HTTPRoute
      operations:
        - op: replace
          path: /spec/rules/0/backendRefs/[?(@.name=='${metadata.componentName}')]
          value:
            group: gateway.kgateway.dev
            kind: Backend
            name: ${metadata.componentName}-api-gw-backend

        - op: replace
          path: /spec/rules/0/filters/0/urlRewrite/path
          value:
            type: ReplacePrefixMatch
            replacePrefixMatch: ${parameters.context}

---
# Component using the default deployment/service ComponentType with api-configuration trait
apiVersion: openchoreo.dev/v1alpha1
kind: Component
metadata:
  name: demo-app-http-service
  namespace: default
spec:
  owner:
    projectName: default
  autoDeploy: true
  componentType: deployment/service

  parameters:
    # Enable HTTPRoute creation (required for api-configuration trait to patch it)
    exposed: true

  # Traits - API Configuration is added as a trait
  traits:
    - name: api-configuration
      instanceName: greeter-api
      parameters:
        apiName: greeter-api
        apiVersion: v1.0
        context: /greeter-api/v1.0
        upstreamPort: 9090
        policies:
          - name: JwtAuthentication
            version: v0.1.0

---
apiVersion: openchoreo.dev/v1alpha1
kind: Workload
metadata:
  name: demo-app-http-service-workload
  namespace: default
spec:
  owner:
    projectName: default
    componentName: demo-app-http-service

  endpoints:
    http:
      type: HTTP
      port: 9090

  containers:
    main:
      image: "ghcr.io/openchoreo/samples/greeter-service:latest"
      args:
        - --port
        - "9090"

---
apiVersion: openchoreo.dev/v1alpha1
kind: ReleaseBinding
metadata:
  name: demo-app-http-service-development
  namespace: default
spec:
  owner:
    projectName: default
    componentName: demo-app-http-service

  environment: development

  # Override ComponentType envOverrides for this environment
  componentTypeEnvOverrides:
    replicas: 2
    resources:
      requests:
        cpu: "50m"
        memory: "128Mi"
      limits:
        cpu: "200m"
        memory: "256Mi"

  # Override trait envOverrides for this environment (keyed by instanceName)
  traitOverrides:
    greeter-api:  # instanceName from the trait
      gatewayRefs:
        - name: api-platform-default
          namespace: openchoreo-data-plane
