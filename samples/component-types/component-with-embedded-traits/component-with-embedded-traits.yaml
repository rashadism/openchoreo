# Copyright 2025 The OpenChoreo Authors
# SPDX-License-Identifier: Apache-2.0
#
# This sample demonstrates PE-defined embedded traits in ComponentTypes.
#
# Key concepts:
# 1. Embedded traits (spec.traits) are pre-configured by the PE in the ComponentType
# 2. PE can lock values (concrete) or wire them via CEL expressions
# 3. Developers configure through ComponentType schema - they don't need to know about the underlying trait
# 4. Embedded trait parameters demonstrate three patterns:
#    - Locked: `targetCPUUtilizationPercentage: 75` - PE enforces a fixed value (platform policy)
#    - Developer-configurable: Developers set replica bounds (minReplicas, maxReplicas) via parameters
#    - Environment-tunable: Platform teams can override replica bounds per environment via componentTypeEnvOverrides
# 5. Environment-specific tuning via componentTypeEnvOverrides (for embedded traits) or traitOverrides (for developer traits)

---
# HorizontalPodAutoscaler Trait - demonstrates developer-configurable parameters with PE overrides
apiVersion: openchoreo.dev/v1alpha1
kind: Trait
metadata:
  name: horizontal-pod-autoscaler
  namespace: default
spec:
  schema:
    parameters:
      enabled: "boolean | default=false"
      minReplicas: "integer | default=2 | minimum=1"
      maxReplicas: "integer | default=10 | minimum=1"
      targetCPUUtilizationPercentage: "integer | default=80 | minimum=1 | maximum=100"

    envOverrides:
      minReplicas: "integer | minimum=1"
      maxReplicas: "integer | minimum=1"

  creates:
    - includeWhen: ${parameters.enabled}
      template:
        apiVersion: autoscaling/v2
        kind: HorizontalPodAutoscaler
        metadata:
          name: ${metadata.name}
          namespace: ${metadata.namespace}
          labels: ${metadata.labels}
        spec:
          scaleTargetRef:
            apiVersion: apps/v1
            kind: Deployment
            name: ${metadata.name}
          minReplicas: |
            ${has(envOverrides.minReplicas) ? envOverrides.minReplicas : parameters.minReplicas}
          maxReplicas: |
            ${has(envOverrides.maxReplicas) ? envOverrides.maxReplicas : parameters.maxReplicas}
          metrics:
            - type: Resource
              resource:
                name: cpu
                target:
                  type: Utilization
                  averageUtilization: ${parameters.targetCPUUtilizationPercentage}

---
# Persistent Volume Trait - reused from component-with-traits sample
apiVersion: openchoreo.dev/v1alpha1
kind: Trait
metadata:
  name: persistent-volume
  namespace: default
spec:
  schema:
    parameters:
      volumeName: "string"
      mountPath: "string"
      containerName: "string | default=main"

    envOverrides:
      size: "string | default=10Gi"
      storageClass: "string | default=local-path"

  creates:
    - template:
        apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: ${metadata.name}-${trait.instanceName}
          namespace: ${metadata.namespace}
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: ${envOverrides.size}
          storageClassName: ${envOverrides.storageClass}

  patches:
    - target:
        group: apps
        version: v1
        kind: Deployment
      operations:
        - op: add
          path: /spec/template/spec/volumes/-
          value:
            name: ${parameters.volumeName}
            persistentVolumeClaim:
              claimName: ${metadata.name}-${trait.instanceName}

    - target:
        group: apps
        version: v1
        kind: Deployment
      operations:
        - op: add
          path: /spec/template/spec/containers/[?(@.name=='${parameters.containerName}')]/volumeMounts/-
          value:
            name: ${parameters.volumeName}
            mountPath: ${parameters.mountPath}

---
# ComponentType extending the default service type structure with embedded HPA trait
# The PE exposes autoscaling parameters through ComponentType schema, wired to the embedded HPA trait
apiVersion: openchoreo.dev/v1alpha1
kind: ComponentType
metadata:
  name: service-with-autoscaling
  namespace: default
spec:
  workloadType: deployment

  allowedWorkflows:
    - google-cloud-buildpacks
    - ballerina-buildpack
    - docker

  allowedTraits:
    - api-configuration
    - observability-alert-rule
    - persistent-volume

  validations:
    - rule: "${size(workload.endpoints) > 0}"
      message: "Service components must have at least one endpoint. Use 'deployment/worker' for components without endpoints."

  schema:
    types:
      ResourceRequirements:
        requests: "ResourceQuantity | default={}"
        limits: "ResourceQuantity | default={}"
      ResourceQuantity:
        cpu: "string | default=100m"
        memory: "string | default=256Mi"

    parameters:
      exposed: "boolean | default=true"
      # Autoscaling parameters - wired to embedded HPA trait
      # Developers can configure min/max replicas; CPU threshold is locked by PE
      autoscaling:
        enabled: "boolean | default=false"
        minReplicas: "integer | default=2 | minimum=1"
        maxReplicas: "integer | default=10 | minimum=1"

    envOverrides:
      replicas: "integer | default=1"
      resources: "ResourceRequirements | default={}"
      imagePullPolicy: "string | default=IfNotPresent"
      # Environment-specific autoscaling overrides - allows tuning replica bounds per environment
      # Note: targetCPUUtilizationPercentage is locked by PE at 75%, not overridable
      autoscaling:
        minReplicas: "integer | minimum=1"
        maxReplicas: "integer | minimum=1"

  # Embedded traits - automatically applied to all Components of this type
  traits:
    - name: horizontal-pod-autoscaler
      instanceName: autoscaler
      # Wire ComponentType parameters to trait parameters (mix of locked and wired values)
      parameters:
        enabled: ${parameters.autoscaling.enabled}
        minReplicas: ${parameters.autoscaling.minReplicas}
        maxReplicas: ${parameters.autoscaling.maxReplicas}
        # Locked: PE enforces CPU threshold at 75% (not configurable by developers)
        targetCPUUtilizationPercentage: 75
      # Wire environment-specific overrides (only for replica counts)
      envOverrides:
        minReplicas: ${envOverrides.autoscaling.minReplicas}
        maxReplicas: ${envOverrides.autoscaling.maxReplicas}

  resources:
    - id: deployment
      template:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: ${metadata.name}
          namespace: ${metadata.namespace}
          labels: ${metadata.labels}
        spec:
          replicas: ${envOverrides.replicas}
          selector:
            matchLabels: ${metadata.podSelectors}
          template:
            metadata:
              labels: ${metadata.podSelectors}
            spec:
              containers:
                - name: main
                  image: ${workload.containers["main"].image}
                  imagePullPolicy: ${envOverrides.imagePullPolicy}
                  command: |
                    ${has(workload.containers["main"].command) ? workload.containers["main"].command : oc_omit()}
                  args: |
                    ${has(workload.containers["main"].args) ? workload.containers["main"].args : oc_omit()}
                  resources:
                    requests:
                      cpu: ${envOverrides.resources.requests.cpu}
                      memory: ${envOverrides.resources.requests.memory}
                    limits:
                      cpu: ${envOverrides.resources.limits.cpu}
                      memory: ${envOverrides.resources.limits.memory}
                  envFrom: ${configurations.toContainerEnvFrom("main")}
                  volumeMounts: ${configurations.toContainerVolumeMounts("main")}
              volumes: ${configurations.toVolumes()}

    - id: service
      includeWhen: ${size(workload.endpoints) > 0}
      template:
        apiVersion: v1
        kind: Service
        metadata:
          name: ${metadata.componentName}
          namespace: ${metadata.namespace}
          labels: ${metadata.labels}
        spec:
          type: ClusterIP
          selector: ${metadata.podSelectors}
          ports: ${workload.toServicePorts()}
    - id: httproute
      includeWhen: ${parameters.exposed == true}
      template:
        apiVersion: gateway.networking.k8s.io/v1
        kind: HTTPRoute
        metadata:
          name: ${metadata.name}
          namespace: ${metadata.namespace}
          labels: ${metadata.labels}
        spec:
          parentRefs:
            - name: gateway-default
              namespace: openchoreo-data-plane
          hostnames:
            - ${metadata.environmentName}-${metadata.componentNamespace}.${dataplane.publicVirtualHost}
          rules:
          - matches:
            - path:
                type: PathPrefix
                value: /${metadata.componentName}
            filters:
              - type: URLRewrite
                urlRewrite:
                  path:
                    type: ReplacePrefixMatch
                    replacePrefixMatch: /
            backendRefs:
            - name: ${metadata.componentName}
              port: ${workload.toServicePorts()[0].port}
    - id: env-config
      forEach: ${configurations.toConfigEnvsByContainer()}
      var: envConfig
      template:
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: ${envConfig.resourceName}
          namespace: ${metadata.namespace}
        data: |
          ${envConfig.envs.transformMapEntry(index, env, {env.name: env.value})}
    - id: file-config
      forEach: ${configurations.toConfigFileList()}
      var: config
      template:
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: ${config.resourceName}
          namespace: ${metadata.namespace}
        data:
          ${config.name}: |
            ${config.value}
    - id: secret-env-external
      forEach: ${configurations.toSecretEnvsByContainer()}
      var: secretEnv
      template:
        apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: ${secretEnv.resourceName}
          namespace: ${metadata.namespace}
        spec:
          refreshInterval: 15s
          secretStoreRef:
            name: ${dataplane.secretStore}
            kind: ClusterSecretStore
          target:
            name: ${secretEnv.resourceName}
            creationPolicy: Owner
          data: |
            ${secretEnv.envs.map(secret, {
              "secretKey": secret.name,
              "remoteRef": {
                "key": secret.remoteRef.key,
                "property": has(secret.remoteRef.property) ? secret.remoteRef.property : oc_omit()
              }
            })}
    - id: secret-file-external
      forEach: ${configurations.toSecretFileList()}
      var: file
      template:
        apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: ${file.resourceName}
          namespace: ${metadata.namespace}
        spec:
          refreshInterval: 15s
          secretStoreRef:
            name: ${dataplane.secretStore}
            kind: ClusterSecretStore
          target:
            name: ${file.resourceName}
            creationPolicy: Owner
          data:
            - secretKey: ${file.name}
              remoteRef:
                key: ${file.remoteRef.key}
                property: |
                  ${has(file.remoteRef.property) ? file.remoteRef.property : oc_omit()}

---
# Component using the ComponentType with embedded traits
# Developer configures autoscaling through ComponentType parameters
# The HPA trait is automatically applied - developer doesn't configure it directly
apiVersion: openchoreo.dev/v1alpha1
kind: Component
metadata:
  name: demo-app-with-embedded-traits
  namespace: default
spec:
  owner:
    projectName: default

  componentType: deployment/service-with-autoscaling
  autoDeploy: true

  parameters:
    # Configure autoscaling - this activates the embedded HPA trait
    # Note: targetCPUUtilizationPercentage is locked by PE at 75%
    autoscaling:
      enabled: true
      minReplicas: 2
      maxReplicas: 10

  # Developer can add allowed traits (but NOT HPA - it's embedded)
  traits:
    - name: persistent-volume
      instanceName: data-storage
      parameters:
        volumeName: app-data
        mountPath: /var/data
        containerName: main

---
# Workload provides the container image
apiVersion: openchoreo.dev/v1alpha1
kind: Workload
metadata:
  name: demo-app-with-embedded-traits-workload
  namespace: default
spec:
  owner:
    projectName: default
    componentName: demo-app-with-embedded-traits

  endpoints:
    http:
      type: HTTP
      port: 9090
      visibility: external

  containers:
    main:
      image: "ghcr.io/openchoreo/samples/greeter-service:latest"
      args:
        - --port
        - "9090"

---
# ReleaseBinding for development environment
# Platform admin can override disruption budget per environment
apiVersion: openchoreo.dev/v1alpha1
kind: ReleaseBinding
metadata:
  name: demo-app-with-embedded-traits-development
  namespace: default
spec:
  owner:
    projectName: default
    componentName: demo-app-with-embedded-traits

  environment: development

  componentTypeEnvOverrides:
    replicas: 3
    resources:
      requests:
        cpu: "50m"
        memory: "128Mi"
      limits:
        cpu: "200m"
        memory: "256Mi"
    # Override autoscaling replica bounds for dev environment
    # Note: targetCPUUtilizationPercentage is locked by PE, cannot be overridden
    autoscaling:
      minReplicas: 1
      maxReplicas: 5

  traitOverrides:
    # Override persistent volume size for dev
    data-storage:
      size: "10Mi"
      storageClass: "local-path"
