apiVersion: openchoreo.dev/v1alpha1
kind: Workflow
metadata:
  name: docker
  namespace: default
  annotations:
    openchoreo.dev/description: "Docker build workflow for containerized applications using Dockerfile"
    openchoreo.dev/component-workflow-parameters: |
      repoUrl: parameters.repository.url
      branch: parameters.repository.revision.branch
      appPath: parameters.repository.appPath
      secretRef: parameters.repository.secretRef
      projectName: parameters.scope.projectName
      componentName: parameters.scope.componentName
spec:
  # Template Variable Reference (processed by WorkflowRun controller):
  # ${metadata.workflowRunName}              - Generated name for this workflow run instance
  # ${metadata.namespaceName}                - Organization namespace where the component resides
  # ${metadata.namespace}                    - Full namespace path (e.g., openchoreo-ci-${metadata.namespaceName})
  # ${parameters.repository.*}              - Repository parameters (url, revision, appPath, secretRef)
  # ${parameters.*}                          - Custom developer parameters defined in schema
  # ${secretRef.*}                           - Secret reference details when parameters.repository.secretRef is provided

  # Time-to-live for completed workflow runs - Automatically cleans up workflow resources after the specified duration
  # Format is a duration string without spaces (e.g., "1d" for 1 day, "12h" for 12 hours, "10d12h30m" for 10 days, 12 hours, and 30 minutes)
  ttlAfterCompletion: "1d"

  # Schema definition for workflow parameters
  # Defines the contract between platform engineers (who create workflows) and developers (who use them)
  schema:
    parameters:
      # Scope parameters
      scope:
        projectName: string | description="Name of the project"
        componentName: string | description="Name of the component"
      # Repository parameters - structured parameters for build automation
      repository:
        url: string | description="Git repository URL"
        secretRef: string | description="Secret reference name for private repository Git credentials (optional for public repos)"
        revision:
          branch: string | default=main description="Git branch to checkout"
          commit: string | description="Git commit SHA or reference (optional, defaults to latest commit on branch)"
        appPath: string | default=. description="Path to the application directory within the repository"

      # Developer-configurable parameters - Custom parameters defined by Platform Engineers
      # These allow developers to customize the build process within PE-defined constraints
      docker:
        context: string | default=. description="Docker build context path relative to the repository root"
        filePath: string | default=./Dockerfile description="Path to the Dockerfile relative to the repository root"

  # Workflow template that gets instantiated for each WorkflowRun
  # This generates an Argo Workflow resource in the build plane cluster
  runTemplate:
    apiVersion: argoproj.io/v1alpha1
    kind: Workflow
    metadata:
      name: ${metadata.workflowRunName}
      namespace: openchoreo-ci-${metadata.namespaceName}
    spec:
      arguments:
        parameters:
          - name: component-name
            value: ${parameters.scope.componentName}
          - name: project-name
            value: ${parameters.scope.projectName}
          # Parameters from repository (developer-facing)
          - name: git-repo
            value: ${parameters.repository.url}
          - name: branch
            value: ${parameters.repository.revision.branch}
          - name: commit
            value: ${parameters.repository.revision.commit}
          - name: app-path
            value: ${parameters.repository.appPath}
          # Parameters from parameters (developer-facing)
          - name: docker-context
            value: ${parameters.docker.context}
          - name: dockerfile-path
            value: ${parameters.docker.filePath}
          # PE-controlled hardcoded parameters
          - name: registry-url
            value: gcr.io/openchoreo-dev/images
          - name: build-timeout
            value: "30m"
          - name: image-name
            value: ${parameters.scope.projectName}-${parameters.scope.componentName}-image
          - name: image-tag
            value: v1
          - name: git-secret
            value: ${metadata.workflowRunName}-git-secret
          - name: registry-push-secret
            value: ${metadata.workflowRunName}-registry-push-secret
      serviceAccountName: workflow-sa
      workflowTemplateRef:
        clusterScope: true
        name: docker

  # Additional Kubernetes resources created alongside the workflow
  # These resources are deployed to the build plane namespace before the workflow executes
  resources:
    # Git credentials secret - Only created when secretRef is provided (for private repositories)
    # Uses External Secrets Operator to fetch credentials from the secret store (OpenBao)
    - id: git-secret
      includeWhen: ${has(parameters.repository.secretRef) && parameters.repository.secretRef != ""}
      template:
        apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: ${metadata.workflowRunName}-git-secret
          namespace: ${metadata.namespace}
        spec:
          refreshInterval: 15s
          secretStoreRef:
            kind: ClusterSecretStore
            name: default
          target:
            name: ${metadata.workflowRunName}-git-secret
            creationPolicy: Owner
            template:
              type: ${secretRef.type}
          # CEL expression that dynamically maps secretRef.data array in Secret Reference CR
          # Uses oc_omit() to exclude empty property fields from the final manifest
          data: |
            ${secretRef.data.map(secret, {
              "secretKey": secret.secretKey,
              "remoteRef": {
                "key": secret.remoteRef.key,
                "property": has(secret.remoteRef.property) && secret.remoteRef.property != "" ? secret.remoteRef.property : oc_omit()
              }
            })}

    # Container registry push credentials - Always created
    # Used to authenticate and push the built Docker image to the container registry
    - id: registry-push-secret
      template:
        apiVersion: external-secrets.io/v1
        kind: ExternalSecret
        metadata:
          name: ${metadata.workflowRunName}-registry-push-secret
          namespace: ${metadata.namespace}
        spec:
          refreshInterval: 15s
          secretStoreRef:
            name: default
            kind: ClusterSecretStore
          target:
            name: ${metadata.workflowRunName}-registry-push-secret
            creationPolicy: Owner
            template:
              type: kubernetes.io/dockerconfigjson
              data:
                .dockerconfigjson: "{{ .registrysecret | toString }}"
          data:
            - secretKey: registrysecret
              remoteRef:
                key: registry-push-secret
