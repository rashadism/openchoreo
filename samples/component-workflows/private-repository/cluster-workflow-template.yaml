apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: google-cloud-buildpacks-private-repo
spec:
  entrypoint: build-workflow
  templates:
    - name: build-workflow
      steps:
        - - name: clone-step
            template: clone-step
        - - name: build-step
            template: build-step
            arguments:
              parameters:
                - name: git-revision
                  value: '{{steps.clone-step.outputs.parameters.git-revision}}'
        - - name: push-step
            template: push-step
            arguments:
              parameters:
                - name: git-revision
                  value: '{{steps.clone-step.outputs.parameters.git-revision}}'
        - - name: workload-create-step
            template: workload-create-step
            arguments:
              parameters:
                - name: image
                  value: '{{steps.push-step.outputs.parameters.image}}'
    - name: clone-step
      outputs:
        parameters:
          - name: git-revision
            valueFrom:
              path: /tmp/git-revision.txt
      volumes:
        - name: git-secret
          secret:
            secretName: git-clone-secret
      container:
        command:
          - sh
          - -c
        image: alpine/git
        volumeMounts:
          - mountPath: /mnt/vol
            name: workspace
          - mountPath: /etc/secrets/git-secret
            name: git-secret
            readOnly: true
        args:
          - |-
            set -e

            BRANCH={{workflow.parameters.branch}}
            REPO={{workflow.parameters.git-repo}}
            COMMIT={{workflow.parameters.commit}}
            
            TOKEN_FILE="/etc/secrets/git-secret/clone-secret"
            TOKEN=""
            if [ -f "$TOKEN_FILE" ]; then
              TOKEN="$(cat "$TOKEN_FILE")"
            fi
            
            AUTH_REPO="$REPO"
            if [ -n "$TOKEN" ]; then
              case "$REPO" in
                https://github.com/*)
                  REPO_PATH="${REPO#https://github.com/}"
                  AUTH_REPO="https://x-access-token:${TOKEN}@github.com/${REPO_PATH}"
                  ;;
                git@github.com:*)
                  REPO_PATH="${REPO#git@github.com:}"
                  AUTH_REPO="https://x-access-token:${TOKEN}@github.com/${REPO_PATH}"
                  ;;
              esac
            fi
            
            if [[ -n "$COMMIT" ]]; then
                echo "Cloning specific commit: $COMMIT"
                git clone --no-checkout --depth 1 "$AUTH_REPO" /mnt/vol/source
                cd /mnt/vol/source
                git config --global advice.detachedHead false
                git fetch --depth 1 origin "$COMMIT"
                git checkout "$COMMIT"
                echo -n "$COMMIT" | cut -c1-8 > /tmp/git-revision.txt
            else
                echo "Cloning branch: $BRANCH with latest commit"
                git clone --single-branch --branch $BRANCH --depth 1 "$AUTH_REPO" /mnt/vol/source
                cd /mnt/vol/source
                COMMIT_SHA=$(git rev-parse HEAD)
                echo -n "$COMMIT_SHA" | cut -c1-8 > /tmp/git-revision.txt
            fi
    - name: build-step
      inputs:
        parameters:
          - name: git-revision
      container:
        args:
          - |-
            set -e

            WORKDIR=/mnt/vol/source

            IMAGE="{{workflow.parameters.image-name}}:{{workflow.parameters.image-tag}}-{{inputs.parameters.git-revision}}"
            APP_PATH="{{workflow.parameters.app-path}}"

            #####################################################################
            # 1. Podman daemon + storage.conf
            #####################################################################
            mkdir -p /etc/containers
            cat > /etc/containers/storage.conf <<EOF
            [storage]
            driver = "overlay"
            runroot = "/run/containers/storage"
            graphroot = "/var/lib/containers/storage"
            [storage.options.overlay]
            mount_program = "/usr/bin/fuse-overlayfs"
            EOF

            podman system service --time=0 &
            until podman info --format '{{.Host.RemoteSocket.Exists}}' 2>/dev/null | grep -q true; do sleep 1; done

            #####################################################################
            # 2. Registry configuration and pull pre-cached images
            #####################################################################
            REGISTRY_ENDPOINT="registry.openchoreo-build-plane.svc.cluster.local:5000"

            # Pull pre-cached buildpack images from registry
            BUILDER="${REGISTRY_ENDPOINT}/buildpacks-cache/google-builder:latest"
            RUN_IMG="${REGISTRY_ENDPOINT}/buildpacks-cache/google-run:latest"
            LIFECYCLE_IMG="${REGISTRY_ENDPOINT}/buildpacks-cache/lifecycle:0.20.5"

            echo "Pulling cached builder: $BUILDER"
            podman pull --tls-verify=false "$BUILDER"

            echo "Pulling cached run image: $RUN_IMG"
            podman pull --tls-verify=false "$RUN_IMG"

            echo "Pulling cached lifecycle: $LIFECYCLE_IMG"
            podman pull --tls-verify=false "$LIFECYCLE_IMG"

            # Tag lifecycle image to expected name (referenced by builder image metadata)
            podman tag "$LIFECYCLE_IMG" "docker.io/buildpacksio/lifecycle:0.20.5"

            #####################################################################
            # 3. Build with Google Buildpacks
            #####################################################################
            /usr/local/bin/pack build "$IMAGE" \
              --builder "$BUILDER" \
              --run-image "$RUN_IMG" \
              --docker-host inherit \
              --path "$WORKDIR/$APP_PATH" \
              --pull-policy if-not-present

            podman save -o /mnt/vol/app-image.tar "$IMAGE"
        command:
          - sh
          - -c
        image: ghcr.io/openchoreo/podman-runner:v1.0
        securityContext:
          privileged: true
        volumeMounts:
          - mountPath: /mnt/vol
            name: workspace
    - name: push-step
      inputs:
        parameters:
          - name: git-revision
      outputs:
        parameters:
          - name: image
            valueFrom:
              path: /tmp/image.txt
      container:
        args:
          - |-
            set -e

            #####################################################################
            # 1. Inputs
            #####################################################################
            GIT_REVISION={{inputs.parameters.git-revision}}
            IMAGE_NAME={{workflow.parameters.image-name}}
            IMAGE_TAG={{workflow.parameters.image-tag}}
            SRC_IMAGE="${IMAGE_NAME}:${IMAGE_TAG}-${GIT_REVISION}"

            #####################################################################
            # 2. Registry
            #####################################################################
            REGISTRY_ENDPOINT="registry.openchoreo-build-plane.svc.cluster.local:5000"

            #####################################################################
            # 3. Podman storage configuration
            #####################################################################
            mkdir -p /etc/containers
            cat <<EOF > /etc/containers/storage.conf
            [storage]
            driver = "overlay"
            runroot = "/run/containers/storage"
            graphroot = "/var/lib/containers/storage"
            [storage.options.overlay]
            mount_program = "/usr/bin/fuse-overlayfs"
            EOF

            #####################################################################
            # 4. Load the tarred image and push to registry
            #####################################################################
            podman load -i /mnt/vol/app-image.tar

            podman tag $SRC_IMAGE $REGISTRY_ENDPOINT/$SRC_IMAGE
            podman push --tls-verify=false $REGISTRY_ENDPOINT/$SRC_IMAGE

            #####################################################################
            # 5. Emit image reference (for later steps/kubelet pulls)
            #####################################################################
            echo -n "$REGISTRY_ENDPOINT/$SRC_IMAGE" > /tmp/image.txt
        command:
          - sh
          - -c
        image: ghcr.io/openchoreo/podman-runner:v1.0
        securityContext:
          privileged: true
        volumeMounts:
          - mountPath: /mnt/vol
            name: workspace
    - name: workload-create-step
      inputs:
        parameters:
          - name: image
      outputs:
        parameters:
          - name: workload-cr
            valueFrom:
              path: /mnt/vol/workload-cr.yaml
      container:
        image: ghcr.io/openchoreo/podman-runner:v1.0
        command: [ sh, -c ]
        args:
          - |-
            set -e

            #####################################################################
            # 1. Initialize variables
            #####################################################################
            IMAGE={{inputs.parameters.image}}
            PROJECT_NAME={{workflow.parameters.project-name}}
            COMPONENT_NAME={{workflow.parameters.component-name}}
            APP_PATH="{{workflow.parameters.app-path}}"

            DESCRIPTOR_PATH="/mnt/vol/source${APP_PATH:+/${APP_PATH#/}}"

            OUTPUT_PATH="/mnt/vol/workload-cr.yaml"

            echo "Creating workload with image: ${IMAGE}"
            echo "Using descriptor in: ${DESCRIPTOR_PATH}"

            #####################################################################
            # 2. Podman storage configuration
            #####################################################################
            mkdir -p /etc/containers
            cat <<EOF > /etc/containers/storage.conf
            [storage]
            driver = "overlay"
            runroot = "/run/containers/storage"
            graphroot = "/var/lib/containers/storage"
            [storage.options.overlay]
            mount_program = "/usr/bin/fuse-overlayfs"
            EOF

            #####################################################################
            # 3. Create workload CR and export to output
            #####################################################################
            podman run --rm --network=none \
            -v $DESCRIPTOR_PATH:/app:rw -w /app \
            ghcr.io/openchoreo/openchoreo-cli:v0.8.0 \
              create workload \
              --project "${PROJECT_NAME}" \
              --component "${COMPONENT_NAME}" \
              --image "${IMAGE}" \
              --descriptor "workload.yaml" \
              -o "workload-cr.yaml"

            # Copy output CR to the shared volume
            cp -f "${DESCRIPTOR_PATH}/workload-cr.yaml" "${OUTPUT_PATH}"
        volumeMounts:
          - name: workspace
            mountPath: /mnt/vol
        securityContext:
          privileged: true
  ttlStrategy:
    secondsAfterCompletion: 3600
  volumeClaimTemplates:
    - metadata:
        creationTimestamp: null
        name: workspace
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 2Gi