# Steps
# 1. Define a WorkflowDefinition for Google Cloud Buildpacks
# 2. Define a ComponentTypeDefinition that allows using this WorkflowDefinition
# 3. Define a Component that uses this WorkflowDefinition. Component renders based on schema defined in WorkflowDefinition.
# 4. Define a Workflow instance that represents a build execution for the Component.
# 5. Define the rendered Argo Workflow that would be created based on the WorkflowDefinition schema and parameters, and Component values.


apiVersion: openchoreo.dev/v1alpha1
kind: WorkflowDefinition
metadata:
  name: google-cloud-buildpacks
  annotations:
    openchoreo.dev/description: "Google Cloud Buildpacks workflow for containerized builds"
spec:
  # Template Variable Reference (processed by controller):
  # ${ctx.workflowName}            - Workflow name
  # ${ctx.componentName}           - Component name
  # ${ctx.projectName}             - Project name
  # ${ctx.orgName}                 - Organization name
  # ${ctx.timestamp}               - Unix timestamp (e.g., 1234567890)
  # ${ctx.uuid}                    - UUID (8 chars)
  # ${schema.*}                    - Developer-provided values from schema
  # ${fixedParameters.*}           - PE-controlled fixed parameters
  # Developer-facing schema with type validation
  schema:
    repository:
      url: string
      revision:
        branch: string | default=main
        commit: string | default=HEAD
      appPath: string | default=.
      secretRef: string | enum=["reading-list-repo-credentials-dev","payments-repo-credentials-dev"]
    version: integer | default=1
    testMode: string | enum=["unit", "integration", "none"] default=unit
    command: '[]string | default=[]'
    args: "[]string | default=[]"
    resources:
        cpuCores: integer | default=1 minimum=1 maximum=8
        memoryGb: integer | default=2 minimum=1 maximum=32
    timeout: string | default="30m"
    cache:
        enabled: boolean | default=true
        paths: '[]string | default=["/root/.cache"]'
    limits:
        maxRetries: integer | default=3 minimum=0 maximum=10
        maxDurationMinutes: integer | default=60 minimum=5 maximum=240

  # Secret references to inject into build plane
  secrets:
    - ${schema.repository.secretRef}

  # Static, PE-controlled parameters (hidden from developer)
  fixedParameters:
    - name: builder-image
      value: gcr.io/buildpacks/builder@sha256:5977b4bd47d3e9ff729eefe9eb99d321d4bba7aa3b14986323133f40b622aef1
    - name: security-scan-enabled
      value: "true"
    - name: build-timeout
      value: "30m"

  # Rendered resource
  resource:
    template:
      apiVersion: argoproj.io/v1alpha1
      kind: Workflow
      metadata:
        name: ${ctx.workflowName} # PE needs to ensure uniqueness, workflowName is unique
        namespace: openchoreo-ci-${ctx.orgName}
      spec:
        arguments:
          parameters:
            - name: component-name
              value: ${ctx.componentName}
            - name: project-name
              value: ${ctx.projectName}
            # Parameters from schema (developer-facing)
            - name: git-repo
              value: ${schema.repository.url}
            - name: branch
              value: ${schema.repository.revision.branch}
            - name: commit
              value: ${schema.repository.revision.commit}
            - name: app-path
              value: ${schema.repository.appPath}
            - name: version
              value: ${schema.version}
            - name: test-mode
              value: ${schema.testMode}
            - name: command
              value: ${schema.command}
            - name: args
              value: ${schema.args}
            - name: cpu-cores
              value: ${schema.resources.cpuCores}
            - name: memory-gb
              value: ${schema.resources.memoryGb}
            - name: timeout
              value: ${schema.timeout}
            - name: cache-enabled
              value: ${schema.cache.enabled}
            - name: cache-paths
              value: ${schema.cache.paths}
            - name: max-retries
              value: ${schema.limits.maxRetries}
            - name: max-duration-minutes
              value: ${schema.limits.maxDurationMinutes}
            # Parameters from fixedParameters (PE-controlled)
            - name: builder-image
              value: ${fixedParameters["builder-image"]}
            - name: registry-url
              value: gcr.io/openchoreo-dev/images
            - name: security-scan-enabled
              value: ${fixedParameters["security-scan-enabled"]}
            - name: build-timeout
              value: ${fixedParameters["build-timeout"]}
            - name: image-name
              value: ${ctx.projectName}-${ctx.componentName}-image
            - name: image-tag
              value: v${schema.version}
        serviceAccountName: workflow-sa
        workflowTemplateRef:
          clusterScope: true
          name: google-cloud-buildpacks

---
apiVersion: openchoreo.dev/v1alpha1
kind: ComponentTypeDefinition
metadata:
  name: service
spec:
  # Restrict which workflow templates developers can use for this component type
  build:
    allowedTemplates:
      - name: google-cloud-buildpacks
        # PE-controlled parameters that override WorkflowDefinition defaults
        fixedParameters:
          - name: security-scan-enabled
            value: "false"
          - name: build-timeout
            value: "45m"
      - name: docker
        # PE-controlled parameters that override WorkflowDefinition defaults
        fixedParameters:
          - name: build-timeout
            value: "45m"

  workloadType: deployment

  schema:
    types:
      Resources:
        cpu: "string | default=100m"
        memory: "string | default=256Mi"

    parameters:
      replicas: "integer | default=1"
      imagePullPolicy: "string | default=IfNotPresent"
      port: "integer | default=8080"

    envOverrides:
      resources:
        requests: Resources
        limits: Resources

  resources:
    - id: deployment
      template:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: ${metadata.name}
          namespace: ${metadata.namespace}
          labels: ${metadata.labels}
        spec:
          replicas: ${parameters.replicas}
          selector:
            matchLabels: ${metadata.podSelectors}
          template:
            metadata:
              labels: ${metadata.podSelectors}
            spec:
              containers:
                - name: app
                  image: ${workload.containers["app"].image}
                  imagePullPolicy: ${parameters.imagePullPolicy}
                  ports:
                    - name: http
                      containerPort: ${parameters.port}
                      protocol: TCP
                  resources:
                    requests:
                      cpu: ${parameters.resources.requests.cpu}
                      memory: ${parameters.resources.requests.memory}
                    limits:
                      cpu: ${parameters.resources.limits.cpu}
                      memory: ${parameters.resources.limits.memory}

    - id: service
      template:
        apiVersion: v1
        kind: Service
        metadata:
          name: ${metadata.name}
          namespace: ${metadata.namespace}
          labels: ${metadata.labels}
        spec:
          type: ClusterIP
          selector: ${metadata.podSelectors}
          ports:
            - name: http
              port: 80
              targetPort: ${parameters.port}
              protocol: TCP

---
apiVersion: openchoreo.dev/v1alpha1
kind: Component
metadata:
  name: reading-list-service
spec:
  owner:
    projectName: backend-services
  # References the ComponentTypeDefinition
  componentType: deployment/service

  # Build configuration matching the schema from WorkflowDefinition
  build:
    # Selects a WorkflowDefinition from allowed templates in ComponentTypeDefinition
    workflowTemplate: google-cloud-buildpacks
    schema:
      # Nested structure from schema
      repository:
        url: "https://github.com/openchoreo/sample-workloads"
        revision:
          branch: "main"
          commit: ""
        appPath: "/service-go-reading-list"
        secretRef: "reading-list-repo-credentials-dev"

      # Simple schema fields
      version: 1
      testMode: "integration"  # From enum: ["unit", "integration", "none"]
      command: ["npm", "run", "build"]
      args: ["--production", "--verbose"]
      resources:
        cpuCores: 2
        memoryGb: 4
      timeout: "45m"
      cache:
        enabled: true
        paths: ["/root/.npm", "/root/.cache"]
      limits:
        maxRetries: 5
        maxDurationMinutes: 90

  parameters:
    replicas: 2
    port: 8080
    resources:
      requests:
        cpu: "200m"
        memory: "512Mi"
      limits:
        cpu: "1000m"
        memory: "1Gi"
---
apiVersion: openchoreo.dev/v1alpha1
kind: Workflow
metadata:
  # Should be unique per execution, PEs must ensure uniqueness
  name: reading-list-service-build-01
spec:
  # Ownership tracking for the workflow execution
  owner:
    projectName: "backend-services"
    componentName: "reading-list-service"

  # Reference to WorkflowDefinition
  workflowDefinitionRef: google-cloud-buildpacks

  # Developer parameters from Component CR (matching schema)
  schema:
    repository:
      url: "https://github.com/openchoreo/sample-workloads"
      revision:
        branch: "main"
        commit: ""
      appPath: "/service-go-reading-list"
      secretRef: "reading-list-repo-credentials-dev"
    version: 1
    testMode: "integration"
    command: ["npm", "run", "build"]
    args: ["--production", "--verbose"]
    resources:
      cpuCores: 2
      memoryGb: 4
    timeout: "45m"
    cache:
      enabled: true
      paths: ["/root/.npm", "/root/.cache"]
    limits:
      maxRetries: 5
      maxDurationMinutes: 90

---
# Generated Argo Workflow from the WorkflowDefinition above

#apiVersion: argoproj.io/v1alpha1
#kind: Workflow
#metadata:
#  annotations:
#    workflows.argoproj.io/pod-name-format: v2
#  creationTimestamp: "2025-11-05T06:37:18Z"
#  generation: 14
#  labels:
#    openchoreo.dev/workflow: checkout-service-build-01
#    openchoreo.dev/workflow-namespace: default
#    workflows.argoproj.io/completed: "false"
#    workflows.argoproj.io/phase: Running
#  name: reading-list-service-build-01
#  namespace: openchoreo-ci-default
#  resourceVersion: "2580488"
#  uid: 562787bb-1ed4-4cb6-88df-727e88f19975
#spec:
#  arguments:
#    parameters:
#      - name: component-name
#        value: reading-list-service
#      - name: project-name
#        value: backend-services
#      - name: git-repo
#        value: https://github.com/openchoreo/sample-workloads
#      - name: branch
#        value: main
#      - name: commit
#        value: ""
#      - name: app-path
#        value: /service-go-greeter
#      - name: credentialsRef
#        value: reading-list-repo-credentials-dev
#      - name: version
#        value: "1"
#      - name: test-mode
#        value: integration
#      - name: command
#        value: '["npm","run","build"]'
#      - name: args
#        value: '["--production","--verbose"]'
#      - name: cpu-cores
#        value: "2"
#      - name: memory-gb
#        value: "4"
#      - name: timeout
#        value: 45m
#      - name: cache-enabled
#        value: "true"
#      - name: cache-paths
#        value: '["/root/.npm","/root/.cache"]'
#      - name: max-retries
#        value: "5"
#      - name: max-duration-minutes
#        value: "90"
#      - name: builder-image
#        value: gcr.io/buildpacks/builder@sha256:5977b4bd47d3e9ff729eefe9eb99d321d4bba7aa3b14986323133f40b622aef1
#      - name: registry-url
#        value: gcr.io/openchoreo-dev/images
#      - name: security-scan-enabled
#        value: unknown
#      - name: build-timeout
#        value: 0m
#      - name: image-name
#        value: reading-list-service-image
#      - name: image-tag
#        value: v1
#  serviceAccountName: workflow-sa
#  workflowTemplateRef:
#    clusterScope: true
#    name: google-cloud-buildpacks
