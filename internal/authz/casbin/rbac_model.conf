[request_definition]
# sub: group, service account etc
# hierarchical resource path (e.g., "ns/acme/project/p1/component/c1")
# act: action string (e.g., "component:create", "deployment:read")
# ctx: context JSON
r = sub, resource, act, ctx

[policy_definition]
# sub: subject
# resource: resource prefix for hierarchical matching
# role: role name
# role_ns: "*" for cluster roles, namespace name for namespace-scoped roles
# eft: allow / deny
# ctx: context JSON
p = sub, resource, role, role_ns, eft, ctx

[role_definition]
# g: cluster role to action mapping (AuthzClusterRole)
# Format: g, <role>, <action>
g = _, _
# g2: namespace role to action mapping (AuthzRole)
# Format: g2, <role>, <namespace>, <action>
g2 = _, _, _

[policy_effect]
e = some(where (p.eft == allow)) && !some(where (p.eft == deny))

[matchers]
m = r.sub == p.sub && resourceMatch(r.resource, p.resource) && ((p.role_ns == "*" && g(p.role, r.act)) || (p.role_ns != "*" && g2(p.role, p.role_ns, r.act))) && ctxMatch(r.ctx, p.ctx)
