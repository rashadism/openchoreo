apiVersion: core.choreo.dev/v1alpha1
kind: ComponentEnvSnapshot
spec:
  environment: dev
  component:
    metadata:
      name: test-app
    spec:
      parameters:
        replicas: 2
  componentType:
    spec:
      resources:
        - id: deployment
          template:
            apiVersion: apps/v1
            kind: Deployment
            metadata:
              name: ${metadata.name}
            spec:
              replicas: ${parameters.replicas}
              template:
                spec:
                  containers:
                    - name: main
                      image: myapp:latest
                      envFrom: |
                        ${(has(configurations["main"].configs.envs) && configurations["main"].configs.envs.size() > 0 ?
                          [{
                            "configMapRef": {
                              "name": oc_generate_name(metadata.name, "env-configs")
                            }
                          }] : []) +
                        (has(configurations["main"].secrets.envs) && configurations["main"].secrets.envs.size() > 0 ?
                          [{
                            "secretRef": {
                              "name": oc_generate_name(metadata.name, "env-secrets")
                            }
                          }] : [])}
                      volumeMounts: |
                        ${has(configurations["main"].configs.files) && configurations["main"].configs.files.size() > 0 || has(configurations["main"].secrets.files) && configurations["main"].secrets.files.size() > 0 ?
                          (has(configurations["main"].configs.files) && configurations["main"].configs.files.size() > 0 ?
                            configurations["main"].configs.files.map(f, {
                              "name": "file-mount-"+oc_hash(f.mountPath+"/"+f.name),
                              "mountPath": f.mountPath+"/"+f.name ,
                              "subPath": f.name
                            }) : []) +
                          (has(configurations["main"].secrets.files) && configurations["main"].secrets.files.size() > 0 ?
                            configurations["main"].secrets.files.map(f, {
                              "name": "file-mount-"+oc_hash(f.mountPath+"/"+f.name),
                              "mountPath": f.mountPath+"/"+f.name,
                              "subPath": f.name
                            }) : [])
                        : oc_omit()}
                  volumes: |
                    ${has(configurations["main"].configs.files) && configurations["main"].configs.files.size() > 0 || has(configurations["main"].secrets.files) && configurations["main"].secrets.files.size() > 0 ?
                      (has(configurations["main"].configs.files) && configurations["main"].configs.files.size() > 0 ?
                        configurations["main"].configs.files.map(f, {
                          "name": "file-mount-"+oc_hash(f.mountPath+"/"+f.name),
                          "configMap": {
                            "name": oc_generate_name(metadata.name, "config", f.name).replace(".", "-")
                          }
                        }) : []) +
                      (has(configurations["main"].secrets.files) && configurations["main"].secrets.files.size() > 0 ?
                        configurations["main"].secrets.files.map(f, {
                          "name": "file-mount-"+oc_hash(f.mountPath+"/"+f.name),
                          "secret": {
                            "secretName": oc_generate_name(metadata.name, "secret", f.name).replace(".", "-")
                          }
                        }) : [])
                    : oc_omit()}
        - id: env-config
          includeWhen: ${has(configurations["main"].configs.envs) && configurations["main"].configs.envs.size() > 0}
          template:
            apiVersion: v1
            kind: ConfigMap
            metadata:
              name: ${oc_generate_name(metadata.name, "env-configs")}
            data: |
              ${has(configurations["main"].configs.envs) ? configurations["main"].configs.envs.transformMapEntry(index, env, {env.name: env.value}) : oc_omit()}
        - id: file-config
          includeWhen: ${has(configurations["main"].configs.files) && configurations["main"].configs.files.size() > 0}
          forEach: ${configurations["main"].configs.files}
          var: config
          template:
            apiVersion: v1
            kind: ConfigMap
            metadata:
              name: ${oc_generate_name(metadata.name, "config", config.name).replace(".", "-")}
              namespace: ${metadata.namespace}
            data:
              ${config.name}: |
                ${config.value}
        - id: secret-env-external
          includeWhen: ${has(configurations["main"].secrets.envs) && configurations["main"].secrets.envs.size() > 0}
          template:
            apiVersion: external-secrets.io/v1
            kind: ExternalSecret
            metadata:
              name: ${oc_generate_name(metadata.name, "env-secrets")}
              namespace: ${metadata.namespace}
            spec:
              refreshInterval: 15s
              secretStoreRef:
                name: ${dataplane.secretStore}
                kind: ClusterSecretStore
              target:
                name: ${oc_generate_name(metadata.name, "env-secrets")}
                creationPolicy: Owner
              data: |
                ${has(configurations["main"].secrets.envs) ? configurations["main"].secrets.envs.map(secret, {
                  "secretKey": secret.name,
                  "remoteRef": {
                    "key": secret.remoteRef.key,
                    "property": secret.remoteRef.property
                  }
                }) : oc_omit()}
        - id: secret-file-external
          includeWhen: ${has(configurations["main"].secrets.files) && configurations["main"].secrets.files.size() > 0}
          forEach: ${configurations["main"].secrets.files}
          var: file
          template:
            apiVersion: external-secrets.io/v1
            kind: ExternalSecret
            metadata:
              name: ${oc_generate_name(metadata.name, "secret", file.name).replace(".", "-")}
              namespace: ${metadata.namespace}
            spec:
              refreshInterval: 15s
              secretStoreRef:
                name: ${dataplane.secretStore}
                kind: ClusterSecretStore
              target:
                name: ${oc_generate_name(metadata.name, "secret", file.name).replace(".", "-")}
                creationPolicy: Owner
              data:
                - secretKey: ${file.name}
                  remoteRef:
                    key: ${file.remoteRef.key}
                    property: ${file.remoteRef.property}
  workload:
    spec:
      containers:
        main:
          image: myapp:latest
          env:
            - key: LOG_LEVEL
              value: info
            - key: DEBUG_MODE
              value: "true"
            - key: DB_PASSWORD
              valueFrom:
                secretRef:
                  name: db-secret
                  key: password
            - key: API_KEY
              valueFrom:
                secretRef:
                  name: api-secret
                  key: api_key
          files:
            - key: config.json
              value: |
                {
                  "database": {
                    "host": "localhost",
                    "port": 5432
                  }
                }
              mountPath: /etc/config
            - key: app.properties
              value: |
                app.name=myapp
                app.version=1.0.0
              mountPath: /etc/config
            - key: tls.crt
              mountPath: /etc/tls
              valueFrom:
                secretRef:
                  name: tls-secret
                  key: tls.crt
            - key: application.yaml
              mountPath: /etc/config
              valueFrom:
                secretRef:
                  name: app-config-secret
                  key: application.yaml
