---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.16.4
  name: components.openchoreo.dev
spec:
  group: openchoreo.dev
  names:
    kind: Component
    listKind: ComponentList
    plural: components
    shortNames:
    - comp
    - comps
    singular: component
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.owner.projectName
      name: Project
      type: string
    - jsonPath: .spec.componentType.name
      name: ComponentType
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: Component is the Schema for the components API.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: ComponentSpec defines the desired state of Component.
            properties:
              autoBuild:
                description: |-
                  AutoBuild enables automatic builds when code is pushed to the repository
                  When enabled, webhook events will trigger builds automatically
                  Users must manually configure webhooks in their Git provider
                type: boolean
              autoDeploy:
                description: |-
                  AutoDeploy indicates whether the component should be deployed automatically when created
                  When not specified, defaults to false (zero value)
                type: boolean
              componentType:
                description: |-
                  ComponentType specifies the component type reference with kind and name.
                  Name is in the format: {workloadType}/{componentTypeName}
                  Example: kind=ComponentType, name="deployment/web-app"
                  This field is used with ComponentTypes (new model)
                properties:
                  kind:
                    default: ComponentType
                    description: Kind is the kind of component type (ComponentType
                      or ClusterComponentType)
                    enum:
                    - ComponentType
                    - ClusterComponentType
                    type: string
                  name:
                    description: 'Name is the component type reference in format:
                      {workloadType}/{componentTypeName}'
                    pattern: ^(deployment|statefulset|cronjob|job|proxy)/[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                    type: string
                required:
                - name
                type: object
                x-kubernetes-validations:
                - message: spec.componentType cannot be changed after creation
                  rule: self == oldSelf
              owner:
                description: Owner defines the ownership information for the component
                properties:
                  projectName:
                    minLength: 1
                    type: string
                required:
                - projectName
                type: object
                x-kubernetes-validations:
                - message: spec.owner is immutable
                  rule: self == oldSelf
              parameters:
                description: |-
                  Parameters from ComponentType (oneOf schema based on componentType)
                  This is the merged schema of parameters + envOverrides from the ComponentType
                x-kubernetes-preserve-unknown-fields: true
              traits:
                description: |-
                  Traits to compose into this component
                  Each trait can be instantiated multiple times with different instanceNames
                items:
                  description: ComponentTrait represents an trait instance attached
                    to a component
                  properties:
                    instanceName:
                      description: |-
                        InstanceName uniquely identifies this trait instance within the component
                        Allows the same trait to be used multiple times with different configurations
                        Must be unique across all traits in the component
                      minLength: 1
                      type: string
                    name:
                      description: Name is the name of the Trait resource to use
                      minLength: 1
                      type: string
                    parameters:
                      description: |-
                        Parameters contains the trait parameter values
                        The schema for this config is defined in the Trait's schema.parameters and schema.envOverrides
                      x-kubernetes-preserve-unknown-fields: true
                  required:
                  - instanceName
                  - name
                  type: object
                type: array
              type:
                description: |-
                  Type specifies the component type (e.g., Service, WebApplication, etc.)
                  LEGACY FIELD: Use componentType instead for new components with ComponentTypes
                type: string
              workflow:
                description: |-
                  Workflow defines the component workflow configuration for building the component.
                  This references a ComponentWorkflow CR and provides both system parameters (repository info)
                  and developer-configured parameter values.
                  The ComponentWorkflow must be in the allowedWorkflows list of the ComponentType.
                properties:
                  name:
                    description: |-
                      Name references the ComponentWorkflow CR to use for this execution.
                      The ComponentWorkflow CR contains the schema definition and resource template.
                    minLength: 1
                    type: string
                  parameters:
                    description: |-
                      Parameters contains the developer-provided values for the flexible parameter schema
                      defined in the referenced ComponentWorkflow CR.

                      These values are validated against the ComponentWorkflow's parameter schema.
                    type: object
                    x-kubernetes-preserve-unknown-fields: true
                  systemParameters:
                    description: |-
                      SystemParameters contains the actual repository information values.
                      This must conform to the required system parameters structure:
                        - repository.url
                        - repository.revision.branch
                        - repository.revision.commit
                        - repository.appPath
                    properties:
                      repository:
                        description: Repository contains the actual repository information
                          values.
                        properties:
                          appPath:
                            description: |-
                              AppPath is the path to the application code within the repository.
                              Example: "/service-go-reading-list" or "."
                            minLength: 1
                            type: string
                          revision:
                            description: Revision contains the revision-related parameter
                              values (branch, commit).
                            properties:
                              branch:
                                description: |-
                                  Branch is the Git branch to build from.
                                  Example: "main"
                                minLength: 1
                                type: string
                              commit:
                                description: |-
                                  Commit is the specific commit SHA to build.
                                  Can be empty to use the latest commit.
                                  Example: "a1b2c3d4e5f6" or ""
                                pattern: ^[0-9a-fA-F]{7,40}$
                                type: string
                            required:
                            - branch
                            type: object
                          secretRef:
                            description: |-
                              SecretRef is the name of the SecretReference for Git credentials.
                              This should reference a SecretReference CR in the same namespace.
                              Example: "my-git-credentials"
                            type: string
                          url:
                            description: |-
                              URL is the Git repository URL for the component source code.
                              Supports HTTP/HTTPS and SSH formats.
                              Examples:
                                - "https://github.com/openchoreo/sample-workloads"
                                - "git@github.com:openchoreo/sample-workloads.git"
                                - "ssh://git@github.com/openchoreo/sample-workloads.git"
                            pattern: ^(https?://|ssh://|git@[^:]+:)
                            type: string
                        required:
                        - appPath
                        - revision
                        - url
                        type: object
                    required:
                    - repository
                    type: object
                required:
                - name
                - systemParameters
                type: object
            required:
            - owner
            type: object
            x-kubernetes-validations:
            - message: Component must have either spec.type or spec.componentType
                set
              rule: has(self.type) || has(self.componentType)
            - message: spec.componentType.name is required when componentType is set
              rule: '!has(self.componentType) || has(self.componentType.name)'
          status:
            description: ComponentStatus defines the observed state of Component.
            properties:
              conditions:
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
              latestRelease:
                description: |-
                  LatestRelease keeps the information of the latest ComponentRelease created for this component
                  This is used to make sure the component's latest ComponentRelease is always
                  deployed to the first environment, if the autoDeploy flag is set to true
                properties:
                  name:
                    description: Name of the ComponentRelease resource
                    minLength: 1
                    type: string
                  releaseHash:
                    description: ReleaseHash record the hash value of the spec of
                      ComponentRelease.
                    minLength: 1
                    type: string
                required:
                - name
                - releaseHash
                type: object
              observedGeneration:
                format: int64
                type: integer
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
