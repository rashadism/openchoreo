---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.16.4
  name: componentreleases.openchoreo.dev
spec:
  group: openchoreo.dev
  names:
    kind: ComponentRelease
    listKind: ComponentReleaseList
    plural: componentreleases
    singular: componentrelease
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.owner.projectName
      name: Project
      type: string
    - jsonPath: .spec.owner.componentName
      name: Component
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: ComponentRelease is the Schema for the componentreleases API.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: ComponentReleaseSpec defines the desired state of ComponentRelease.
            properties:
              componentProfile:
                description: |-
                  ComponentProfile contains the immutable snapshot of parameter values and trait configs
                  specified for this component at release time
                properties:
                  parameters:
                    description: |-
                      Parameters from ComponentType (oneOf schema based on componentType)
                      This is the merged schema of parameters + envOverrides from the ComponentType
                    x-kubernetes-preserve-unknown-fields: true
                  traits:
                    description: |-
                      Traits to compose into this component
                      Each trait can be instantiated multiple times with different instanceNames
                    items:
                      description: ComponentTrait represents an trait instance attached
                        to a component
                      properties:
                        instanceName:
                          description: |-
                            InstanceName uniquely identifies this trait instance within the component
                            Allows the same trait to be used multiple times with different configurations
                            Must be unique across all traits in the component
                          minLength: 1
                          type: string
                        name:
                          description: Name is the name of the Trait resource to use
                          minLength: 1
                          type: string
                        parameters:
                          description: |-
                            Parameters contains the trait parameter values
                            The schema for this config is defined in the Trait's schema.parameters and schema.envOverrides
                          x-kubernetes-preserve-unknown-fields: true
                      required:
                      - instanceName
                      - name
                      type: object
                    type: array
                type: object
                x-kubernetes-validations:
                - message: spec.componentProfile is immutable
                  rule: self == oldSelf
              componentType:
                description: |-
                  ComponentType is a full embedded copy of the ComponentType
                  This ensures the ComponentRelease has an immutable snapshot of the ComponentType at the time of component release
                properties:
                  allowedTraits:
                    description: |-
                      AllowedTraits restricts which Trait CRs developers can attach to Components of this type.
                      When specified, only traits listed here may be attached beyond those already embedded in spec.traits.
                      Trait names listed here must not overlap with traits already embedded in spec.traits.
                      If empty or omitted, no additional component-level traits are allowed.
                    items:
                      type: string
                    type: array
                  allowedWorkflows:
                    description: |-
                      AllowedWorkflows restricts which ComponentWorkflow CRs developers can use
                      for building components of this type. If empty, no ComponentWorkflows are allowed.
                      References must point to ComponentWorkflow resources, not generic Workflow resources.
                    items:
                      type: string
                    type: array
                  resources:
                    description: |-
                      Resources are templates that generate Kubernetes resources dynamically.
                      At least one resource template is required. For non-proxy workload types,
                      one resource must have an id matching the workloadType. When workloadType
                      is "proxy", a matching resource id is not required.
                    items:
                      description: ResourceTemplate defines a template for generating
                        Kubernetes resources
                      properties:
                        forEach:
                          description: |-
                            ForEach enables generating multiple resources from a list using CEL expression
                            Example: "${spec.configurations}" to iterate over a list
                          pattern: ^\$\{[\s\S]+\}\s*$
                          type: string
                        id:
                          description: |-
                            ID uniquely identifies this resource within the component type
                            For the primary workload resource, this must match the workloadType
                          minLength: 1
                          type: string
                        includeWhen:
                          description: |-
                            IncludeWhen is a CEL expression that determines if this resource should be created
                            If not specified, the resource is always created
                            Example: "${spec.autoscaling.enabled}"
                          pattern: ^\$\{[\s\S]+\}\s*$
                          type: string
                        targetPlane:
                          default: dataplane
                          description: |-
                            TargetPlane specifies which plane this resource should be deployed to
                            Defaults to "dataplane" if not specified
                          enum:
                          - dataplane
                          - observabilityplane
                          type: string
                        template:
                          description: |-
                            Template contains the Kubernetes resource with CEL expressions
                            CEL expressions are enclosed in ${...} and will be evaluated at runtime
                          type: object
                          x-kubernetes-preserve-unknown-fields: true
                        var:
                          description: |-
                            Var is the loop variable name when using forEach
                            Example: "config" will make each item available as ${config} in templates
                          pattern: ^[a-zA-Z_][a-zA-Z0-9_]*$
                          type: string
                      required:
                      - id
                      - template
                      type: object
                      x-kubernetes-validations:
                      - message: var is required when forEach is specified
                        rule: '!has(self.forEach) || has(self.var)'
                    minItems: 1
                    type: array
                  schema:
                    description: Schema defines what developers can configure when
                      creating components of this type
                    properties:
                      envOverrides:
                        description: |-
                          EnvOverrides can be overridden per environment via ReleaseBinding by platform engineers.
                          Same nested map structure and type definition format as Parameters.
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                      parameters:
                        description: |-
                          Parameters are static across environments and exposed as inputs to developers
                          when creating a Component of this type. This is a nested map structure where
                          keys are field names and values are either nested maps or type definition strings.
                          Type definition format: "type | default=value | required=true | enum=val1,val2"
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                      types:
                        description: |-
                          Types defines reusable type definitions that can be referenced in schema fields
                          This is a nested map structure where keys are type names and values are type definitions
                        type: object
                        x-kubernetes-preserve-unknown-fields: true
                    type: object
                  traits:
                    description: |-
                      Traits are pre-configured trait instances embedded in the ComponentType.
                      The PE binds trait parameters using concrete values or CEL expressions
                      referencing the ComponentType schema (e.g., "${parameters.storage.mountPath}").
                      These traits are automatically applied to all Components of this type.
                    items:
                      description: |-
                        ComponentTypeTrait represents a pre-configured trait instance embedded in a ComponentType.
                        The PE binds trait parameters using concrete values (locked) or CEL expressions
                        referencing the ComponentType schema (wired to developer-configurable fields).
                      properties:
                        envOverrides:
                          description: |-
                            EnvOverrides contains trait environment override bindings.
                            Values can be concrete (locked by PE) or CEL expressions referencing
                            the ComponentType schema using ${...} syntax.
                            Example: "${envOverrides.storage.size}" or "local-path" (locked)
                          x-kubernetes-preserve-unknown-fields: true
                        instanceName:
                          description: |-
                            InstanceName uniquely identifies this trait instance.
                            Must be unique across all embedded traits in the ComponentType
                            and must not collide with any component-level trait instance names.
                          minLength: 1
                          type: string
                        name:
                          description: Name is the name of the Trait resource to use.
                          minLength: 1
                          type: string
                        parameters:
                          description: |-
                            Parameters contains trait parameter bindings.
                            Values can be concrete (locked by PE) or CEL expressions referencing
                            the ComponentType schema using ${...} syntax.
                            Example: "${parameters.storage.mountPath}" or "app-data" (locked)
                          x-kubernetes-preserve-unknown-fields: true
                      required:
                      - instanceName
                      - name
                      type: object
                    type: array
                  validations:
                    description: |-
                      Validations are CEL-based rules evaluated during rendering.
                      All rules must evaluate to true for rendering to proceed.
                    items:
                      description: ValidationRule defines a CEL-based validation rule
                        evaluated during rendering.
                      properties:
                        message:
                          description: Message is the error message shown when the
                            rule evaluates to false.
                          minLength: 1
                          type: string
                        rule:
                          description: |-
                            Rule is a CEL expression wrapped in ${...} that must evaluate to true.
                            Uses the same syntax as includeWhen and where fields.
                          pattern: ^\$\{[\s\S]+\}\s*$
                          type: string
                      required:
                      - message
                      - rule
                      type: object
                    type: array
                  workloadType:
                    description: |-
                      WorkloadType must be one of: deployment, statefulset, cronjob, job, proxy
                      This determines the primary workload resource type for this component type
                    enum:
                    - deployment
                    - statefulset
                    - cronjob
                    - job
                    - proxy
                    type: string
                    x-kubernetes-validations:
                    - message: spec.workloadType cannot be changed after creation
                      rule: self == oldSelf
                required:
                - resources
                - workloadType
                type: object
                x-kubernetes-validations:
                - message: spec.componentType is immutable
                  rule: self == oldSelf
                - message: resources must contain a primary resource with id matching
                    workloadType (unless workloadType is 'proxy')
                  rule: self.workloadType == 'proxy' || self.resources.exists(r, r.id
                    == self.workloadType)
              owner:
                description: Owner identifies the component and project this ComponentRelease
                  belongs to
                properties:
                  componentName:
                    description: ComponentName is the name of the component
                    minLength: 1
                    type: string
                  projectName:
                    description: ProjectName is the name of the project that owns
                      this component
                    minLength: 1
                    type: string
                required:
                - componentName
                - projectName
                type: object
                x-kubernetes-validations:
                - message: spec.owner is immutable
                  rule: self == oldSelf
              traits:
                additionalProperties:
                  description: TraitSpec defines the desired state of Trait.
                  properties:
                    creates:
                      description: Creates defines new Kubernetes resources to create
                        when this trait is applied
                      items:
                        description: TraitCreate defines a resource template to be
                          created by the trait
                        properties:
                          forEach:
                            description: |-
                              ForEach enables generating multiple resources from a list using CEL expression
                              Example: "${parameters.volumes}" to iterate over a list
                            pattern: ^\$\{[\s\S]+\}\s*$
                            type: string
                          includeWhen:
                            description: |-
                              IncludeWhen is a CEL expression that determines if this resource should be created
                              If not specified, the resource is always created
                              Example: "${parameters.enableMetrics}"
                            pattern: ^\$\{[\s\S]+\}\s*$
                            type: string
                          targetPlane:
                            default: dataplane
                            description: |-
                              TargetPlane specifies which plane this resource should be deployed to
                              Defaults to "dataplane" if not specified
                            enum:
                            - dataplane
                            - observabilityplane
                            type: string
                          template:
                            description: |-
                              Template contains the Kubernetes resource with CEL expressions
                              CEL expressions are enclosed in ${...} and will be evaluated at runtime
                            type: object
                            x-kubernetes-preserve-unknown-fields: true
                          var:
                            description: |-
                              Var is the loop variable name when using forEach
                              Example: "volume" will make each item available as ${volume} in templates
                            pattern: ^[a-zA-Z_][a-zA-Z0-9_]*$
                            type: string
                        required:
                        - template
                        type: object
                        x-kubernetes-validations:
                        - message: var is required when forEach is specified
                          rule: '!has(self.forEach) || has(self.var)'
                      type: array
                    patches:
                      description: Patches defines modifications to existing resources
                        generated by the ComponentType
                      items:
                        description: TraitPatch defines a modification to an existing
                          resource
                        properties:
                          forEach:
                            description: |-
                              ForEach repeats this patch for every item in a CEL-evaluated list
                              Requires 'var' to be set to name the binding used in operations
                              Example: forEach: ${spec.mounts}
                            pattern: ^\$\{[\s\S]+\}\s*$
                            type: string
                          operations:
                            description: Operations is the list of JSONPatch operations
                              to apply to the target resource
                            items:
                              description: |-
                                JSONPatchOperation defines a JSONPatch operation
                                Supports standard operations (add, replace, remove) for map overlays
                              properties:
                                op:
                                  description: |-
                                    Op is the operation type
                                    Standard operations: add, replace, remove (RFC 6902)
                                  enum:
                                  - add
                                  - replace
                                  - remove
                                  type: string
                                path:
                                  description: |-
                                    Path is the JSON Pointer to the field to modify (RFC 6901)
                                    Supports array filters: /spec/containers/[?(@.name=='app')]/volumeMounts/-
                                  type: string
                                value:
                                  description: |-
                                    Value is the value to set (for add/replace operations)
                                    Not used for remove operations
                                    Can be a literal value, a structure with embedded CEL expressions,
                                    or a standalone CEL expression.
                                  x-kubernetes-preserve-unknown-fields: true
                              required:
                              - op
                              - path
                              type: object
                            minItems: 1
                            type: array
                          target:
                            description: Target specifies which resource to patch
                            properties:
                              group:
                                description: |-
                                  Group is the API group of the resource (e.g., "apps", "batch")
                                  Must be explicitly set. Use empty string "" for core API resources (v1 Service, ConfigMap, etc.)
                                type: string
                              kind:
                                description: Kind is the resource type to patch (e.g.,
                                  "Deployment", "StatefulSet")
                                minLength: 1
                                type: string
                              version:
                                description: Version is the API version of the resource
                                  (e.g., "v1", "v1beta1")
                                minLength: 1
                                type: string
                              where:
                                description: |-
                                  Where is an optional CEL expression to filter which resources to patch
                                  Example: ${resource.metadata.name.endsWith("-secret-envs")}
                                pattern: ^\$\{[\s\S]+\}\s*$
                                type: string
                            required:
                            - group
                            - kind
                            - version
                            type: object
                          targetPlane:
                            default: dataplane
                            description: |-
                              TargetPlane specifies which plane's resources this patch targets
                              Defaults to "dataplane" if not specified
                            enum:
                            - dataplane
                            - observabilityplane
                            type: string
                          var:
                            description: |-
                              Var names the binding for forEach iterations
                              Required when forEach is specified
                              Example: var: mount
                            pattern: ^[a-zA-Z_][a-zA-Z0-9_]*$
                            type: string
                        required:
                        - operations
                        - target
                        type: object
                        x-kubernetes-validations:
                        - message: var is required when forEach is specified
                          rule: '!has(self.forEach) || has(self.var)'
                      type: array
                    schema:
                      description: Schema defines trait parameters
                      properties:
                        envOverrides:
                          description: |-
                            EnvOverrides can be overridden per environment via ReleaseBinding.
                            Same nested map structure and type definition format as Parameters.
                          type: object
                          x-kubernetes-preserve-unknown-fields: true
                        parameters:
                          description: |-
                            Parameters are developer-facing configuration options.
                            This is a nested map structure where keys are field names and values
                            are either nested maps or type definition strings.
                            Type definition format: "type | default=value | required=true | enum=val1,val2"
                          type: object
                          x-kubernetes-preserve-unknown-fields: true
                        types:
                          description: |-
                            Types defines reusable type definitions that can be referenced in schema fields
                            This is a nested map structure where keys are type names and values are type definitions
                          type: object
                          x-kubernetes-preserve-unknown-fields: true
                      type: object
                    validations:
                      description: |-
                        Validations are CEL-based rules evaluated during rendering.
                        All rules must evaluate to true for rendering to proceed.
                      items:
                        description: ValidationRule defines a CEL-based validation
                          rule evaluated during rendering.
                        properties:
                          message:
                            description: Message is the error message shown when the
                              rule evaluates to false.
                            minLength: 1
                            type: string
                          rule:
                            description: |-
                              Rule is a CEL expression wrapped in ${...} that must evaluate to true.
                              Uses the same syntax as includeWhen and where fields.
                            pattern: ^\$\{[\s\S]+\}\s*$
                            type: string
                        required:
                        - message
                        - rule
                        type: object
                      type: array
                  type: object
                description: |-
                  Traits maps trait names to their frozen specifications
                  at the time of ComponentRelease, ensuring immutability
                type: object
                x-kubernetes-validations:
                - message: spec.traits is immutable
                  rule: self == oldSelf
              workload:
                description: |-
                  Workload is a full embedded copy of the Workload
                  This preserves the workload spec with the built image
                properties:
                  connections:
                    additionalProperties:
                      description: WorkloadConnection represents an internal API connection
                      properties:
                        inject:
                          description: Inject defines how connection details are injected
                            into the workload
                          properties:
                            env:
                              description: Environment variables to inject
                              items:
                                description: WorkloadConnectionEnvVar defines an environment
                                  variable injection
                                properties:
                                  name:
                                    description: Environment variable name
                                    type: string
                                  value:
                                    description: Template value using connection properties
                                      (e.g., "{{ .url }}")
                                    type: string
                                required:
                                - name
                                - value
                                type: object
                              type: array
                          required:
                          - env
                          type: object
                        params:
                          additionalProperties:
                            type: string
                          description: Parameters for connection configuration (dynamic
                            key-value pairs)
                          type: object
                        type:
                          description: Type of connection - only "api" for now
                          enum:
                          - api
                          type: string
                      required:
                      - inject
                      - type
                      type: object
                    description: |-
                      Connections define how this workload consumes internal and external resources.
                      The key is the connection name, and the value is the connection specification.
                    type: object
                  container:
                    description: |-
                      Container defines the single container specification for this workload.
                      Mutually exclusive with containers.
                    properties:
                      args:
                        items:
                          type: string
                        type: array
                      command:
                        description: Container entrypoint & args.
                        items:
                          type: string
                        type: array
                      env:
                        description: Explicit environment variables.
                        items:
                          description: EnvVar represents an environment variable present
                            in the container.
                          properties:
                            key:
                              description: The environment variable key.
                              type: string
                            value:
                              description: |-
                                The literal value of the environment variable.
                                Mutually exclusive with valueFrom.
                              type: string
                            valueFrom:
                              description: |-
                                Extract the environment variable value from another resource.
                                Mutually exclusive with value.
                              properties:
                                configurationGroupRef:
                                  description: Reference to a configuration group.
                                  properties:
                                    key:
                                      type: string
                                    name:
                                      type: string
                                  required:
                                  - key
                                  - name
                                  type: object
                                secretRef:
                                  description: Reference to a secret resource.
                                  properties:
                                    key:
                                      type: string
                                    name:
                                      type: string
                                  required:
                                  - key
                                  - name
                                  type: object
                              type: object
                          required:
                          - key
                          type: object
                        type: array
                      files:
                        description: File configurations.
                        items:
                          description: FileVar represents a file configuration in
                            a container.
                          properties:
                            key:
                              description: The file key/name.
                              type: string
                            mountPath:
                              description: The mount path where the file will be mounted.
                              type: string
                            value:
                              description: |-
                                The literal content of the file.
                                Mutually exclusive with valueFrom.
                              type: string
                            valueFrom:
                              description: |-
                                Extract the environment variable value from another resource.
                                Mutually exclusive with value.
                              properties:
                                configurationGroupRef:
                                  description: Reference to a configuration group.
                                  properties:
                                    key:
                                      type: string
                                    name:
                                      type: string
                                  required:
                                  - key
                                  - name
                                  type: object
                                secretRef:
                                  description: Reference to a secret resource.
                                  properties:
                                    key:
                                      type: string
                                    name:
                                      type: string
                                  required:
                                  - key
                                  - name
                                  type: object
                              type: object
                          required:
                          - key
                          - mountPath
                          type: object
                          x-kubernetes-validations:
                          - message: exactly one of value or valueFrom must be set
                            rule: has(self.value) != has(self.valueFrom)
                        type: array
                      image:
                        description: OCI image to run (digest or tag).
                        minLength: 1
                        type: string
                    required:
                    - image
                    type: object
                  containers:
                    additionalProperties:
                      description: Container represents a single container in the
                        workload.
                      properties:
                        args:
                          items:
                            type: string
                          type: array
                        command:
                          description: Container entrypoint & args.
                          items:
                            type: string
                          type: array
                        env:
                          description: Explicit environment variables.
                          items:
                            description: EnvVar represents an environment variable
                              present in the container.
                            properties:
                              key:
                                description: The environment variable key.
                                type: string
                              value:
                                description: |-
                                  The literal value of the environment variable.
                                  Mutually exclusive with valueFrom.
                                type: string
                              valueFrom:
                                description: |-
                                  Extract the environment variable value from another resource.
                                  Mutually exclusive with value.
                                properties:
                                  configurationGroupRef:
                                    description: Reference to a configuration group.
                                    properties:
                                      key:
                                        type: string
                                      name:
                                        type: string
                                    required:
                                    - key
                                    - name
                                    type: object
                                  secretRef:
                                    description: Reference to a secret resource.
                                    properties:
                                      key:
                                        type: string
                                      name:
                                        type: string
                                    required:
                                    - key
                                    - name
                                    type: object
                                type: object
                            required:
                            - key
                            type: object
                          type: array
                        files:
                          description: File configurations.
                          items:
                            description: FileVar represents a file configuration in
                              a container.
                            properties:
                              key:
                                description: The file key/name.
                                type: string
                              mountPath:
                                description: The mount path where the file will be
                                  mounted.
                                type: string
                              value:
                                description: |-
                                  The literal content of the file.
                                  Mutually exclusive with valueFrom.
                                type: string
                              valueFrom:
                                description: |-
                                  Extract the environment variable value from another resource.
                                  Mutually exclusive with value.
                                properties:
                                  configurationGroupRef:
                                    description: Reference to a configuration group.
                                    properties:
                                      key:
                                        type: string
                                      name:
                                        type: string
                                    required:
                                    - key
                                    - name
                                    type: object
                                  secretRef:
                                    description: Reference to a secret resource.
                                    properties:
                                      key:
                                        type: string
                                      name:
                                        type: string
                                    required:
                                    - key
                                    - name
                                    type: object
                                type: object
                            required:
                            - key
                            - mountPath
                            type: object
                            x-kubernetes-validations:
                            - message: exactly one of value or valueFrom must be set
                              rule: has(self.value) != has(self.valueFrom)
                          type: array
                        image:
                          description: OCI image to run (digest or tag).
                          minLength: 1
                          type: string
                      required:
                      - image
                      type: object
                    description: |-
                      Containers define the container specifications for this workload.
                      The key is the container name, and the value is the container specification.
                      Mutually exclusive with container.
                    type: object
                  endpoints:
                    additionalProperties:
                      description: WorkloadEndpoint represents a simple network endpoint
                        for basic exposure.
                      properties:
                        port:
                          description: Port number for the endpoint.
                          format: int32
                          maximum: 65535
                          minimum: 1
                          type: integer
                        schema:
                          description: |-
                            Optional schema for the endpoint.
                            This can be used to define the actual API definition of the endpoint that is exposed by the workload.
                          properties:
                            content:
                              type: string
                            type:
                              type: string
                          type: object
                        type:
                          description: Type indicates the protocol/technology of the
                            endpoint (HTTP, REST, gRPC, GraphQL, Websocket, TCP, UDP).
                          enum:
                          - HTTP
                          - REST
                          - gRPC
                          - GraphQL
                          - Websocket
                          - TCP
                          - UDP
                          type: string
                        visibility:
                          default: project
                          description: Visibility defines the access scope for the
                            endpoint.
                          enum:
                          - project
                          - namespace
                          - internal
                          - external
                          type: string
                      required:
                      - port
                      - type
                      type: object
                    description: |-
                      Endpoints define simple network endpoints for basic port exposure.
                      The key is the endpoint name, and the value is the endpoint specification.
                    type: object
                type: object
                x-kubernetes-validations:
                - message: spec.workload is immutable
                  rule: self == oldSelf
                - message: exactly one of container or containers must be set
                  rule: has(self.container) != has(self.containers)
            required:
            - componentType
            - owner
            - workload
            type: object
          status:
            description: ComponentReleaseStatus defines the observed state of ComponentRelease.
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
